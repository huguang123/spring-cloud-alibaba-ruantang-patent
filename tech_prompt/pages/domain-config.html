<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>技术领域配置</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }
    #app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      flex: 1;
      width: 100%;
      max-width: 1440px;
      padding: 1rem;
    }
    .tree-node {
      transition: all 0.2s;
    }
    .tree-node:hover {
      background-color: #f3f4f6;
    }
    .tree-node.active {
      background-color: #eff6ff;
      border-color: #3b82f6;
    }
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #2F54EB;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .custom-scrollbar {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e0 #f7fafc;
    }
    
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f7fafc;
      border-radius: 4px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: #cbd5e0;
      border-radius: 4px;
      border: 2px solid #f7fafc;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background-color: #a0aec0;
    }
    
    /* 领域树列表高度控制 */
    .domain-tree-container {
      max-height: calc(100vh - 180px);
      overflow-y: auto;
    }
    
    /* 模板列表容器高度控制 */
    .template-container {
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
    
    @media (min-width: 1024px) {
      .lg\:w-1\/3 {
        width: 30%;
      }
      .lg\:w-2\/3 {
        width: 68%;
      }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="min-h-screen">
    <div class="container mx-auto p-4 max-w-7xl flex flex-col flex-grow">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">技术领域配置</h1>
        <div class="flex space-x-2">
          <button 
            @click="refreshDomains" 
            class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 flex items-center"
          >
            <i class="fas fa-sync-alt mr-2"></i>
            <span>刷新</span>
          </button>
          <button 
            @click="showDomainModal = true" 
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center"
          >
            <i class="fas fa-plus mr-2"></i>
            <span>新建领域</span>
          </button>
        </div>
      </div>
      
      <div class="flex flex-wrap gap-6 mb-6 flex-grow">
        <!-- 左侧技术领域树形结构 -->
        <div class="w-full lg:w-1/3 bg-white rounded-lg shadow-sm overflow-hidden">
          <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-medium text-gray-900">技术领域树</h2>
            <div class="flex items-center">
              <div class="relative">
                <input 
                  v-model="searchQuery" 
                  type="text" 
                  class="w-full px-3 py-2 pl-10 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="搜索领域名称..."
                  @keyup.enter="searchDomainWithParents(searchQuery)"
                >
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-search text-gray-400"></i>
                </div>
              </div>
              <button 
                @click="searchDomainWithParents(searchQuery)" 
                class="ml-2 p-2 text-gray-600 hover:text-gray-800 bg-gray-100 hover:bg-gray-200 rounded-md" 
                title="搜索"
              >
                <i class="fas fa-search"></i>
              </button>
              <button 
                @click="expandAllDomains"
                class="ml-1 p-2 text-gray-400 hover:text-gray-600" 
                title="展开全部"
              >
                <i class="fas fa-expand-alt"></i>
              </button>
              <button 
                @click="collapseAllDomains"
                class="ml-1 p-2 text-gray-400 hover:text-gray-600" 
                title="折叠全部"
              >
                <i class="fas fa-compress-alt"></i>
              </button>
            </div>
          </div>
          
          <div class="p-3 domain-tree-container custom-scrollbar">
            <div v-if="loading" class="flex justify-center items-center p-12">
              <div class="spinner mr-3"></div>
              <span class="text-gray-600">加载中...</span>
            </div>
            
            <div v-else-if="filteredDomains.length === 0" class="py-12 text-center">
              <div class="text-5xl text-gray-300 mb-4">
                <i class="fas fa-sitemap"></i>
              </div>
              <h3 class="text-lg font-medium text-gray-900">没有找到技术领域</h3>
              <p class="mt-1 text-sm text-gray-500">
                {{ searchQuery ? '没有符合搜索条件的技术领域' : '请点击"新建领域"按钮创建技术领域' }}
              </p>
            </div>
            
            <div v-else class="space-y-1">
              <div 
                v-for="domain in Array.isArray(filteredDomains) ? filteredDomains.filter(d => d && !d.parentId) : []" 
                :key="domain.id" 
                class="tree-node border border-gray-200 rounded-md overflow-hidden"
                :class="{'active': selectedDomain && selectedDomain.id === domain.id}"
              >
                <!-- 一级领域 -->
                <div 
                  @click="selectDomain(domain)" 
                  class="flex items-center p-2 cursor-pointer"
                >
                  <button 
                    v-if="hasChildren(domain.id)" 
                    @click.stop="toggleExpand(domain.id)" 
                    class="mr-2 w-5 h-5 flex items-center justify-center text-gray-500 hover:text-gray-700"
                  >
                    <i :class="isExpanded(domain.id) ? 'fas fa-chevron-down' : 'fas fa-chevron-right'"></i>
                  </button>
                  <span v-else class="mr-2 w-5"></span>
                  
                  <div class="flex-grow">
                    <div class="font-medium text-gray-900">{{ domain.domainName }}</div>
                  </div>
                  
                  <div class="flex items-center">
                    <button 
                      @click.stop="addChildDomain(domain)" 
                      class="p-1 text-gray-400 hover:text-gray-600"
                      title="添加子领域"
                    >
                      <i class="fas fa-plus"></i>
                    </button>
                    <button 
                      @click.stop="editDomain(domain, $event)" 
                      class="p-1 text-gray-400 hover:text-gray-600 ml-1"
                      title="编辑"
                    >
                      <i class="fas fa-edit"></i>
                    </button>
                    <button 
                      @click.stop="deleteDomain(domain)" 
                      class="p-1 text-gray-400 hover:text-gray-600 ml-1"
                      title="删除"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                
                <!-- 二级领域 -->
                <div v-if="isExpanded(domain.id)" class="pl-5 pb-1">
                  <div 
                    v-for="child in getDomainChildren(domain.id)" 
                    :key="child.id" 
                    class="mt-1 border-l-2 border-gray-200 pl-2"
                  >
                    <div 
                      @click="selectDomain(child)" 
                      class="flex items-center p-2 rounded-md cursor-pointer hover:bg-gray-50"
                      :class="{'bg-blue-50': selectedDomain && selectedDomain.id === child.id}"
                    >
                      <button 
                        v-if="hasChildren(child.id)" 
                        @click.stop="toggleExpand(child.id)" 
                        class="mr-2 w-5 h-5 flex items-center justify-center text-gray-500 hover:text-gray-700"
                      >
                        <i :class="isExpanded(child.id) ? 'fas fa-chevron-down' : 'fas fa-chevron-right'"></i>
                      </button>
                      <span v-else class="mr-2 w-5"></span>
                      
                      <div class="flex-grow">
                        <div class="font-medium text-gray-900">{{ child.domainName }}</div>
                      </div>
                      
                      <div class="flex items-center">
                        <button 
                          @click.stop="addChildDomain(child)" 
                          class="p-1 text-gray-400 hover:text-gray-600"
                          title="添加子领域"
                        >
                          <i class="fas fa-plus"></i>
                        </button>
                        <button 
                          @click.stop="editDomain(child, $event)" 
                          class="p-1 text-gray-400 hover:text-gray-600 ml-1"
                          title="编辑"
                        >
                          <i class="fas fa-edit"></i>
                        </button>
                        <button 
                          @click.stop="deleteDomain(child)" 
                          class="p-1 text-gray-400 hover:text-gray-600 ml-1"
                          title="删除"
                        >
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                    
                    <!-- 三级领域 -->
                    <div v-if="isExpanded(child.id)" class="pl-5 mt-1">
                      <div 
                        v-for="grandchild in getDomainChildren(child.id)" 
                        :key="grandchild.id" 
                        @click="selectDomain(grandchild)" 
                        class="flex items-center p-2 rounded-md cursor-pointer hover:bg-gray-50 border-l-2 border-gray-200 pl-2"
                        :class="{'bg-blue-50': selectedDomain && selectedDomain.id === grandchild.id}"
                      >
                        <div class="flex-grow">
                          <div class="font-medium text-gray-900">{{ grandchild.domainName }}</div>
                        </div>
                        
                        <div class="flex items-center">
                          <button 
                            @click.stop="editDomain(grandchild, $event)" 
                            class="p-1 text-gray-400 hover:text-gray-600"
                            title="编辑"
                          >
                            <i class="fas fa-edit"></i>
                          </button>
                          <button 
                            @click.stop="deleteDomain(grandchild)" 
                            class="p-1 text-gray-400 hover:text-gray-600 ml-1"
                            title="删除"
                          >
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 右侧详情信息 -->
        <div class="w-full lg:w-2/3">
          <div v-if="!selectedDomain" class="bg-white rounded-lg shadow-sm p-12 text-center">
            <div class="text-5xl text-gray-300 mb-4">
              <i class="fas fa-info-circle"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900">请选择技术领域</h3>
            <p class="mt-1 text-sm text-gray-500">
              从左侧技术领域树中选择一个领域，查看详细信息
            </p>
          </div>
          
          <div v-else>
            <div class="bg-white rounded-lg shadow-sm mb-6">
              <div class="p-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">领域详细信息</h2>
              </div>
              <div class="p-6">
                <div class="grid grid-cols-2 gap-6">
                  <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-2">基本信息</h3>
                    <div class="bg-gray-50 p-4 rounded border border-gray-200">
                      <div class="mb-3">
                        <label class="block text-xs text-gray-500">领域名称</label>
                        <div class="font-medium">{{ selectedDomain.domainName }}</div>
                      </div>
                      <div class="mb-3">
                        <label class="block text-xs text-gray-500">层级深度</label>
                        <div class="font-medium">{{ selectedDomain.level }} 级</div>
                      </div>
                      <div>
                        <label class="block text-xs text-gray-500">父级领域</label>
                        <div class="font-medium">
                          {{ selectedDomain.parentId ? (getDomainById(selectedDomain.parentId)?.domainName || '未知') : '无（顶级领域）' }}
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-2">领域描述</h3>
                    <div class="bg-gray-50 p-4 rounded border border-gray-200 h-full">
                      <p class="text-gray-600">{{ selectedDomain.description || '暂无描述' }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm">
              <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-medium text-gray-900">文档模板绑定</h2>
                <button 
                  @click="addDocTemplate" 
                  class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm flex items-center"
                >
                  <i class="fas fa-plus mr-1"></i>
                  <span>添加模板</span>
                </button>
              </div>
              <div class="p-6 template-container custom-scrollbar">
                <div v-if="!domainTemplates || domainTemplates.length === 0" class="text-center py-8">
                  <div class="text-4xl text-gray-300 mb-3">
                    <i class="fas fa-file-alt"></i>
                  </div>
                  <h3 class="text-md font-medium text-gray-700">暂无绑定模板</h3>
                  <p class="mt-1 text-sm text-gray-500 mb-4">
                    点击"添加模板"按钮为当前领域绑定文档模板
                  </p>
                </div>
                
                <div v-else class="space-y-4">
                  <div 
                    v-for="(template, index) in domainTemplates" 
                    :key="index" 
                    class="bg-gray-50 p-4 rounded-md border border-gray-200"
                  >
                    <div class="flex justify-between items-start mb-3">
                      <div>
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-md text-xs font-semibold mb-1 inline-block">
                          {{ template.template_type }}
                        </span>
                        <h4 class="font-medium text-gray-900">{{ template.template_name || '未命名模板' }}</h4>
                      </div>
                      <div class="flex space-x-2">
                        <button 
                          @click="editDocTemplate(template)" 
                          class="text-gray-500 hover:text-gray-700"
                          title="编辑模板"
                        >
                          <i class="fas fa-edit"></i>
                        </button>
                        <button 
                          @click="viewTemplateDetail(template)" 
                          class="text-blue-500 hover:text-blue-700"
                          title="查看模板"
                        >
                          <i class="fas fa-eye"></i>
                        </button>
                        <button 
                          @click="removeDomainTemplate(index)" 
                          class="text-red-500 hover:text-red-700"
                          title="解除绑定"
                        >
                          <i class="fas fa-unlink"></i>
                        </button>
                      </div>
                    </div>
                    
                    <div class="text-sm text-gray-600 mb-3">
                      <div class="flex items-center">
                        <i class="fas fa-tag text-gray-400 mr-2"></i>
                        <span>版本: {{ template.version || '1.0' }}</span>
                        <span class="mx-2">|</span>
                        <i class="fas fa-sitemap text-gray-400 mr-2"></i>
                        <span>绑定部分: {{ template.sections && Array.isArray(template.sections) ? template.sections.length : 0 }}个</span>
                      </div>
                    </div>
                    
                    <div
                      v-if="template.sections && Array.isArray(template.sections) && template.sections.length > 0"
                      class="bg-white p-3 border border-gray-200 rounded-md"
                    >
                      <div class="flex justify-between items-center mb-2">
                        <div class="text-xs font-medium text-gray-500">已绑定的章节：</div>
                        <button
                          @click="addNewChapter(template)"
                          class="px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-xs text-blue-700"
                        >
                          <i class="fas fa-plus-circle mr-1"></i> 添加章节
                        </button>
                      </div>
                      <div class="flex flex-wrap gap-2">
                        <div
                          v-for="section in sortedSections(template)"
                          :key="section.id"
                          class="group flex items-center px-2 py-1 bg-gray-100 text-gray-700 rounded-md text-xs"
                        >
                          <span>{{ section.section_type }}</span>
                          <div class="ml-2 flex space-x-1">
                            <button
                              @click.stop="viewChapterDetail(template, section)"
                              class="text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity"
                              title="查看详情"
                            >
                              <i class="fas fa-eye"></i>
                            </button>
                            <button 
                              @click.stop="editChapter(template, section)"
                              class="text-green-500 opacity-0 group-hover:opacity-100 transition-opacity"
                              title="编辑章节"
                            >
                              <i class="fas fa-edit"></i>
                            </button>
                            <button 
                              @click.stop="bindPromptTemplate(template, section)"
                              class="text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity"
                              title="绑定提示词模板"
                            >
                              <i class="fas fa-link"></i>
                            </button>
                            <button 
                              @click.stop="deleteChapter(template, section.id)"
                              class="text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                              title="删除章节"
                            >
                              <i class="fas fa-trash"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div v-else class="flex justify-center mt-2">
                      <button 
                        @click="addNewChapter(template)"
                        class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded text-sm text-gray-700 flex items-center"
                      >
                        <i class="fas fa-plus-circle mr-1.5"></i> 添加章节
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="flex justify-end mt-6">
                  <button 
                    @click="saveTemplateBindings" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                  >
                    保存模板绑定
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 领域编辑弹窗 -->
      <div v-if="showDomainModal" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75" @click="closeDomainModal"></div>
        <div class="relative bg-white rounded-lg max-w-md w-full mx-4 shadow-xl overflow-hidden">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">{{ editingDomain.id ? '编辑技术领域' : '创建技术领域' }}</h3>
            <button @click="closeDomainModal" class="text-gray-400 hover:text-gray-500">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="p-6">
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">领域名称 <span class="text-red-600">*</span></label>
              <input 
                v-model="editingDomain.domainName" 
                type="text" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="请输入领域名称"
              >
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">父级领域</label>
              <select 
                v-model="editingDomain.parentId" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option :value="null">无（顶级领域）</option>
                <option 
                  v-for="domain in domains.filter(d => d && d.id && d.id !== editingDomain.id && (!editingDomain.id || !isChildOf(d.id, editingDomain.id)))" 
                  :key="domain.id" 
                  :value="domain.id"
                >
                  {{ getIndent(domain.level) }}{{ domain.domainName }}
                </option>
              </select>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">领域描述</label>
              <textarea 
                v-model="editingDomain.description" 
                rows="3" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="请输入领域描述"
              ></textarea>
            </div>
          </div>
          <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end">
            <button 
              @click="closeDomainModal" 
              class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 mr-2"
            >
              取消
            </button>
            <button 
              @click="saveDomain" 
              class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700"
              :disabled="!editingDomain.domainName"
            >
              保存
            </button>
          </div>
        </div>
      </div>
      
      <!-- 模板详情弹窗 -->
      <div v-if="showTemplateModal" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75" @click="showTemplateModal = false"></div>
        <div class="relative bg-white rounded-lg max-w-3xl w-full mx-4 shadow-xl overflow-hidden">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">模板详情</h3>
            <button @click="showTemplateModal = false" class="text-gray-400 hover:text-gray-500">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="p-6" v-if="selectedTemplateDetail">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <div class="text-sm font-medium text-gray-500 mb-1">模板类型</div>
                <div>
                  <span class="badge px-2 py-1 bg-blue-100 text-blue-800 rounded-md text-sm">
                    {{ selectedTemplateDetail.template_type }}
                  </span>
                </div>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <div class="text-sm font-medium text-gray-500 mb-1">模板名称</div>
                  <div class="text-gray-900">{{ selectedTemplateDetail.template_name }}</div>
                </div>
                <div>
                  <div class="text-sm font-medium text-gray-500 mb-1">版本</div>
                  <div class="text-gray-900">{{ selectedTemplateDetail.version }}</div>
                </div>
              </div>
            </div>
            
            <div class="mb-6">
              <div class="text-sm font-medium text-gray-500 mb-1">包含章节</div>
              <div class="bg-gray-50 p-4 rounded-md border border-gray-200">
                <div v-if="!selectedTemplateDetail.sections || selectedTemplateDetail.sections.length === 0" class="text-gray-500 text-sm italic">
                  模板未配置任何章节
                </div>
                <div v-else class="space-y-2">
                  <div 
                    v-for="section in selectedTemplateDetail.sections" 
                    :key="section.id"
                    class="flex items-center p-2 bg-white border border-gray-200 rounded-md"
                  >
                    <div class="flex-grow">
                      <span class="text-sm font-medium">{{ section.section_type }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div>
              <div class="text-sm font-medium text-gray-500 mb-1">关联信息</div>
              <div class="bg-gray-50 p-3 rounded-md border border-gray-200">
                <div class="flex items-center text-sm">
                  <i class="fas fa-sitemap text-gray-400 mr-2"></i>
                  <span>当前关联领域: {{ selectedDomain ? selectedDomain.domainName : '无' }}</span>
                </div>
              </div>
            </div>
          </div>
          <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end">
            <button 
              @click="showTemplateModal = false" 
              class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              关闭
            </button>
          </div>
        </div>
      </div>

      <!-- 添加模板弹窗 -->
      <div v-if="showTemplateAddModal" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75" @click="showTemplateAddModal = false"></div>
        <div class="relative bg-white rounded-lg max-w-md w-full mx-4 shadow-xl overflow-hidden">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">{{ editingTemplateId ? '编辑文档模板' : '添加文档模板' }}</h3>
          </div>
          <div class="p-6">
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">模板类型 <span class="text-red-600">*</span></label>
              <select 
                v-model="editingTemplate.template_type" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">-- 请选择模板类型 --</option>
                <option 
                  v-for="type in templateTypes" 
                  :key="type.id" 
                  :value="type.typeName"
                >
                  {{ type.typeName }}
                </option>
              </select>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">模板名称 <span class="text-red-600">*</span></label>
              <input 
                v-model="editingTemplate.template_name" 
                type="text" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="请输入模板名称"
              >
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">版本</label>
              <input 
                v-model="editingTemplate.version" 
                type="text" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="请输入版本号，如1.0"
              >
            </div>
          </div>
          <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end">
            <button 
              @click="showTemplateAddModal = false" 
              class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 mr-2"
            >
              取消
            </button>
            <button 
              @click="saveDocTemplate" 
              class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700"
              :disabled="!isTemplateFormValid"
            >
              保存
            </button>
          </div>
        </div>
      </div>

      <!-- 章节编辑模态框 -->
      <div v-if="showChapterModal" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75" @click="showChapterModal = false"></div>
        <div class="relative bg-white rounded-lg max-w-md w-full mx-4 shadow-xl overflow-hidden">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">{{ isChapterEditing ? '编辑章节' : '添加章节' }}</h3>
          </div>
          <div class="p-6">
            <div v-if="selectedDocTemplate" class="bg-blue-50 p-3 rounded-md border border-blue-200 mb-4">
              <div class="text-sm font-medium text-blue-800">当前模板：{{ selectedDocTemplate.template_name }}</div>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">章节名称 <span class="text-red-600">*</span></label>
              <input 
                v-model="editingSection.section_type" 
                type="text" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="请输入章节名称"
              >
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">排序顺序</label>
              <input 
                v-model.number="editingSection.sort_order" 
                type="number" 
                min="1"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="请输入排序顺序（数字越小越靠前）"
              >
            </div>
          </div>
          <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end">
            <button 
              @click="showChapterModal = false" 
              class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 mr-2"
            >
              取消
            </button>
            <button 
              @click="saveChapter" 
              class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700"
              :disabled="!editingSection.section_type"
            >
              保存
            </button>
          </div>
        </div>
      </div>
      
      <!-- 章节详情模态框 -->
      <div v-if="showChapterDetailModal" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75" @click="showChapterDetailModal = false"></div>
        <div class="relative bg-white rounded-lg max-w-lg w-full mx-4 shadow-xl overflow-hidden">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">章节详情</h3>
          </div>
          <div class="p-6" v-if="chapterDetailData">
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <div class="text-sm font-medium text-gray-500 mb-1">章节名称</div>
                <div class="text-gray-900">{{ chapterDetailData.section_type }}</div>
              </div>
              <div>
                <div class="text-sm font-medium text-gray-500 mb-1">排序顺序</div>
                <div class="text-gray-900">{{ chapterDetailData.sort_order || '-' }}</div>
              </div>
            </div>
            
            <div class="mb-4">
              <div class="text-sm font-medium text-gray-500 mb-1">绑定状态</div>
              <div class="text-gray-900">
                <span v-if="chapterDetailData.prompt_id" class="px-2 py-1 bg-green-100 text-green-800 rounded-md text-xs">
                  已绑定提示词模板
                </span>
                <span v-else class="px-2 py-1 bg-gray-100 text-gray-800 rounded-md text-xs">
                  未绑定提示词模板
                </span>
              </div>
            </div>
            
            <div v-if="chapterDetailData.prompt_template" class="bg-gray-50 p-4 rounded-md border border-gray-200">
              <div class="text-sm font-medium text-gray-700 mb-2">绑定的提示词模板信息</div>
              <div class="grid grid-cols-2 gap-2 mb-2 text-sm">
                <div>
                  <div class="text-xs text-gray-500">模板名称</div>
                  <div>{{ chapterDetailData.prompt_template.template_name }}</div>
                </div>
                <div>
                  <div class="text-xs text-gray-500">版本</div>
                  <div>{{ chapterDetailData.prompt_template.version }}</div>
                </div>
              </div>
              <div class="text-xs text-gray-500 mb-1">模板内容</div>
              <div class="text-xs bg-white p-2 border border-gray-200 rounded max-h-32 overflow-y-auto">
                {{ chapterDetailData.prompt_template.content }}
              </div>
            </div>
          </div>
          <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end">
            <button 
              @click="showChapterDetailModal = false" 
              class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              关闭
            </button>
          </div>
        </div>
      </div>
      
      <!-- 提示词模板绑定模态框 -->
      <div v-if="showPromptBindModal" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75" @click="showPromptBindModal = false"></div>
        <div class="relative bg-white rounded-lg max-w-xl w-full mx-4 shadow-xl overflow-hidden max-h-[90vh] flex flex-col">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex-shrink-0">
            <h3 class="text-lg font-medium text-gray-900">绑定提示词模板</h3>
          </div>
          <div class="p-6 overflow-y-auto flex-grow">
            <div class="bg-blue-50 p-3 rounded-md border border-blue-200 mb-4">
              <div class="text-sm">
                <div class="font-medium text-blue-800">当前章节：{{ editingSection.section_type }}</div>
                <div class="text-blue-600 text-xs mt-1">文档模板：{{ selectedDocTemplate ? selectedDocTemplate.template_name : '' }}</div>
              </div>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">选择提示词模板</label>
              
              <!-- 已选择的固定模板 -->
              <div v-if="editingSection.prompt_id" class="mb-3 p-3 bg-blue-50 rounded-md border border-blue-200">
                <div class="flex justify-between items-start">
                  <div>
                    <div class="text-sm font-medium text-blue-800">
                      {{ getSelectedPromptTemplateName() }}
                    </div>
                    <div class="text-xs text-blue-600 mt-1">
                      <span class="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded-sm">{{ getSelectedPromptTemplateType() }}</span>
                      <span class="ml-2">版本 {{ getSelectedPromptTemplateVersion() }}</span>
                    </div>
                  </div>
                  <button 
                    @click="removeSelectedPromptTemplate" 
                    class="text-red-500 hover:text-red-700"
                    title="移除绑定"
                  >
                    <i class="fas fa-times-circle"></i>
                  </button>
                </div>
              </div>
              
              <div class="mb-3">
                <div class="relative">
                  <input 
                    v-model="promptTemplateSearchQuery" 
                    type="text" 
                    class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="搜索提示词模板名称..."
                    @input="searchPromptTemplates"
                    @keyup.enter="searchPromptTemplatesFromAPI"
                  >
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                  </div>
                </div>
              </div>
              
              <div v-if="loading" class="flex justify-center items-center py-4">
                <div class="spinner mr-3"></div>
                <span class="text-gray-600">加载中...</span>
              </div>
              <div v-else-if="filteredPromptTemplates.length === 0" class="py-4 text-center text-gray-500">
                没有可用的提示词模板
              </div>
              <div v-else class="border border-gray-300 rounded-md overflow-hidden max-h-80 overflow-y-auto">
                <div 
                  v-for="template in filteredPromptTemplates" 
                  :key="template.id" 
                  @click="editingSection.prompt_id = template.id"
                  class="p-3 border-b border-gray-200 last:border-b-0 hover:bg-gray-50 cursor-pointer"
                  :class="{'bg-blue-50': editingSection.prompt_id === template.id}"
                >
                  <div class="flex items-center">
                    <div 
                      class="w-5 h-5 flex items-center justify-center mr-3"
                    >
                      <div 
                        class="w-4 h-4 rounded-full border-2" 
                        :class="editingSection.prompt_id === template.id ? 'border-blue-500 bg-blue-500' : 'border-gray-300'"
                      ></div>
                    </div>
                    <div class="flex-grow">
                      <div class="font-medium text-sm">{{ template.template_name || '未命名模板' }}</div>
                      <div class="flex items-center text-xs text-gray-500 mt-1">
                        <span class="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded-sm">{{ template.section_type }}</span>
                        <span class="mx-1.5">·</span>
                        <span>版本 {{ template.version }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end flex-shrink-0">
            <button 
              @click="showPromptBindModal = false" 
              class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 mr-2"
            >
              取消
            </button>
            <button 
              @click="savePromptBinding" 
              class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700"
              :disabled="!editingSection.prompt_id"
            >
              保存绑定
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/vue@3.2.31/dist/vue.global.prod.js"></script>
  <script>
    const { createApp, ref, reactive, computed, onMounted } = Vue;
    
    createApp({
      setup() {
        // 状态变量
        const loading = ref(false);
        const domains = ref([]);
        const selectedDomain = ref(null);
        const showDomainModal = ref(false);
        const showCreateDomainModal = ref(false);
        const searchQuery = ref('');
        const expandedDomains = ref([]);
        
        // API通信相关变量
        const baseUrl = 'http://localhost:9000/prom/api/tech-domains';
        const docTemplateUrl = 'http://localhost:9000/prom/api/doc-templates';
        const docSectionTemplateUrl = 'http://localhost:9000/prom/api/doc-section-templates';
        const docTemplateTypeUrl = 'http://localhost:9000/prom/api/doc-template-types';
        const promptTemplateUrl = 'http://localhost:9000/prom/api/prom-templates';
        
        // 领域变量
        const domainTemplates = ref([]);
        const showTemplateModal = ref(false);
        const selectedTemplateDetail = ref(null);
        // 添加模板类型变量
        const templateTypes = ref([]);
        
        // 添加或编辑文档模板
        const showTemplateAddModal = ref(false);
        const editingTemplateId = ref(null);
        const editingTemplate = reactive({
          template_type: '',
          template_name: '',
          version: '1.0',
          sections: []
        });
        
        // 章节编辑相关状态
        const isChapterEditing = ref(false);
        const showChapterModal = ref(false);
        const showChapterDetailModal = ref(false);
        const showPromptBindModal = ref(false);
        const chapterDetailData = ref(null);
        
        // 章节编辑数据对象
        const chapterEditData = reactive({
          id: null,
          doc_template_id: null,
          section_type: '',
          prompt_id: null,
          sort_order: 10
        });
        
        // 保持向后兼容性
        const editingSection = chapterEditData;
        
        // 绑定章节和提示词
        const selectedDocTemplate = ref(null);
        const availablePromptTemplates = ref([]);
        const promptTemplateSearchQuery = ref('');
        
        // 预定义章节
        const predefinedSections = [
          '背景技术', '技术问题', '技术效果', '技术方案', '实施例', '附图说明'
        ];
        
        // 过滤后的提示词模板
        const filteredPromptTemplates = computed(() => {
          if (!availablePromptTemplates.value || !Array.isArray(availablePromptTemplates.value)) {
            return [];
          }
          
          if (!promptTemplateSearchQuery.value) {
            return availablePromptTemplates.value;
          }
          
          const query = promptTemplateSearchQuery.value.toLowerCase();
          return availablePromptTemplates.value.filter(template => 
            (template && template.template_name && template.template_name.toLowerCase().includes(query)) || 
            (template && template.section_type && template.section_type.toLowerCase().includes(query))
          );
        });
        
        // 编辑中的领域
        const editingDomain = reactive({
          id: null,
          domainName: '',
          parentId: null,
          level: 1,
          description: ''
        });
        
        // 过滤后的领域
        const filteredDomains = computed(() => {
          // 防御性检查，确保domains.value始终是数组
          if (!domains.value || !Array.isArray(domains.value)) {
            console.warn('domains不是数组，返回空数组');
            return [];
          }
          
          if (!searchQuery.value) return domains.value;
          
          const query = searchQuery.value.toLowerCase();
          return domains.value.filter(domain => 
            domain.domainName.toLowerCase().includes(query) || 
            (domain.description && domain.description.toLowerCase().includes(query))
          );
        });
        
        // 表单验证
        const isTemplateFormValid = computed(() => {
          return Boolean(editingTemplate.template_type && editingTemplate.template_name);
        });
        
        // 章节表单验证
        const isSectionFormValid = computed(() => {
          return Boolean(editingSection.section_type && editingSection.prompt_id);
        });
        
        // 检查章节是否已经绑定
        const isSectionAlreadyBound = computed(() => {
          if (!selectedDocTemplate.value || !editingSection.section_type) return false;
          
          return selectedDocTemplate.value.sections?.some(
            section => section.section_type === editingSection.section_type
          );
        });
        
        // 获取HTTP请求头
        function getRequestHeaders() {
          // 获取token
          const token = localStorage.getItem('auth_token') || (window.auth && window.auth.getToken());
          
          return {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
          };
        }
        
        // API错误处理
        function handleApiError(error, message = '操作失败') {
          console.error(`API错误: ${error.message || error}`);
          
          if (window.toast && typeof window.toast.error === 'function') {
            window.toast.error(message);
          } else {
            alert(`${message}: ${error.message || error}`);
          }
        }
        
        // 通用错误处理函数
        function showError(message) {
          console.error(message);
          alert(message);
        }
        
        // 通用成功提示函数
        function showSuccess(message) {
          console.log(message);
          alert(message);
        }
        
        // 获取领域的子节点
        function getChildren(parentId) {
          return domains.value.filter(domain => domain.parentId === parentId);
        }
        
        // 获取领域的子节点（返回对象供外部调用）
        function getDomainChildren(parentId) {
          return getChildren(parentId);
        }
        
        // 检查是否有子节点
        function hasChildren(parentId) {
          return domains.value.some(domain => domain.parentId === parentId);
        }
        
        // 根据ID获取领域
        function getDomainById(id) {
          if (!id || !Array.isArray(domains.value)) return null;
          return domains.value.find(d => d.id === id);
        }
        
        // 切换展开状态
        function toggleExpand(domainId) {
          const index = expandedDomains.value.indexOf(domainId);
          if (index === -1) {
            expandedDomains.value.push(domainId);
          } else {
            expandedDomains.value.splice(index, 1);
          }
        }
        
        // 判断是否展开
        function isExpanded(domainId) {
          return expandedDomains.value.includes(domainId);
        }
        
        // 选择领域
        function selectDomain(domain) {
          if (!domain) return;
          
          // 先清空当前选中的领域下的模板数据
          domainTemplates.value = [];
          
          selectedDomain.value = domain;
          
          // 如果是子领域，需要获取父级信息
          if (domain.parentId) {
            const parentDomain = getDomainById(domain.parentId);
            if (parentDomain) {
              selectedDomain.value = {
                ...domain,
                parentDomain: parentDomain
              };
            }
          }
          
          // 展开选中的领域 - 修改为push方法，因为expandedDomains现在是数组
          if (hasChildren(domain.id)) {
            if (!expandedDomains.value.includes(domain.id)) {
              expandedDomains.value.push(domain.id);
            }
          }
          
          // 加载该领域下的文档模板
          loadDomainTemplates(domain.id);
          
          console.log('已选择技术领域:', domain.domainName, '正在加载相关文档模板...');
        }
        
        // 加载领域详情
        async function loadDomainDetails(domainId) {
          try {
            loading.value = true;
            
            const response = await fetch(`${baseUrl}/${domainId}`, {
              method: 'GET',
              headers: getRequestHeaders()
            });
            
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.code === 200) {
              selectedDomain.value = result.data;
              
              // 加载领域关联的文档模板
              loadDomainTemplates(domainId);
            } else {
              throw new Error(result.message || '获取领域详情失败');
            }
          } catch (error) {
            handleApiError(error, '加载领域详情失败');
          } finally {
            loading.value = false;
          }
        }
        
        // 加载领域关联的文档模板
        async function loadDomainTemplates(domainId) {
          if (!domainId) return;
          
          try {
            loading.value = true;
            console.log('正在加载领域ID为', domainId, '的文档模板...');
            
            // 调用实际API获取领域关联的文档模板
            // 更新为API3文档中的1.6接口
            const response = await fetch(`${docTemplateUrl}/by-domain?domainId=${domainId}`, {
              method: 'GET',
              headers: getRequestHeaders()
            });
            
            console.log('文档模板API响应状态:', response.status);
            
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('获取到的文档模板数据:', result);
            
            if (result.code === 200) {
              // 格式化返回数据
              domainTemplates.value = result.data.map(template => ({
                id: template.id,
                template_type: template.templateTypeName,
                template_name: template.templateName,
                templateTypeId: template.templateTypeId,
                domainId: template.domainId,
                version: '1.0', // 默认版本号
                sections: template.sections?.map(section => ({
                  id: section.id,
                  section_type: section.sectionName,
                  prompt_id: section.promptId,
                  sort_order: section.sortOrder
                })) || []
              }));
              console.log('处理后的文档模板数据:', domainTemplates.value);
            } else {
              throw new Error(result.message || '获取领域模板失败');
            }
          } catch (error) {
            console.error('加载领域关联模板出错:', error);
            handleApiError(error, '加载领域关联模板失败');
            // 确保在出错时至少是空数组
            domainTemplates.value = [];
          } finally {
            loading.value = false;
          }
        }
        
        // 添加文档模板
        function addDocTemplate() {
          if (!selectedDomain.value) {
            showError('请先选择技术领域');
            return;
          }
          
          editingTemplateId.value = null;
          editingTemplate.template_type = '';
          editingTemplate.template_name = '';
          editingTemplate.version = '1.0';
          editingTemplate.sections = [];
          
          // 获取模板类型
          loadTemplateTypes();
          showTemplateAddModal.value = true;
        }
        
        // 获取模板类型列表
        async function loadTemplateTypes() {
          try {
            loading.value = true;
            console.log('开始加载模板类型数据...');
            
            const response = await fetch(docTemplateTypeUrl, {
              method: 'GET',
              headers: getRequestHeaders()
            });
            
            console.log('模板类型API响应状态:', response.status);
            
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('获取到的模板类型数据:', result);
            
            if (result.code === 200) {
              // 存储模板类型数据
              templateTypes.value = result.data || [];
              console.log('处理后的模板类型数据:', templateTypes.value);
            } else {
              throw new Error(result.message || '获取模板类型失败');
            }
          } catch (error) {
            console.error('加载模板类型数据出错:', error);
            handleApiError(error, '加载模板类型失败');
            // 确保在出错时至少是空数组
            templateTypes.value = [];
          } finally {
            loading.value = false;
          }
        }
        
        // 编辑文档模板
        function editDocTemplate(template) {
          editingTemplateId.value = template.id;
          editingTemplate.template_type = template.template_type;
          editingTemplate.template_name = template.template_name;
          editingTemplate.version = template.version || '1.0';
          editingTemplate.sections = [...(template.sections || [])];
          
          // 确保模板类型已加载
          if (!templateTypes.value || !templateTypes.value.length) {
            loadTemplateTypes();
          }
          
          showTemplateAddModal.value = true;
        }
        
        // 保存文档模板
        async function saveDocTemplate() {
          if (!isTemplateFormValid.value) {
            alert('请填写必填字段');
            return;
          }
          
          try {
            loading.value = true;
            
            // 防御性检查，确保templateTypes.value是数组
            if (!templateTypes.value || !Array.isArray(templateTypes.value)) {
              // 尝试加载模板类型数据
              await loadTemplateTypes();
              
              // 再次检查
              if (!templateTypes.value || !Array.isArray(templateTypes.value) || templateTypes.value.length === 0) {
                throw new Error('模板类型数据无效，请刷新页面重试');
              }
            }
            
            // 获取对应模板类型ID
            const templateType = templateTypes.value.find(t => t && t.typeName === editingTemplate.template_type);
            const templateTypeId = templateType ? templateType.id : null;
            
            if (!templateTypeId) {
              throw new Error('无效的模板类型');
            }
            
            const requestBody = {
              templateTypeId: templateTypeId,
              domainId: selectedDomain.value.id,
              orgId: 1, // 默认组织ID，可根据需要调整
              templateName: editingTemplate.template_name
            };
            
            let response;
            let result;
            
            if (editingTemplateId.value) {
              // 更新现有模板
              response = await fetch(`${docTemplateUrl}/${editingTemplateId.value}`, {
                method: 'PUT',
                headers: getRequestHeaders(),
                body: JSON.stringify(requestBody)
              });
            } else {
              // 创建新模板
              response = await fetch(docTemplateUrl, {
                method: 'POST',
                headers: getRequestHeaders(),
                body: JSON.stringify(requestBody)
              });
            }
            
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            
            result = await response.json();
            
            if (result.code === 200) {
              showSuccess(editingTemplateId.value ? '模板更新成功' : '模板创建成功');
              
              // 重新加载领域模板
              loadDomainTemplates(selectedDomain.value.id);
            } else {
              throw new Error(result.message || '保存模板失败');
            }
            
            showTemplateAddModal.value = false;
          } catch (error) {
            handleApiError(error, '保存文档模板失败');
          } finally {
            loading.value = false;
          }
        }
        
        // 显示绑定章节弹窗 - 已废弃，使用addNewChapter代替
        function showSectionBindModal(template) {
          // 直接调用新的添加章节功能
          addNewChapter(template);
        }
        
        // 加载可用的提示词模板
        function loadAvailablePromptTemplates() {
          loading.value = true;
          
          // TODO: API实现 - 在实际API开发后替换
          // 示例API调用:
          // try {
          //   const response = await fetch('/api/prompt-templates', {
          //     method: 'GET',
          //     headers: getRequestHeaders()
          //   });
          //   
          //   if (!response.ok) {
          //     throw new Error(`HTTP error: ${response.status}`);
          //   }
          //   
          //   const result = await response.json();
          //   
          //   if (result.code === 200) {
          //     availablePromptTemplates.value = result.data || [];
          //   } else {
          //     throw new Error(result.message || '获取提示词模板失败');
          //   }
          // } catch (error) {
          //   handleApiError(error, '加载提示词模板失败');
          // } finally {
          //   loading.value = false;
          // }
          
          // 使用模拟数据
          setTimeout(() => {
            availablePromptTemplates.value = [
              { id: 101, section_type: '技术问题', template_name: '标准技术问题生成器', content: '【请基于以下输入...】', version: '1.0' },
              { id: 102, section_type: '技术方案', template_name: '详细技术方案生成器', content: '【基于用户的技术描述...】', version: '1.0' },
              { id: 103, section_type: '技术效果', template_name: '多维技术效果分析器', content: '【请根据以下技术方案...】', version: '1.0' },
              { id: 104, section_type: '实施例', template_name: '实施例详细生成器', content: '【请根据以下技术创新点...】', version: '1.1' },
              { id: 105, section_type: '背景技术', template_name: '背景技术分析器', content: '【请根据以下技术领域...】', version: '1.0' },
              { id: 106, section_type: '技术问题', template_name: '机械领域问题定义', content: '【针对机械领域特定问题...】', version: '1.2' },
              { id: 107, section_type: '技术问题', template_name: '控制系统问题分析', content: '【分析控制系统存在的技术瓶颈...】', version: '1.1' },
              { id: 108, section_type: '技术方案', template_name: '软件实现方案', content: '【软件架构与实现方案...】', version: '2.0' },
              { id: 109, section_type: '技术效果', template_name: '效率提升分析', content: '【系统效率提升分析...】', version: '1.5' }
            ];
            loading.value = false;
          }, 500);
        }
        
        // 保存章节绑定
        function saveSectionBinding() {
          if (!isSectionFormValid.value) {
            showError('请填写完整信息');
            return;
          }
          
          // 查找和更新章节
          if (selectedDocTemplate.value && selectedDocTemplate.value.sections) {
            const existingIndex = selectedDocTemplate.value.sections.findIndex(
              s => s.section_type === editingSection.section_type
            );
            
            if (existingIndex >= 0) {
              // 更新已有章节
              selectedDocTemplate.value.sections[existingIndex].prompt_id = editingSection.prompt_id;
            } else {
              // 添加新章节
              selectedDocTemplate.value.sections.push({
                id: Date.now(),
                section_type: editingSection.section_type,
                prompt_id: editingSection.prompt_id,
                sort_order: selectedDocTemplate.value.sections.length + 1
              });
            }
            
            showSuccess('章节绑定保存成功');
          }
          
          showSectionModal.value = false;
        }
        
        // 添加新章节到模板
        function addNewChapter(template) {
          if (!template) {
            showError('模板数据无效');
            return;
          }
          
          // 准备添加章节的数据
          selectedDocTemplate.value = template;
          isChapterEditing.value = false;
          editingSection.id = null;
          editingSection.section_type = '';
          editingSection.prompt_id = null;
          editingSection.sort_order = (template.sections && Array.isArray(template.sections) && template.sections.length) ? template.sections.length + 1 : 1;
          
          // 显示章节编辑模态框
          showChapterModal.value = true;
        }
        
        // 查看章节详情
        async function viewChapterDetail(template, section) {
          selectedDocTemplate.value = template;
          
          try {
            loading.value = true;
            console.log('查看章节详情，章节ID:', section.id);
            
            const response = await fetch(`${docSectionTemplateUrl}/${section.id}`, {
              method: 'GET',
              headers: getRequestHeaders()
            });
            
            console.log('章节详情API响应状态:', response.status);
            
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('获取到的章节详情数据:', result.data);
            
            if (result.code === 200) {
              // 提前检查是否有提示词模板数据
              const hasPromptTemplate = result.data.promptTemplate && typeof result.data.promptTemplate === 'object';
              console.log('是否有提示词模板数据:', hasPromptTemplate);
              
              if (hasPromptTemplate) {
                console.log('提示词模板内容:', result.data.promptTemplate.content);
              }
              
              // 转换API返回的数据为章节详情格式
              chapterDetailData.value = {
                id: result.data.id,
                section_type: result.data.sectionName,
                sort_order: result.data.sortOrder,
                prompt_id: result.data.promptId,
                prompt_template: result.data.promptTemplate ? {
                  id: result.data.promptTemplate.id,
                  template_name: result.data.promptTemplate.promName || '未命名模板',
                  // 使用正确的字段名content而不是promptContent
                  content: result.data.promptTemplate.content || '无内容',
                  version: result.data.promptTemplate.version || '1.0'
                } : null
              };
              
              console.log('处理后的章节详情数据:', chapterDetailData.value);
              showChapterDetailModal.value = true;
            } else {
              throw new Error(result.message || '获取章节详情失败');
            }
          } catch (error) {
            console.error('加载章节详情出错:', error);
            handleApiError(error, '加载章节详情失败');
          } finally {
            loading.value = false;
          }
        }
        
        // 编辑章节
        function editChapter(template, section) {
          selectedDocTemplate.value = template;
          isChapterEditing.value = true;
          
          // 填充编辑表单
          editingSection.id = section.id;
          editingSection.doc_template_id = template.id;
          editingSection.section_type = section.section_type;
          editingSection.prompt_id = section.prompt_id;
          editingSection.sort_order = section.sort_order || 1;
          
          showChapterModal.value = true;
        }
        
        // 删除章节
        async function deleteChapter(template, sectionId) {
          if (confirm('确定要删除该章节吗？')) {
            try {
              loading.value = true;
              
              const response = await fetch(`${docSectionTemplateUrl}/${sectionId}`, {
                method: 'DELETE',
                headers: getRequestHeaders()
              });
              
              if (!response.ok) {
                throw new Error(`HTTP error: ${response.status}`);
              }
              
              const result = await response.json();
              
              if (result.code === 200) {
                // 从前端数据中移除章节
                if (template.sections && Array.isArray(template.sections)) {
                  const index = template.sections.findIndex(s => s.id === sectionId);
                  if (index !== -1) {
                    template.sections.splice(index, 1);
                  }
                }
                
                showSuccess('章节删除成功');
              } else {
                throw new Error(result.message || '章节删除失败');
              }
            } catch (error) {
              handleApiError(error, '删除章节失败');
            } finally {
              loading.value = false;
            }
          }
        }
        
        // 绑定提示词模板
        function bindPromptTemplate(template, section) {
          try {
            console.log('准备绑定提示词模板，先加载模板列表');
            
            // 先设置上下文数据
            selectedDocTemplate.value = template;
            
            // 填充表单数据
            editingSection.id = section.id;
            editingSection.doc_template_id = template.id;
            editingSection.section_type = section.section_type;
            editingSection.prompt_id = section.prompt_id;
            editingSection.sort_order = section.sort_order || 1;
            
            // 先显示模态框，避免等待API造成的延迟
            showPromptBindModal.value = true;
            
            // 然后加载可用的提示词模板
            loadPromptTemplates();
          } catch (error) {
            console.error('绑定提示词模板出错:', error);
            handleApiError(error, '准备绑定提示词模板失败');
          }
        }
        
        // 保存章节
        async function saveChapter() {
          if (!editingSection.section_type) {
            showError('请输入章节名称');
            return;
          }
          
          try {
            loading.value = true;
            
            const requestBody = {
              docTemplateId: selectedDocTemplate.value.id,
              promptId: editingSection.prompt_id,
              sectionName: editingSection.section_type,
              sortOrder: editingSection.sort_order || 1
            };
            
            let response;
            let result;
            
            if (isChapterEditing.value && editingSection.id) {
              // 更新章节
              response = await fetch(`${docSectionTemplateUrl}/${editingSection.id}`, {
                method: 'PUT',
                headers: getRequestHeaders(),
                body: JSON.stringify(requestBody)
              });
            } else {
              // 创建新章节
              response = await fetch(docSectionTemplateUrl, {
                method: 'POST',
                headers: getRequestHeaders(),
                body: JSON.stringify(requestBody)
              });
            }
            
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            
            result = await response.json();
            
            if (result.code === 200) {
              // 重新加载模板详情
              loadDomainTemplates(selectedDomain.value.id);
              
              showSuccess(isChapterEditing.value ? '章节更新成功' : '章节添加成功');
              showChapterModal.value = false;
            } else {
              throw new Error(result.message || '保存章节失败');
            }
          } catch (error) {
            handleApiError(error, '保存章节失败');
          } finally {
            loading.value = false;
          }
        }
        
        // 保存提示词模板绑定
        async function savePromptBinding() {
          // 移除禁用属性，允许在未选择模板的情况下点击
          // 但添加前端校验，确保有选择模板
          if (!editingSection.prompt_id) {
            showError('请先选择一个提示词模板');
            return;
          }
          
          try {
            loading.value = true;
            console.log('保存提示词绑定，章节ID:', editingSection.id, '提示词ID:', editingSection.prompt_id);
            
            // 调用更新章节API，添加提示词模板绑定
            const requestBody = {
              docTemplateId: selectedDocTemplate.value.id,
              promptId: editingSection.prompt_id,
              sectionName: editingSection.section_type,
              sortOrder: editingSection.sort_order || 1
            };
            
            console.log('保存提示词绑定请求数据:', requestBody);
            
            const response = await fetch(`${docSectionTemplateUrl}/${editingSection.id}`, {
              method: 'PUT',
              headers: getRequestHeaders(),
              body: JSON.stringify(requestBody)
            });
            
            console.log('保存提示词绑定API响应状态:', response.status);
            
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('保存提示词绑定返回数据:', result);
            
            if (result.code === 200) {
              // 更新前端数据
              if (selectedDocTemplate.value.sections && Array.isArray(selectedDocTemplate.value.sections)) {
                const index = selectedDocTemplate.value.sections.findIndex(s => s.id === editingSection.id);
                if (index !== -1) {
                  selectedDocTemplate.value.sections[index].prompt_id = editingSection.prompt_id;
                }
              }
              
              showSuccess('提示词模板绑定成功');
              
              // 重新加载模板数据
              loadDomainTemplates(selectedDomain.value.id);
              
              showPromptBindModal.value = false;
            } else {
              throw new Error(result.message || '保存绑定失败');
            }
          } catch (error) {
            console.error('保存提示词绑定出错:', error);
            handleApiError(error, '保存提示词模板绑定失败');
          } finally {
            loading.value = false;
          }
        }
        
        // 加载提示词模板列表
        async function loadPromptTemplates() {
          loading.value = true;
          
          try {
            // 不传搜索参数，获取所有提示词模板
            let url = `${promptTemplateUrl}`;
            
            console.log('加载提示词模板，API地址:', url);
            
            const response = await fetch(url, {
              method: 'GET',
              headers: getRequestHeaders()
            });
            
            console.log('提示词模板API响应状态:', response.status);
            
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('获取到的提示词模板数据:', result);
            
            if (result.code === 200 && result.data) {
              // 根据API返回的数据结构处理
              // 检查是否是分页数据结构(包含records字段)
              let dataArray = [];
              
              if (result.data.records && Array.isArray(result.data.records)) {
                console.log('检测到分页数据结构，从records中获取数组');
                dataArray = result.data.records;
              } else if (Array.isArray(result.data)) {
                console.log('检测到直接返回数组');
                dataArray = result.data;
              } else {
                console.warn('未能识别的数据结构:', result.data);
                availablePromptTemplates.value = [];
                filteredPromptTemplates.value = [];
                return;
              }
              
              console.log('处理的数据数组:', dataArray);
              
              // 转换API返回的数据为前端需要的格式
              availablePromptTemplates.value = dataArray.map(template => ({
                id: template.id,
                section_type: template.sectionType,
                template_name: template.promName || '未命名模板',
                content: template.content || '无内容',
                version: template.version || '1.0'
              }));
              
              // 立即设置过滤后的模板列表
              filteredPromptTemplates.value = [...availablePromptTemplates.value];
              console.log('处理后的提示词模板数据:', availablePromptTemplates.value);
            } else {
              // 如果返回代码不是200或data为null，设置为空数组
              console.warn('API返回异常:', result);
              availablePromptTemplates.value = [];
              filteredPromptTemplates.value = [];
            }
          } catch (error) {
            console.error('加载提示词模板出错:', error);
            handleApiError(error, '加载提示词模板失败');
            // 确保在出错时至少有一个空数组
            availablePromptTemplates.value = [];
            filteredPromptTemplates.value = [];
          } finally {
            loading.value = false;
          }
        }
        
        // 移除章节绑定
        function removeSectionBinding(template, sectionId) {
          if (!template || !template.sections || !Array.isArray(template.sections)) {
            return;
          }
          
          const index = template.sections.findIndex(s => s.id === sectionId);
          if (index !== -1) {
            template.sections.splice(index, 1);
          }
        }
        
        // 查看模板详情
        function viewTemplateDetail(template) {
          console.log('查看模板详情:', template);
          
          if (!template) {
            showError('无效的模板数据');
            return;
          }
          
          selectedTemplateDetail.value = { ...template };
          showTemplateModal.value = true;
        }
        
        // 删除/解除文档模板绑定
        async function removeDomainTemplate(index) {
          if (!confirm('确定要解除此文档模板的绑定吗？')) {
            return;
          }
          
          try {
            loading.value = true;
            
            if (!domainTemplates.value || !domainTemplates.value[index]) {
              throw new Error('无效的模板索引');
            }
            
            const templateId = domainTemplates.value[index].id;
            
            if (!templateId) {
              throw new Error('无效的模板ID');
            }
            
            const response = await fetch(`${docTemplateUrl}/${templateId}`, {
              method: 'DELETE',
              headers: getRequestHeaders()
            });
            
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.code === 200) {
              // 从前端列表中移除
              domainTemplates.value.splice(index, 1);
              showSuccess('文档模板解绑成功');
            } else {
              throw new Error(result.message || '解绑文档模板失败');
            }
          } catch (error) {
            console.error('解绑文档模板出错:', error);
            handleApiError(error, '解绑文档模板失败');
          } finally {
            loading.value = false;
          }
        }
        
        // 保存模板绑定
        async function saveTemplateBindings() {
          showSuccess('模板绑定保存成功');
        }
        
        // 添加子领域
        function addChildDomain(parentDomain) {
          editingDomain.id = null;
          editingDomain.domainName = '';
          editingDomain.parentId = parentDomain.id;
          editingDomain.level = parentDomain.level + 1;
          editingDomain.description = '';
          
          showDomainModal.value = true;
        }
        
        // 编辑领域
        function editDomain(domain, event) {
          // 阻止事件冒泡和默认行为
          if (event) {
            event.preventDefault();
            event.stopPropagation();
          }
          
          // 直接使用传入的domain对象填充编辑表单
          editingDomain.id = domain.id;
          editingDomain.domainName = domain.domainName;
          editingDomain.parentId = domain.parentId;
          editingDomain.level = domain.level;
          editingDomain.description = domain.description || '';
          
          // 显示模态框
          showDomainModal.value = true;
        }
        
        // 删除领域
        async function deleteDomain(domain) {
          if (hasChildren(domain.id)) {
            alert('无法删除含有子领域的领域，请先删除所有子领域');
            return;
          }
          
          if (confirm(`确定要删除领域"${domain.domainName}"吗？`)) {
            try {
              loading.value = true;
              
              const response = await fetch(`${baseUrl}/${domain.id}`, {
                method: 'DELETE',
                headers: getRequestHeaders()
              });
              
              if (!response.ok) {
                throw new Error(`HTTP error: ${response.status}`);
              }
              
              const result = await response.json();
              
              if (result.code === 200) {
                // 从本地列表中移除
                const index = domains.value.findIndex(d => d.id === domain.id);
                if (index !== -1) {
                  domains.value.splice(index, 1);
                }
                
                if (selectedDomain.value && selectedDomain.value.id === domain.id) {
                  selectedDomain.value = null;
                }
                
                showSuccess('技术领域删除成功');
              } else {
                throw new Error(result.message || '删除失败');
              }
            } catch (error) {
              handleApiError(error, '删除技术领域失败');
            } finally {
              loading.value = false;
            }
          }
        }
        
        // 判断是否是子节点
        function isChildOf(potentialChildId, parentId) {
          if (!potentialChildId || !parentId) return false;
          
          const domain = getDomainById(potentialChildId);
          if (!domain) return false;
          
          if (domain.parentId === parentId) return true;
          if (domain.parentId === null) return false;
          
          return isChildOf(domain.parentId, parentId);
        }
        
        // 获取缩进 - 修复getIndent函数
        const getIndent = (level) => {
          if (!level || typeof level !== 'number') return '';
          return '  '.repeat(Math.max(0, level - 1));
        };
        
        // 在select标签中使用getIndent
        const getIndentedName = (domain) => {
          if (!domain || !domain.level) return domain?.domainName || '';
          return getIndent(domain.level) + domain.domainName;
        };
        
        // 关闭领域弹窗
        function closeDomainModal() {
          showDomainModal.value = false;
        }
        
        // 保存领域
        async function saveDomain() {
          if (!editingDomain.domainName) {
            alert('请输入领域名称');
            return;
          }
          
          try {
            loading.value = true;
            
            // 更新level（在服务器端处理，这里预设）
            if (editingDomain.parentId) {
              const parentDomain = getDomainById(editingDomain.parentId);
              editingDomain.level = parentDomain ? parentDomain.level + 1 : 1;
            } else {
              editingDomain.level = 1;
            }
            
            const requestBody = {
              domainName: editingDomain.domainName,
              parentId: editingDomain.parentId,
              description: editingDomain.description || ''
            };
            
            let response;
            let result;
            
            if (editingDomain.id) {
              // 更新现有领域
              response = await fetch(`${baseUrl}/${editingDomain.id}`, {
                method: 'PUT',
                headers: getRequestHeaders(),
                body: JSON.stringify(requestBody)
              });
            } else {
              // 创建新领域
              response = await fetch(baseUrl, {
                method: 'POST',
                headers: getRequestHeaders(),
                body: JSON.stringify(requestBody)
              });
            }
            
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            
            result = await response.json();
            
            if (result.code === 200) {
              // 如果是创建新领域，服务器会返回新ID
              if (!editingDomain.id && result.data) {
                requestBody.id = result.data;
                domains.value.push({...requestBody});
                
                // 如果是新建子领域，自动展开父级
                if (requestBody.parentId && !isExpanded(requestBody.parentId)) {
                  toggleExpand(requestBody.parentId);
                }
              } else if (editingDomain.id) {
                // 更新现有领域
                const index = domains.value.findIndex(d => d.id === editingDomain.id);
                if (index !== -1) {
                  const updatedDomain = {...domains.value[index], ...requestBody};
                  domains.value[index] = updatedDomain;
                  
                  // 如果更新的是当前选中的领域，更新选中的领域
                  if (selectedDomain.value && selectedDomain.value.id === editingDomain.id) {
                    selectedDomain.value = updatedDomain;
                  }
                }
              }
              
              showSuccess(editingDomain.id ? '技术领域更新成功' : '技术领域创建成功');
            } else {
              throw new Error(result.message || (editingDomain.id ? '更新失败' : '创建失败'));
            }
            
            showDomainModal.value = false;
          } catch (error) {
            handleApiError(error, editingDomain.id ? '更新技术领域失败' : '创建技术领域失败');
          } finally {
            loading.value = false;
          }
        }
        
        // 搜索技术领域及其父级
        async function searchDomainWithParents(domainName) {
          if (!domainName || domainName.trim() === '') {
            // 如果搜索为空，刷新全部数据
            refreshDomains();
            return;
          }
          
          try {
            loading.value = true;
            const searchUrl = `${baseUrl}/search-with-parents?domainName=${encodeURIComponent(domainName)}`;
            
            const response = await fetch(searchUrl, {
              method: 'GET',
              headers: getRequestHeaders()
            });
            
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.code === 200 && result.data && result.data.length > 0) {
              // 处理搜索结果包括父级技术领域
              const foundDomains = [];
              
              // 构建父级链
              result.data.forEach(domain => {
                // 先添加当前域
                foundDomains.push({
                  id: domain.id,
                  domainName: domain.domainName,
                  parentId: domain.parentId,
                  parentName: domain.parentName,
                  level: domain.level,
                  description: domain.description
                });
                
                // 添加父级域
                let parent = domain.parent;
                while (parent) {
                  // 检查是否已存在以避免重复
                  if (!foundDomains.some(d => d.id === parent.id)) {
                    foundDomains.push({
                      id: parent.id,
                      domainName: parent.domainName,
                      parentId: parent.parentId,
                      parentName: parent.parentName,
                      level: parent.level,
                      description: parent.description
                    });
                  }
                  parent = parent.parent;
                }
              });
              
              // 更新搜索结果到域列表
              domains.value = foundDomains;
              
              // 展开所有父级域
              foundDomains.forEach(domain => {
                if (domain.parentId && !expandedDomains.value.includes(domain.parentId)) {
                  expandedDomains.value.push(domain.parentId);
                }
              });
              
              // 选择第一个匹配的域
              if (foundDomains.length > 0) {
                selectDomain(foundDomains[0]);
              }
            } else {
              alert('未找到匹配的技术领域，请尝试其他关键词');
            }
          } catch (error) {
            handleApiError(error, '搜索技术领域失败');
          } finally {
            loading.value = false;
          }
        }
        
        // 刷新领域数据 - 获取技术领域树
        async function refreshDomains() {
          try {
            loading.value = true;
            
            // 确保domains是数组
            if (!Array.isArray(domains.value)) {
              domains.value = [];
            }
            
            const response = await fetch(`${baseUrl}/tree`, {
              method: 'GET',
              headers: getRequestHeaders()
            });
            
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.code === 200) {
              // 将数据平铺为一维数组
              const rawDomains = flattenDomainTree(result.data);
              // 过滤无效数据
              domains.value = rawDomains.filter(d => d && d.id);
              
              console.log('处理后的domains数据:', domains.value);
              
              // 默认展开一级领域
              expandedDomains.value = domains.value
                .filter(d => d.level === 1)
                .map(d => d.id);
            } else {
              // API返回错误，使用空数组
              domains.value = [];
              throw new Error(result.message || '获取技术领域树失败');
            }
          } catch (error) {
            // 确保在出错时domains至少是空数组
            if (!Array.isArray(domains.value)) {
              domains.value = [];
            }
            handleApiError(error, '刷新技术领域数据失败');
            // 如果需要，这里可以使用模拟数据
            // mockDomainData();
          } finally {
            loading.value = false;
          }
        }
        
        // 将树形结构平铺为一维数组
        function flattenDomainTree(tree) {
          const result = [];
          
          function traverse(node) {
            if (!node) return;
            
            result.push({
              id: node.id,
              domainName: node.domainName,
              parentId: node.parentId,
              parentName: node.parentName,
              level: node.level,
              description: node.description
            });
            
            if (node.children && node.children.length > 0) {
              node.children.forEach(traverse);
            }
          }
          
          tree.forEach(traverse);
          return result;
        }
        
        // 章节管理方法 - 已废弃，使用新的章节管理函数
        /*
        function addNewSection() {
          isAddingSection.value = true;
          isSearchingSection.value = false;
          newSectionName.value = '';
        }
        
        function confirmAddSection() {
          if (!newSectionName.value.trim()) {
            alert('章节名称不能为空');
            return;
          }
          
          if (sectionOptions.value.includes(newSectionName.value.trim())) {
            alert('章节名称已存在');
            return;
          }
          
          customSections.value.push(newSectionName.value.trim());
          isAddingSection.value = false;
          newSectionName.value = '';
        }
        
        function cancelAddSection() {
          isAddingSection.value = false;
          newSectionName.value = '';
        }
        
        function searchSection() {
          isSearchingSection.value = true;
          isAddingSection.value = false;
          sectionSearchQuery.value = '';
        }
        
        function cancelSearchSection() {
          isSearchingSection.value = false;
          sectionSearchQuery.value = '';
        }
        
        function selectSection(section) {
          editingSection.section_type = section;
        }
        
        function editSection(section, index) {
          // 只允许编辑自定义章节
          if (predefinedSections.includes(section)) return;
          
          const actualIndex = customSections.value.indexOf(section);
          if (actualIndex === -1) return;
          
          editingSectionIndex.value = actualIndex;
          editingSectionName.value = section;
        }
        
        function confirmEditSection() {
          if (!editingSectionName.value.trim()) {
            alert('章节名称不能为空');
            return;
          }
          
          if (sectionOptions.value.includes(editingSectionName.value.trim()) && 
              editingSectionName.value.trim() !== customSections.value[editingSectionIndex.value]) {
            alert('章节名称已存在');
            return;
          }
          
          // 如果正在编辑的章节是当前选中的章节，也更新选中章节
          if (editingSection.section_type === customSections.value[editingSectionIndex.value]) {
            editingSection.section_type = editingSectionName.value.trim();
          }
          
          customSections.value[editingSectionIndex.value] = editingSectionName.value.trim();
          cancelEditSection();
        }
        
        function cancelEditSection() {
          editingSectionIndex.value = null;
          editingSectionName.value = '';
        }
        
        function deleteSection(section, index) {
          // 只允许删除自定义章节
          if (predefinedSections.includes(section)) return;
          
          const actualIndex = customSections.value.indexOf(section);
          if (actualIndex === -1) return;
          
          // 如果要删除的章节是当前选中的章节，清空选中
          if (editingSection.section_type === section) {
            editingSection.section_type = '';
          }
          
          customSections.value.splice(actualIndex, 1);
        }
        */
        
        // 当搜索查询变化时，执行搜索
        function handleSearchQueryChange() {
          // 非空查询且长度大于1
          if (searchQuery.value && searchQuery.value.length > 1) {
            searchDomainWithParents(searchQuery.value);
          }
        }
        
        // 展开所有领域
        function expandAllDomains() {
          // 将所有领域ID添加到已展开列表中
          expandedDomains.value = domains.value.map(d => d.id);
        }
        
        // 折叠所有领域
        function collapseAllDomains() {
          // 清空展开列表
          expandedDomains.value = [];
        }
        
        // 添加新领域
        function addDomain() {
          // 重置编辑表单
          editingDomain.id = null;
          editingDomain.domainName = '';
          editingDomain.parentId = null;
          editingDomain.level = 1;
          editingDomain.description = '';
          
          // 显示领域编辑弹窗
          showDomainModal.value = true;
        }
        
        // 初始化
        onMounted(() => {
          // 初始化domains为空数组以避免undefined错误
          domains.value = [];
          
          // 初始化templateTypes为空数组以避免undefined错误
          templateTypes.value = [];
          
          // 初始化过滤后的提示词模板
          filteredPromptTemplates.value = [];
          availablePromptTemplates.value = [];
          
          // 确保挂载后自动加载领域数据
          refreshDomains();
          
          // 预加载模板类型数据
          console.log('组件挂载，预加载模板类型数据');
          loadTemplateTypes().then(() => {
            console.log('模板类型数据加载完成, 数量:', templateTypes.value.length);
          }).catch(err => {
            console.error('预加载模板类型数据失败:', err);
          });
          
          // 不再预加载提示词模板数据，而是在需要时加载
          
          // 在加载完数据后，初始化默认展开一级领域
          setTimeout(() => {
            if (domains.value && Array.isArray(domains.value) && domains.value.length > 0) {
              expandedDomains.value = domains.value
                .filter(d => d && d.level === 1)
                .map(d => d.id);
            }
          }, 600);
        });
        
        // 添加模拟数据函数用于测试
        function mockDomainData() {
          console.log('使用模拟数据...');
          // 确保所有数据对象都有有效的id、domainName和level属性
          const mockData = [
            { id: 1, domainName: "机械技术领域", parentId: null, level: 1, description: "包含机械工程相关技术" },
            { id: 2, domainName: "控制系统", parentId: null, level: 1, description: "包含自动控制系统相关技术" },
            { id: 3, domainName: "传感器技术", parentId: null, level: 1, description: "包含各类传感器相关技术" },
            { id: 4, domainName: "机械设计", parentId: 1, level: 2, description: "机械结构与零部件设计" },
            { id: 5, domainName: "工业机器人", parentId: 1, level: 2, description: "工业自动化机器人技术" },
            { id: 6, domainName: "PLC控制", parentId: 2, level: 2, description: "可编程逻辑控制器技术" },
            { id: 7, domainName: "温度传感器", parentId: 3, level: 2, description: "各类温度测量传感器技术" }
          ];
          
          // 确保模拟数据合法有效
          domains.value = mockData.filter(d => d && d.id && d.domainName);
          console.log('模拟数据已加载:', domains.value);
        }
        
        // 章节排序函数
        function sortedSections(template) {
          if (!template || !template.sections || !Array.isArray(template.sections)) {
            return [];
          }
          return [...template.sections].sort((a, b) => {
            // 首先按排序号排序
            if (a.sort_order !== b.sort_order) {
              return a.sort_order - b.sort_order;
            }
            // 如果排序号相同，按ID排序
            return a.id - b.id;
          });
        }
        
        // 显示领域的模板
        function showDomainTemplates(domain) {
          selectedDomain.value = domain;
          // 加载领域相关的模板
          loadDomainTemplates(domain.id);
        }
        
        // 添加模板
        function addTemplate() {
          // 与addDocTemplate功能相同
          addDocTemplate();
        }
        
        // 编辑模板
        function editTemplate(template) {
          // 与editDocTemplate功能相同
          editDocTemplate(template);
        }
        
        // 删除模板
        function deleteTemplate(templateId) {
          const index = domainTemplates.value.findIndex(t => t.id === templateId);
          if (index !== -1 && confirm('确定要删除此模板吗？')) {
            domainTemplates.value.splice(index, 1);
            showSuccess('模板删除成功');
          }
        }
        
        // 保存模板
        function saveTemplate() {
          // 与saveDocTemplate功能相同
          saveDocTemplate();
        }
        
        // 移除已选择的固定模板
        function removeSelectedPromptTemplate() {
          editingSection.prompt_id = null;
        }
        
        // 获取已选择的固定模板名称
        function getSelectedPromptTemplateName() {
          if (!editingSection.prompt_id || !availablePromptTemplates.value) return '未命名模板';
          
          const selectedTemplate = availablePromptTemplates.value.find(t => t.id === editingSection.prompt_id);
          return selectedTemplate ? selectedTemplate.template_name : '智能设备技术问题模板';
        }
        
        // 获取已选择的固定模板类型
        function getSelectedPromptTemplateType() {
          if (!editingSection.prompt_id || !availablePromptTemplates.value) return editingSection.section_type || '技术问题';
          
          const selectedTemplate = availablePromptTemplates.value.find(t => t.id === editingSection.prompt_id);
          return selectedTemplate ? selectedTemplate.section_type : '技术问题';
        }
        
        // 获取已选择的固定模板版本
        function getSelectedPromptTemplateVersion() {
          if (!editingSection.prompt_id || !availablePromptTemplates.value) return '1.0';
          
          const selectedTemplate = availablePromptTemplates.value.find(t => t.id === editingSection.prompt_id);
          return selectedTemplate ? selectedTemplate.version : '1.0';
        }
        
        // 处理提示词模板搜索
        function searchPromptTemplates() {
          console.log('搜索提示词模板:', promptTemplateSearchQuery.value);
          if (!availablePromptTemplates.value || !Array.isArray(availablePromptTemplates.value)) {
            return;
          }
          
          // 使用本地搜索，避免每次输入都发送请求
          // 实际应用中可以考虑使用防抖或节流
          if (!promptTemplateSearchQuery.value) {
            filteredPromptTemplates.value = availablePromptTemplates.value;
          } else {
            const query = promptTemplateSearchQuery.value.toLowerCase();
            filteredPromptTemplates.value = availablePromptTemplates.value.filter(template => {
              return (
                (template.template_name && template.template_name.toLowerCase().includes(query)) ||
                (template.section_type && template.section_type.toLowerCase().includes(query))
              );
            });
          }
        }
        
        // 按回车搜索提示词模板
        async function searchPromptTemplatesFromAPI() {
          if (!promptTemplateSearchQuery.value) {
            // 如果搜索框为空，加载所有模板
            loadPromptTemplates();
            return;
          }
          
          console.log('从API搜索提示词模板:', promptTemplateSearchQuery.value);
          loading.value = true;
          
          try {
            // 使用搜索参数
            let url = `${promptTemplateUrl}/by-name?name=${encodeURIComponent(promptTemplateSearchQuery.value)}`;
            
            console.log('搜索提示词模板API地址:', url);
            
            const response = await fetch(url, {
              method: 'GET',
              headers: getRequestHeaders()
            });
            
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('搜索结果:', result);
            
            if (result.code === 200 && result.data) {
              // 根据API返回的数据结构处理
              // 检查是否是分页数据结构(包含records字段)
              let dataArray = [];
              
              if (result.data.records && Array.isArray(result.data.records)) {
                console.log('检测到分页数据结构，从records中获取数组');
                dataArray = result.data.records;
              } else if (Array.isArray(result.data)) {
                console.log('检测到直接返回数组');
                dataArray = result.data;
              } else {
                console.warn('未能识别的数据结构:', result.data);
                filteredPromptTemplates.value = [];
                return;
              }
              
              console.log('处理的数据数组:', dataArray);
              
              // 转换API返回的数据并直接设置到过滤后的模板列表
              filteredPromptTemplates.value = dataArray.map(template => ({
                id: template.id,
                section_type: template.sectionType,
                template_name: template.promName || '未命名模板',
                content: template.content || '无内容',
                version: template.version || '1.0'
              }));
              
              console.log('搜索结果处理后的提示词模板数据:', filteredPromptTemplates.value);
            } else {
              filteredPromptTemplates.value = [];
            }
          } catch (error) {
            console.error('搜索提示词模板出错:', error);
            handleApiError(error, '搜索提示词模板失败');
            filteredPromptTemplates.value = [];
          } finally {
            loading.value = false;
          }
        }
        
        return {
          // 状态变量
          domains,
          loading,
          selectedDomain,
          showDomainModal,
          showCreateDomainModal,
          searchQuery,
          editingDomain,
          filteredDomains,
          domainTemplates,
          showTemplateModal,
          selectedTemplateDetail,
          expandedDomains,
          showTemplateAddModal,
          editingTemplateId,
          editingTemplate,
          isTemplateFormValid,
          selectedDocTemplate,
          editingSection,
          availablePromptTemplates,
          promptTemplateSearchQuery,
          filteredPromptTemplates,
          isChapterEditing,
          showChapterModal,
          showChapterDetailModal,
          showPromptBindModal,
          chapterEditData,
          chapterDetailData,
          templateTypes,

          // 方法
          refreshDomains,
          selectDomain,
          addDomain,
          addChildDomain,
          editDomain,
          saveDomain,
          deleteDomain,
          showDomainTemplates,
          addTemplate,
          addDocTemplate,
          editTemplate,
          editDocTemplate,
          deleteTemplate,
          saveTemplate,
          saveDocTemplate,
          toggleExpand,
          isExpanded,
          hasChildren,
          getDomainChildren,
          getDomainById,
          addNewChapter,
          viewChapterDetail,
          editChapter,
          deleteChapter,
          bindPromptTemplate,
          saveChapter,
          savePromptBinding,
          loadPromptTemplates,
          viewTemplateDetail,
          removeDomainTemplate,
          searchPromptTemplates,
          searchPromptTemplatesFromAPI, // 添加回车搜索方法
          
          // 通用功能方法
          handleSearchQueryChange,
          expandAllDomains,
          collapseAllDomains,
          mockDomainData,
          searchDomainWithParents,
          sortedSections,
          isChildOf,

          // 移除已选择的固定模板
          removeSelectedPromptTemplate,
          // 获取已选择的固定模板名称
          getSelectedPromptTemplateName,
          // 获取已选择的固定模板类型
          getSelectedPromptTemplateType,
          // 获取已选择的固定模板版本
          getSelectedPromptTemplateVersion,
          getIndent,
          getIndentedName
        };
      }
    }).mount('#app');
  </script>
</body>
</html> 
</html> 