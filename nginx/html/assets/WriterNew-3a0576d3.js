import{L as e,K as a,V as l,b as t,ap as o,w as n,G as s,at as r,E as d,ad as i}from"./elementPlus-e3fc6f82.js";import{h as c}from"./errorHandler-e80e1e70.js";import{x as u,r as m,X as v,c as f,k as p,z as h,A as y,P as g,H as w,u as b,G as _,K as x,ag as k,y as N,O as T,a4 as V,L as I,M as $,J as E}from"./vue-4e979bb7.js";import{_ as j}from"./index-4bf8c7f1.js";const A={class:"container mx-auto px-4 py-6 max-w-7xl"},C={class:"grid grid-cols-1 gap-4 mb-4"},P={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},U={class:"mb-4"},H={class:"flex justify-end items-center space-x-4"},O={class:"flex items-center"},S={class:"py-10"},z={class:"flex justify-between"},L={class:"flex space-x-2"},R={class:"space-y-6"},D={class:"flex justify-between items-center"},W={class:"font-medium"},G={class:"flex space-x-2"},J=["innerHTML"],M={key:1,class:"p-4"},q={class:"py-10"},K="/prom/api",B=j(u({__name:"WriterNew",setup(u){const j=m(""),B=v({level1:"",level2:"",level3:""}),X=m(""),F=m(!1),Q=m(!1),Y=m([]),Z=m([]),ee=m([]),ae=m([]),le=m(!0),te=m([]),oe=v({}),ne=v({});function se(){var e,a;const l=localStorage.getItem("auth_token")||(null==(a=null==(e=window.auth)?void 0:e.getToken)?void 0:a.call(e));return l?{"Content-Type":"application/json",Authorization:`Bearer ${l}`}:(console.warn("未找到认证token"),{"Content-Type":"application/json"})}const re=f((()=>te.value&&te.value.length>0));function de(){const e=document.querySelector(".mb-8");e&&e.scrollIntoView({behavior:"smooth"})}function ie(){B.level2="",B.level3="",Z.value=[],ee.value=[],ae.value=[],B.level1&&(!async function(){if(!B.level1)return;try{const e=await fetch(`${K}/tech-domains/children?parentId=${B.level1}`,{headers:se()});if(!e.ok)throw new Error(`HTTP error: ${e.status}`);const a=await e.json();if(console.log("二级技术领域数据:",a),200!==a.code||!a.data)throw new Error(a.message||"加载二级领域失败");Array.isArray(a.data)?Z.value=a.data.map((e=>({id:e.id,domain_name:e.domainName||e.domain_name,parent_id:e.parentId||e.parent_id,level:e.level}))):a.data.records&&Array.isArray(a.data.records)?Z.value=a.data.records.map((e=>({id:e.id,domain_name:e.domainName||e.domain_name,parent_id:e.parentId||e.parent_id,level:e.level}))):(console.error("意外的二级领域数据格式:",a.data),Z.value=[]),console.log("处理后的二级领域数据:",Z.value)}catch(e){c(e,"加载二级领域失败"),Z.value=[]}}(),me())}function ce(){B.level3="",ee.value=[],ae.value=[],B.level2&&(!async function(){if(!B.level2)return;try{const e=await fetch(`${K}/tech-domains/children?parentId=${B.level2}`,{headers:se()});if(!e.ok)throw new Error(`HTTP error: ${e.status}`);const a=await e.json();if(console.log("三级技术领域数据:",a),200!==a.code||!a.data)throw new Error(a.message||"加载三级领域失败");Array.isArray(a.data)?ee.value=a.data.map((e=>({id:e.id,domain_name:e.domainName||e.domain_name,parent_id:e.parentId||e.parent_id,level:e.level}))):a.data.records&&Array.isArray(a.data.records)?ee.value=a.data.records.map((e=>({id:e.id,domain_name:e.domainName||e.domain_name,parent_id:e.parentId||e.parent_id,level:e.level}))):(console.error("意外的三级领域数据格式:",a.data),ee.value=[]),console.log("处理后的三级领域数据:",ee.value)}catch(e){c(e,"加载三级领域失败"),ee.value=[]}}(),me())}function ue(){ae.value=[],B.level3&&me()}async function me(){const e=B.level3||B.level2||B.level1;if(!e)return ae.value=[],void(X.value="");try{const a=await fetch(`${K}/doc-templates/by-domain?domainId=${e}`,{headers:se()});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);const l=await a.json();if(console.log("文档模板数据:",l),200!==l.code||!l.data)throw new Error(l.message||"加载文档模板失败");ae.value=l.data.map((e=>({id:e.id,template_name:e.templateName}))),console.log("处理后的模板数据:",ae.value)}catch(a){c(a,"加载文档模板失败"),ae.value=[]}}async function ve(){console.log("generateContent 函数被调用");const e=B.level3||B.level2||B.level1;if(e)if(X.value)if(j.value.trim()){F.value=!0,te.value=[];try{const a={techDomainId:e,docTemplateId:X.value,techDescription:j.value.trim(),useAiGenerate:le.value};console.log("开始生成文档，参数：",a);const l=await fetch(`${K}/doc-generate`,{method:"POST",headers:se(),body:JSON.stringify(a)});if(!l.ok)throw new Error(`HTTP error: ${l.status}`);const t=await l.json();if(console.log("生成文档响应：",t),200!==t.code)throw new Error(t.message||"生成文档失败");te.value=t.data.sections,te.value.forEach((e=>{oe[e.sectionName]=!1,ne[e.sectionName]=e.content})),setTimeout((()=>{const e=document.querySelector(".bg-white.p-6.rounded-lg.shadow-md");e&&e.scrollIntoView({behavior:"smooth"})}),100)}catch(a){console.error("生成文档错误：",a),c(a,"生成文档失败"),te.value=[]}finally{F.value=!1}}else d.warning("请输入技术描述");else d.warning("请选择文档模板");else d.warning("请选择技术领域")}async function fe(){if(te.value&&0!==te.value.length){Q.value=!0;try{const e={title:"技术交底书",sections:te.value.map(((e,a)=>({sectionName:e.sectionName,content:e.content,sortOrder:a+1})))},a=await fetch(`${K}/doc-generate/export-word`,{method:"POST",headers:se(),body:JSON.stringify(e)});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);const l=a.headers.get("Content-Disposition");let t="技术交底书.docx";if(l){const e=l.match(/filename="(.+)"/);e&&(t=e[1])}const o=await a.blob(),n=URL.createObjectURL(o),s=document.createElement("a");s.href=n,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n),d.success("导出Word文档成功")}catch(e){console.error("导出Word文档失败：",e),c(e,"导出Word文档失败")}finally{Q.value=!1}}else d.warning("没有可导出的内容")}return p((()=>{!async function(){try{const e=await fetch(`${K}/tech-domains/children`,{headers:se()});if(!e.ok)throw new Error(`HTTP error: ${e.status}`);const a=await e.json();if(console.log("技术领域数据:",a),200!==a.code||!a.data)throw new Error(a.message||"加载技术领域失败");Array.isArray(a.data)?Y.value=a.data.map((e=>({id:e.id,domain_name:e.domainName||e.domain_name,parent_id:e.parentId||e.parent_id,level:e.level}))):a.data.records&&Array.isArray(a.data.records)?Y.value=a.data.records.map((e=>({id:e.id,domain_name:e.domainName||e.domain_name,parent_id:e.parentId||e.parent_id,level:e.level}))):(console.error("意外的数据格式:",a.data),Y.value=[]),console.log("处理后的领域数据:",Y.value)}catch(e){c(e,"加载技术领域失败"),Y.value=[]}}()})),(u,m)=>{const v=i,f=k("Loading"),p=k("RefreshRight"),me=k("EditPen");return N(),h("div",A,[m[20]||(m[20]=y("h1",{class:"text-2xl font-bold text-gray-800 mb-6"},"技术交底书智能撰写",-1)),g(b(s),{class:"mb-8"},{header:w((()=>m[6]||(m[6]=[y("h2",{class:"text-lg font-semibold"},"技术描述输入",-1)]))),default:w((()=>[y("div",C,[y("div",P,[y("div",null,[m[7]||(m[7]=y("label",{class:"block text-gray-700 mb-2"},"一级技术领域",-1)),g(b(e),{modelValue:B.level1,"onUpdate:modelValue":m[0]||(m[0]=e=>B.level1=e),class:"w-full",placeholder:"-- 请选择一级领域 --",onChange:ie},{default:w((()=>[(N(!0),h(T,null,V(Y.value,(e=>(N(),_(b(a),{key:e.id,label:e.domain_name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])]),y("div",null,[m[8]||(m[8]=y("label",{class:"block text-gray-700 mb-2"},"二级技术领域",-1)),g(b(e),{modelValue:B.level2,"onUpdate:modelValue":m[1]||(m[1]=e=>B.level2=e),class:"w-full",placeholder:"-- 请选择二级领域 --",disabled:!B.level1,onChange:ce},{default:w((()=>[(N(!0),h(T,null,V(Z.value,(e=>(N(),_(b(a),{key:e.id,label:e.domain_name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])]),y("div",null,[m[9]||(m[9]=y("label",{class:"block text-gray-700 mb-2"},"三级技术领域",-1)),g(b(e),{modelValue:B.level3,"onUpdate:modelValue":m[2]||(m[2]=e=>B.level3=e),class:"w-full",placeholder:"-- 请选择三级领域 --",disabled:!B.level2,onChange:ue},{default:w((()=>[(N(!0),h(T,null,V(ee.value,(e=>(N(),_(b(a),{key:e.id,label:e.domain_name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])]),y("div",null,[m[10]||(m[10]=y("label",{class:"block text-gray-700 mb-2"},"文档模板",-1)),g(b(e),{modelValue:X.value,"onUpdate:modelValue":m[3]||(m[3]=e=>X.value=e),class:"w-full",placeholder:"-- 请选择文档模板 --",disabled:!B.level3&&!B.level2&&!B.level1},{default:w((()=>[(N(!0),h(T,null,V(ae.value,(e=>(N(),_(b(a),{key:e.id,label:e.template_name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])]),y("div",U,[m[11]||(m[11]=y("label",{class:"block text-gray-700 mb-2"},"技术概述",-1)),g(b(l),{modelValue:j.value,"onUpdate:modelValue":m[4]||(m[4]=e=>j.value=e),type:"textarea",rows:6,placeholder:"请输入您的技术描述...",resize:"vertical"},null,8,["modelValue"])]),y("div",H,[y("div",O,[g(v,{modelValue:le.value,"onUpdate:modelValue":m[5]||(m[5]=e=>le.value=e)},{default:w((()=>m[12]||(m[12]=[I("使用AI辅助生成")]))),_:1},8,["modelValue"])]),g(b(t),{type:"primary",onClick:ve,loading:F.value},{default:w((()=>[F.value?x("",!0):(N(),_(b(n),{key:0},{default:w((()=>[g(b(o))])),_:1})),y("span",null,$(F.value?"生成中...":"生成文档"),1)])),_:1},8,["loading"])])])),_:1}),F.value?(N(),_(b(s),{key:0,class:"text-center"},{default:w((()=>[y("div",S,[g(b(n),{class:"is-loading mb-4",size:30},{default:w((()=>[g(f)])),_:1}),m[13]||(m[13]=y("p",{class:"text-gray-700"},"正在生成技术交底书，请稍候...",-1))])])),_:1})):x("",!0),re.value&&!F.value?(N(),_(b(s),{key:1},{header:w((()=>[y("div",z,[m[15]||(m[15]=y("h2",{class:"text-lg font-semibold"},"技术交底书预览",-1)),y("div",L,[g(b(t),{size:"small",onClick:fe,loading:Q.value},{default:w((()=>[g(b(n),null,{default:w((()=>[g(b(r))])),_:1}),m[14]||(m[14]=I(" 导出Word "))])),_:1},8,["loading"])])])])),default:w((()=>[y("div",R,[(N(!0),h(T,null,V(te.value,(e=>(N(),_(b(s),{key:e.sectionName,class:"mb-4",shadow:"hover"},{header:w((()=>[y("div",D,[y("h3",W,$(e.sectionName),1),y("div",G,[g(b(t),{text:"",onClick:a=>function(e){if(oe[e]){const a=te.value.find((a=>a.sectionName===e));a&&(a.content=ne[e]),oe[e]=!1}else{const a=te.value.find((a=>a.sectionName===e));a&&(ne[e]=a.content),oe[e]=!0}}(e.sectionName),type:oe[e.sectionName]?"success":"primary",size:"small"},{default:w((()=>[g(b(n),null,{default:w((()=>[(N(),_(E(oe[e.sectionName]?"Check":"EditPen")))])),_:2},1024),y("span",null,$(oe[e.sectionName]?"保存":"编辑"),1)])),_:2},1032,["onClick","type"]),g(b(t),{text:"",type:"primary",onClick:a=>async function(e){if(oe[e])return;const a=B.level3||B.level2||B.level1;if(a&&X.value){F.value=!0;try{const l={techDomainId:a,docTemplateId:X.value,techDescription:j.value.trim(),useAiGenerate:le.value,regenerateSection:e},t=await fetch(`${K}/doc-generate`,{method:"POST",headers:se(),body:JSON.stringify(l)});if(!t.ok)throw new Error(`HTTP error: ${t.status}`);const o=await t.json();if(console.log("重新生成部分响应：",o),200!==o.code)throw new Error(o.message||"重新生成失败");{const a=te.value.findIndex((a=>a.sectionName===e));if(-1!==a){const l=o.data.sections.find((a=>a.sectionName===e));l&&(te.value[a]=l)}d.success(`${e}重新生成成功`)}}catch(l){console.error("重新生成部分错误：",l),c(l,"重新生成失败")}finally{F.value=!1}}else d.warning("缺少必要的参数")}(e.sectionName),disabled:oe[e.sectionName],size:"small"},{default:w((()=>[g(b(n),null,{default:w((()=>[g(p)])),_:1}),m[16]||(m[16]=I(" 重新生成 "))])),_:2},1032,["onClick","disabled"])])])])),default:w((()=>{return[oe[e.sectionName]?(N(),h("div",M,[g(b(l),{modelValue:ne[e.sectionName],"onUpdate:modelValue":a=>ne[e.sectionName]=a,type:"textarea",rows:6,resize:"vertical"},null,8,["modelValue","onUpdate:modelValue"])])):(N(),h("div",{key:0,class:"p-4 text-gray-700",innerHTML:(a=e.content,a?a.replace(/\n/g,"<br>"):"")},null,8,J))];var a})),_:2},1024)))),128))])])),_:1})):x("",!0),re.value||F.value?x("",!0):(N(),_(b(s),{key:2,class:"text-center"},{default:w((()=>[y("div",q,[g(b(n),{class:"text-primary mb-4",size:40},{default:w((()=>[g(b(o))])),_:1}),m[18]||(m[18]=y("h2",{class:"text-xl font-semibold mb-2"},"开始创建您的技术交底书",-1)),m[19]||(m[19]=y("p",{class:"text-gray-600 mb-6"},"选择技术领域并输入技术描述，系统将自动为您生成专业的技术交底书",-1)),g(b(t),{type:"primary",onClick:de},{default:w((()=>[g(b(n),null,{default:w((()=>[g(me)])),_:1}),m[17]||(m[17]=I(" 开始撰写 "))])),_:1})])])),_:1}))])}}}),[["__scopeId","data-v-0e3409b9"]]);export{B as default};
