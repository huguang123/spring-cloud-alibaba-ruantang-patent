import{L as e,K as a,V as l,b as t,ap as o,w as n,G as s,at as r,E as d,ad as i}from"./elementPlus-e3fc6f82.js";import{h as c}from"./errorHandler-e80e1e70.js";import{x as u,r as m,X as v,c as f,k as p,z as h,A as y,P as g,H as w,u as _,G as b,K as x,ag as k,y as N,O as V,a4 as T,L as I,M as A,J as $}from"./vue-4e979bb7.js";import{_ as E}from"./index-08374d78.js";const j={class:"container mx-auto px-4 py-6 max-w-7xl"},C={class:"grid grid-cols-1 gap-4 mb-4"},P={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},H={class:"mb-4"},z={class:"flex justify-end items-center space-x-4"},S={class:"flex items-center"},U={class:"py-10"},L={class:"flex justify-between"},O={class:"flex space-x-2"},D={class:"space-y-6"},G={class:"flex justify-between items-center"},J={class:"font-medium"},M={class:"flex space-x-2"},q=["innerHTML"],K={key:1,class:"p-4"},R={class:"py-10"},W="/prom/api",B=E(u({__name:"WriterNew",setup(u){const E=m(""),B=v({level1:null,level2:null,level3:null}),X=m(""),F=m(!1),Q=m([]),Y=m([]),Z=m([]),ee=m([]),ae=m(!0),le=m([]),te=v({}),oe=v({});function ne(){var e,a;const l=localStorage.getItem("auth_token")||(null==(a=null==(e=window.auth)?void 0:e.getToken)?void 0:a.call(e));return l?{"Content-Type":"application/json",Authorization:`Bearer ${l}`}:(console.warn("未找到认证token"),{"Content-Type":"application/json"})}const se=f((()=>le.value&&le.value.length>0));function re(){const e=document.querySelector(".mb-8");e&&e.scrollIntoView({behavior:"smooth"})}function de(){B.level2=null,B.level3=null,Y.value=[],Z.value=[],ee.value=[],B.level1&&(!async function(){if(!B.level1)return;try{const e=await fetch(`${W}/tech-domains/children?parentId=${B.level1.id}`,{headers:ne()});if(!e.ok)throw new Error(`HTTP error: ${e.status}`);const a=await e.json();if(console.log("二级技术领域数据:",a),200!==a.code||!a.data)throw new Error(a.message||"加载二级领域失败");Array.isArray(a.data)?Y.value=a.data.map((e=>({id:e.id,domain_name:e.domainName||e.domain_name,parent_id:e.parentId||e.parent_id,level:e.level}))):a.data.records&&Array.isArray(a.data.records)?Y.value=a.data.records.map((e=>({id:e.id,domain_name:e.domainName||e.domain_name,parent_id:e.parentId||e.parent_id,level:e.level}))):(console.error("意外的二级领域数据格式:",a.data),Y.value=[]),console.log("处理后的二级领域数据:",Y.value)}catch(e){c(e,"加载二级领域失败"),Y.value=[]}}(),ue())}function ie(){B.level3=null,Z.value=[],ee.value=[],B.level2&&(!async function(){if(!B.level2)return;try{const e=await fetch(`${W}/tech-domains/children?parentId=${B.level2.id}`,{headers:ne()});if(!e.ok)throw new Error(`HTTP error: ${e.status}`);const a=await e.json();if(console.log("三级技术领域数据:",a),200!==a.code||!a.data)throw new Error(a.message||"加载三级领域失败");Array.isArray(a.data)?Z.value=a.data.map((e=>({id:e.id,domain_name:e.domainName||e.domain_name,parent_id:e.parentId||e.parent_id,level:e.level}))):a.data.records&&Array.isArray(a.data.records)?Z.value=a.data.records.map((e=>({id:e.id,domain_name:e.domainName||e.domain_name,parent_id:e.parentId||e.parent_id,level:e.level}))):(console.error("意外的三级领域数据格式:",a.data),Z.value=[]),console.log("处理后的三级领域数据:",Z.value)}catch(e){c(e,"加载三级领域失败"),Z.value=[]}}(),ue())}function ce(){ee.value=[],B.level3&&ue()}async function ue(){const e=B.level3||B.level2||B.level1;if(!e)return ee.value=[],void(X.value="");try{const a=await fetch(`${W}/doc-templates/by-domain?domainId=${e.id}`,{headers:ne()});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);const l=await a.json();if(console.log("文档模板数据:",l),200!==l.code||!l.data)throw new Error(l.message||"加载文档模板失败");ee.value=l.data.map((e=>({id:e.id,template_name:e.templateName}))),console.log("处理后的模板数据:",ee.value)}catch(a){c(a,"加载文档模板失败"),ee.value=[]}}async function me(){console.log("generateContent 函数被调用");const e=B.level3||B.level2||B.level1;if(e)if(X.value)if(E.value.trim()){F.value=!0,le.value=[];try{const a={techDomainId:e.id,docTemplateId:X.value,techDescription:E.value.trim(),useAiGenerate:ae.value};console.log("开始生成文档，参数：",a);const l=await fetch(`${W}/doc-generate`,{method:"POST",headers:ne(),body:JSON.stringify(a)});if(!l.ok)throw new Error(`HTTP error: ${l.status}`);const t=await l.json();if(console.log("生成文档响应：",t),200!==t.code)throw new Error(t.message||"生成文档失败");le.value=t.data.sections,le.value.forEach((e=>{te[e.sectionName]=!1,oe[e.sectionName]=e.content})),setTimeout((()=>{const e=document.querySelector(".bg-white.p-6.rounded-lg.shadow-md");e&&e.scrollIntoView({behavior:"smooth"})}),100)}catch(a){console.error("生成文档错误：",a),c(a,"生成文档失败"),le.value=[]}finally{F.value=!1}}else d.warning("请输入技术描述");else d.warning("请选择文档模板");else d.warning("请选择技术领域")}return p((()=>{!async function(){try{const e=await fetch(`${W}/tech-domains/children`,{headers:ne()});if(!e.ok)throw new Error(`HTTP error: ${e.status}`);const a=await e.json();if(console.log("技术领域数据:",a),200!==a.code||!a.data)throw new Error(a.message||"加载技术领域失败");Array.isArray(a.data)?Q.value=a.data.map((e=>({id:e.id,domain_name:e.domainName||e.domain_name,parent_id:e.parentId||e.parent_id,level:e.level}))):a.data.records&&Array.isArray(a.data.records)?Q.value=a.data.records.map((e=>({id:e.id,domain_name:e.domainName||e.domain_name,parent_id:e.parentId||e.parent_id,level:e.level}))):(console.error("意外的数据格式:",a.data),Q.value=[]),console.log("处理后的领域数据:",Q.value)}catch(e){c(e,"加载技术领域失败"),Q.value=[]}}()})),(u,m)=>{const v=i,f=k("Loading"),p=k("RefreshRight"),ue=k("EditPen");return N(),h("div",j,[m[20]||(m[20]=y("h1",{class:"text-2xl font-bold text-gray-800 mb-6"},"技术交底书智能撰写",-1)),g(_(s),{class:"mb-8"},{header:w((()=>m[6]||(m[6]=[y("h2",{class:"text-lg font-semibold"},"技术描述输入",-1)]))),default:w((()=>[y("div",C,[y("div",P,[y("div",null,[m[7]||(m[7]=y("label",{class:"block text-gray-700 mb-2"},"一级技术领域",-1)),g(_(e),{modelValue:B.level1,"onUpdate:modelValue":m[0]||(m[0]=e=>B.level1=e),class:"w-full",placeholder:"-- 请选择一级领域 --",onChange:de},{default:w((()=>[(N(!0),h(V,null,T(Q.value,(e=>(N(),b(_(a),{key:e.id,label:e.domain_name,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])]),y("div",null,[m[8]||(m[8]=y("label",{class:"block text-gray-700 mb-2"},"二级技术领域",-1)),g(_(e),{modelValue:B.level2,"onUpdate:modelValue":m[1]||(m[1]=e=>B.level2=e),class:"w-full",placeholder:"-- 请选择二级领域 --",disabled:!B.level1,onChange:ie},{default:w((()=>[(N(!0),h(V,null,T(Y.value,(e=>(N(),b(_(a),{key:e.id,label:e.domain_name,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])]),y("div",null,[m[9]||(m[9]=y("label",{class:"block text-gray-700 mb-2"},"三级技术领域",-1)),g(_(e),{modelValue:B.level3,"onUpdate:modelValue":m[2]||(m[2]=e=>B.level3=e),class:"w-full",placeholder:"-- 请选择三级领域 --",disabled:!B.level2,onChange:ce},{default:w((()=>[(N(!0),h(V,null,T(Z.value,(e=>(N(),b(_(a),{key:e.id,label:e.domain_name,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])]),y("div",null,[m[10]||(m[10]=y("label",{class:"block text-gray-700 mb-2"},"文档模板",-1)),g(_(e),{modelValue:X.value,"onUpdate:modelValue":m[3]||(m[3]=e=>X.value=e),class:"w-full",placeholder:"-- 请选择文档模板 --",disabled:!B.level3&&!B.level2&&!B.level1},{default:w((()=>[(N(!0),h(V,null,T(ee.value,(e=>(N(),b(_(a),{key:e.id,label:e.template_name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])]),y("div",H,[m[11]||(m[11]=y("label",{class:"block text-gray-700 mb-2"},"技术概述",-1)),g(_(l),{modelValue:E.value,"onUpdate:modelValue":m[4]||(m[4]=e=>E.value=e),type:"textarea",rows:6,placeholder:"请输入您的技术描述...",resize:"vertical"},null,8,["modelValue"])]),y("div",z,[y("div",S,[g(v,{modelValue:ae.value,"onUpdate:modelValue":m[5]||(m[5]=e=>ae.value=e)},{default:w((()=>m[12]||(m[12]=[I("使用AI辅助生成")]))),_:1},8,["modelValue"])]),g(_(t),{type:"primary",onClick:me,loading:F.value},{default:w((()=>[F.value?x("",!0):(N(),b(_(n),{key:0},{default:w((()=>[g(_(o))])),_:1})),y("span",null,A(F.value?"生成中...":"生成文档"),1)])),_:1},8,["loading"])])])),_:1}),F.value?(N(),b(_(s),{key:0,class:"text-center"},{default:w((()=>[y("div",U,[g(_(n),{class:"is-loading mb-4",size:30},{default:w((()=>[g(f)])),_:1}),m[13]||(m[13]=y("p",{class:"text-gray-700"},"正在生成技术交底书，请稍候...",-1))])])),_:1})):x("",!0),se.value&&!F.value?(N(),b(_(s),{key:1},{header:w((()=>[y("div",L,[m[15]||(m[15]=y("h2",{class:"text-lg font-semibold"},"技术交底书预览",-1)),y("div",O,[g(_(t),{size:"small"},{default:w((()=>[g(_(n),null,{default:w((()=>[g(_(r))])),_:1}),m[14]||(m[14]=I(" 导出Word "))])),_:1})])])])),default:w((()=>[y("div",D,[(N(!0),h(V,null,T(le.value,(e=>(N(),b(_(s),{key:e.sectionName,class:"mb-4",shadow:"hover"},{header:w((()=>[y("div",G,[y("h3",J,A(e.sectionName),1),y("div",M,[g(_(t),{text:"",onClick:a=>function(e){if(te[e]){const a=le.value.find((a=>a.sectionName===e));a&&(a.content=oe[e]),te[e]=!1}else{const a=le.value.find((a=>a.sectionName===e));a&&(oe[e]=a.content),te[e]=!0}}(e.sectionName),type:te[e.sectionName]?"success":"primary",size:"small"},{default:w((()=>[g(_(n),null,{default:w((()=>[(N(),b($(te[e.sectionName]?"Check":"EditPen")))])),_:2},1024),y("span",null,A(te[e.sectionName]?"保存":"编辑"),1)])),_:2},1032,["onClick","type"]),g(_(t),{text:"",type:"primary",onClick:a=>async function(e){if(te[e])return;const a=B.level3||B.level2||B.level1;if(a&&X.value){F.value=!0;try{const l={techDomainId:a.id,docTemplateId:X.value,techDescription:E.value.trim(),useAiGenerate:ae.value,regenerateSection:e},t=await fetch(`${W}/doc-generate`,{method:"POST",headers:ne(),body:JSON.stringify(l)});if(!t.ok)throw new Error(`HTTP error: ${t.status}`);const o=await t.json();if(console.log("重新生成部分响应：",o),200!==o.code)throw new Error(o.message||"重新生成失败");{const a=le.value.findIndex((a=>a.sectionName===e));if(-1!==a){const l=o.data.sections.find((a=>a.sectionName===e));l&&(le.value[a]=l)}d.success(`${e}重新生成成功`)}}catch(l){console.error("重新生成部分错误：",l),c(l,"重新生成失败")}finally{F.value=!1}}else d.warning("缺少必要的参数")}(e.sectionName),disabled:te[e.sectionName],size:"small"},{default:w((()=>[g(_(n),null,{default:w((()=>[g(p)])),_:1}),m[16]||(m[16]=I(" 重新生成 "))])),_:2},1032,["onClick","disabled"])])])])),default:w((()=>{return[te[e.sectionName]?(N(),h("div",K,[g(_(l),{modelValue:oe[e.sectionName],"onUpdate:modelValue":a=>oe[e.sectionName]=a,type:"textarea",rows:6,resize:"vertical"},null,8,["modelValue","onUpdate:modelValue"])])):(N(),h("div",{key:0,class:"p-4 text-gray-700",innerHTML:(a=e.content,a?a.replace(/\n/g,"<br>"):"")},null,8,q))];var a})),_:2},1024)))),128))])])),_:1})):x("",!0),se.value||F.value?x("",!0):(N(),b(_(s),{key:2,class:"text-center"},{default:w((()=>[y("div",R,[g(_(n),{class:"text-primary mb-4",size:40},{default:w((()=>[g(_(o))])),_:1}),m[18]||(m[18]=y("h2",{class:"text-xl font-semibold mb-2"},"开始创建您的技术交底书",-1)),m[19]||(m[19]=y("p",{class:"text-gray-600 mb-6"},"选择技术领域并输入技术描述，系统将自动为您生成专业的技术交底书",-1)),g(_(t),{type:"primary",onClick:re},{default:w((()=>[g(_(n),null,{default:w((()=>[g(ue)])),_:1}),m[17]||(m[17]=I(" 开始撰写 "))])),_:1})])])),_:1}))])}}}),[["__scopeId","data-v-b7597ae7"]]);export{B as default};
