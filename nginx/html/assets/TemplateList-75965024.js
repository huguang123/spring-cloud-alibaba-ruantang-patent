import{x as e,r as a,X as l,h as t,G as s,H as i,u as d,y as u,A as o,P as m,L as r,K as p,z as n,a4 as c,O as v,M as y,k as f,V as b,I as g}from"./vue-4e979bb7.js";import{b as _,a3 as h,V as T,L as V,K as C,J as N,a5 as w,a6 as E,P as S,al as I,ai as x,X as k,am as D,H as U,G as z,d as A,ag as R,O as P,E as j,U as O,r as q,Q as F,$ as L,a0 as K,a1 as B,a2 as M,a9 as $}from"./elementPlus-e3fc6f82.js";import{P as G}from"./PageHeader-80806eff.js";import{s as H}from"./request-811deccb.js";import{_ as Y}from"./index-4bf8c7f1.js";import{R as X,a as J,g as Q}from"./role-c05f7109.js";import{f as Z}from"./format-42e477fa.js";import{h as W}from"./errorHandler-e80e1e70.js";var ee=(e=>(e[e.PLATFORM=1]="PLATFORM",e[e.ENTERPRISE=2]="ENTERPRISE",e[e.AGENCY=3]="AGENCY",e))(ee||{});const ae={1:"平台租户模板",2:"企业租户模板",3:"代理所租户模板"};var le=(e=>(e[e.EDUCATION=0]="EDUCATION",e[e.MEDICAL=1]="MEDICAL",e[e.FINANCE=2]="FINANCE",e))(le||{});const te={0:"教育",1:"医疗",2:"金融"},se={class:"dialog-footer"},ie=Y(e({__name:"TemplateFormDialog",props:{visible:{type:Boolean,required:!0},isEditing:{type:Boolean,default:!1},initialData:{type:Object,default:null}},emits:["update:visible","submit"],setup(e,{emit:y}){const f=e,b=y,g=a(),I={templateName:"",templateCode:"",templateType:ee.ENTERPRISE,industryType:le.EDUCATION,isSystem:0,templateDesc:"",status:"已启用"},x=a({...I}),k=l({templateName:[{required:!0,message:"请输入模板名称",trigger:"blur"}],templateCode:[{required:!0,message:"请输入模板编码",trigger:"blur"},{pattern:/^[a-zA-Z0-9_]+$/,message:"模板编码只能包含字母、数字和下划线",trigger:"blur"}],templateType:[{required:!0,message:"请选择模板类型",trigger:"change"}],industryType:[{required:!0,message:"请选择行业类型",trigger:"change"}],isSystem:[{required:!0,message:"请选择是否为系统模板",trigger:"change"}],status:[{required:!0,message:"请选择模板状态",trigger:"change"}]});t((()=>f.initialData),(e=>{e&&f.isEditing?(x.value={id:e.id,templateName:e.templateName,templateType:e.templateType,industryType:e.industryType,isSystem:e.isSystem,templateDesc:e.templateDesc||"",status:e.status||"已启用"},f.isEditing||(x.value.templateCode=e.templateCode)):x.value={...I}}),{immediate:!0,deep:!0}),t((()=>f.visible),(e=>{var a,l,t;e&&!f.isEditing?(x.value={...I},null==(a=g.value)||a.resetFields(),null==(l=g.value)||l.clearValidate()):e&&(null==(t=g.value)||t.clearValidate())}));const D=()=>{b("update:visible",!1)},U=async()=>{if(g.value)try{if(await g.value.validate(),f.isEditing){const e={id:f.initialData.id,templateName:x.value.templateName,industryType:x.value.industryType,isSystem:x.value.isSystem,templateDesc:x.value.templateDesc};b("submit",e)}else{const e={templateName:x.value.templateName,templateCode:x.value.templateCode,templateType:x.value.templateType,industryType:x.value.industryType,isSystem:x.value.isSystem,templateDesc:x.value.templateDesc};b("submit",e)}}catch(e){console.log("Form validation failed:",e)}};return(a,l)=>(u(),s(d(S),{"model-value":e.visible,title:e.isEditing?"编辑模板":"新增模板",width:"600px",onClose:D,"close-on-click-modal":!1},{footer:i((()=>[o("span",se,[m(d(_),{onClick:D},{default:i((()=>l[11]||(l[11]=[r("取消")]))),_:1}),m(d(_),{type:"primary",onClick:U},{default:i((()=>l[12]||(l[12]=[r("确定")]))),_:1})])])),default:i((()=>[m(d(E),{ref_key:"templateFormRef",ref:g,model:x.value,rules:k,"label-width":"100px",class:"p-4"},{default:i((()=>[m(d(h),{label:"模板名称",prop:"templateName"},{default:i((()=>[m(d(T),{modelValue:x.value.templateName,"onUpdate:modelValue":l[0]||(l[0]=e=>x.value.templateName=e),placeholder:"请输入模板名称"},null,8,["modelValue"])])),_:1}),e.isEditing?p("",!0):(u(),s(d(h),{key:0,label:"模板编码",prop:"templateCode"},{default:i((()=>[m(d(T),{modelValue:x.value.templateCode,"onUpdate:modelValue":l[1]||(l[1]=e=>x.value.templateCode=e),placeholder:"请输入模板编码"},null,8,["modelValue"])])),_:1})),e.isEditing?p("",!0):(u(),s(d(h),{key:1,label:"模板类型",prop:"templateType"},{default:i((()=>[m(d(V),{modelValue:x.value.templateType,"onUpdate:modelValue":l[2]||(l[2]=e=>x.value.templateType=e),placeholder:"请选择模板类型",style:{width:"100%"}},{default:i((()=>[(u(!0),n(v,null,c(d(ae),((e,a)=>(u(),s(d(C),{key:a,label:e,value:Number(a)},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})),m(d(h),{label:"行业类型",prop:"industryType"},{default:i((()=>[m(d(V),{modelValue:x.value.industryType,"onUpdate:modelValue":l[3]||(l[3]=e=>x.value.industryType=e),placeholder:"请选择行业类型",style:{width:"100%"}},{default:i((()=>[(u(!0),n(v,null,c(d(te),((e,a)=>(u(),s(d(C),{key:a,label:e,value:Number(a)},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),m(d(h),{label:"系统模板",prop:"isSystem"},{default:i((()=>[m(d(N),{modelValue:x.value.isSystem,"onUpdate:modelValue":l[4]||(l[4]=e=>x.value.isSystem=e)},{default:i((()=>[m(d(w),{label:1},{default:i((()=>l[7]||(l[7]=[r("是")]))),_:1}),m(d(w),{label:0},{default:i((()=>l[8]||(l[8]=[r("否")]))),_:1})])),_:1},8,["modelValue"])])),_:1}),m(d(h),{label:"状态",prop:"status"},{default:i((()=>[m(d(N),{modelValue:x.value.status,"onUpdate:modelValue":l[5]||(l[5]=e=>x.value.status=e)},{default:i((()=>[m(d(w),{label:"已启用"},{default:i((()=>l[9]||(l[9]=[r("已启用")]))),_:1}),m(d(w),{label:"已禁用"},{default:i((()=>l[10]||(l[10]=[r("已禁用")]))),_:1})])),_:1},8,["modelValue"])])),_:1}),m(d(h),{label:"描述",prop:"templateDesc"},{default:i((()=>[m(d(T),{modelValue:x.value.templateDesc,"onUpdate:modelValue":l[6]||(l[6]=e=>x.value.templateDesc=e),type:"textarea",rows:3,placeholder:"请输入模板描述"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])),_:1},8,["model-value","title"]))}}),[["__scopeId","data-v-78d0ac72"]]),de={key:0,class:"loading-container"},ue={key:1},oe={class:"mb-2"},me={key:0,class:"text-gray-500 text-sm pt-2"},re={key:1,class:"selected-roles-config thin-scrollbar",style:{"max-height":"350px","overflow-y":"auto"}},pe={class:"flex justify-between items-center"},ne={class:"text-sm"},ce={class:"dialog-footer"},ve=Y(e({__name:"BindRolesDialog",props:{visible:{type:Boolean,required:!0},templateData:{type:Object,default:null}},emits:["update:visible","submit"],setup(e,{emit:l}){const p=e,f=l,b=a(!1),g=a(!1),h=a([]),T=a([]),V=a([]);t((()=>p.visible),(async e=>{if(e&&p.templateData){b.value=!0,T.value=[],V.value=[],h.value=[];try{let e;switch(p.templateData.templateType){case 1:e=J.PLATFORM;break;case 2:default:e=J.ENTERPRISE;break;case 3:e=J.AGENCY}const l=await(a=p.templateData.id,H({url:`/tenant/api/tenant/templates/${a}/roles`,method:"get"}));console.log("获取模板绑定角色API返回:",l);let t=l;l&&200===l.code&&(t=l.data||[]);const s=await Q(e);console.log("获取角色列表API返回:",s);let i=s;s&&200===s.code&&(i=s.data||[]);const d=[],u=[];t.forEach((e=>{var a;const l=(null==(a=e.role)?void 0:a.rolesName)||"未命名角色",t=e.roleId||e.id,s=`bound_${t}`;d.push({...e,displayName:l,transferKey:s,actualRoleId:t,isInherit:void 0!==e.isInherit?e.isInherit:1}),u.push(s)}));const o=[],m=t.map((e=>e.roleId||e.id));i.forEach((e=>{if(!m.includes(e.id)){const a=`avail_${e.id}`;o.push({...e,displayName:e.rolesName||"未命名角色",transferKey:a,actualRoleId:e.id,isInherit:1})}})),h.value=[...o,...d],V.value=d,T.value=u}catch(l){console.error("加载角色数据失败:",l),j.error("加载角色数据失败")}finally{b.value=!1}}else e||(h.value=[],T.value=[],V.value=[]);var a}));const C=(e,a,l)=>{const t=[];e.forEach((e=>{const a=h.value.find((a=>a.transferKey===e));a&&t.push(a)})),V.value=t},N=()=>{g.value||f("update:visible",!1)},w=async()=>{if(p.templateData){g.value=!0;try{const a=V.value.map((e=>({roleId:e.actualRoleId,isInherit:e.isInherit})));await(e={templateId:p.templateData.id,roleBinds:a},H({url:"/tenant/api/tenant/templates/roles/bind",method:"post",data:e})),j.success("角色绑定成功"),f("submit",{templateId:p.templateData.id,roleBinds:a}),f("update:visible",!1)}catch(a){console.error("保存角色绑定失败:",a),j.error("保存角色绑定失败")}finally{g.value=!1}var e}else j.error("模板数据不存在，无法保存")};return(a,l)=>(u(),s(d(S),{"model-value":e.visible,title:"绑定角色",width:"750px",onClose:N,"close-on-click-modal":!1,class:"bind-roles-dialog"},{footer:i((()=>[o("span",ce,[m(d(_),{onClick:N,disabled:g.value},{default:i((()=>l[5]||(l[5]=[r("取消")]))),_:1},8,["disabled"]),m(d(_),{type:"primary",onClick:w,loading:g.value,disabled:b.value},{default:i((()=>l[6]||(l[6]=[r("确定保存")]))),_:1},8,["loading","disabled"])])])),default:i((()=>{var a;return[b.value?(u(),n("div",de,[m(d(I),{rows:8,animated:""})])):(u(),n("div",ue,[o("p",oe,[l[1]||(l[1]=r('正在为模板 "')),o("strong",null,y(null==(a=e.templateData)?void 0:a.templateName),1),l[2]||(l[2]=r('" 配置角色。'))]),m(d(x),{title:"关于角色绑定",type:"info",description:"请选择需要绑定到此模板的角色。绑定后，使用此模板创建的企业将默认拥有这些角色的权限。对于每个已选角色，您可以指定其权限是否随平台对该角色的权限定义变更而自动更新。","show-icon":"",class:"mb-4",closable:!1}),m(d(P),{gutter:20},{default:i((()=>[m(d(k),{span:14},{default:i((()=>[l[3]||(l[3]=o("h4",{class:"mb-2 text-sm font-medium"},"选择角色:",-1)),m(d(D),{modelValue:T.value,"onUpdate:modelValue":l[0]||(l[0]=e=>T.value=e),data:h.value,titles:["可选角色","已选角色"],props:{key:"transferKey",label:"displayName"},filterable:"","filter-placeholder":"搜索角色名称","target-order":"push",class:"role-transfer",onChange:C},{default:i((({option:e})=>[o("span",null,[r(y(e.displayName)+" ",1),m(d(U),{size:"small",type:"info",class:"ml-1"},{default:i((()=>{return[r(y((a=e.rolesType,void 0===a?"未知类型":X[a]||"自定义类型")),1)];var a})),_:2},1024)])])),_:1},8,["modelValue","data"])])),_:1}),m(d(k),{span:10},{default:i((()=>[l[4]||(l[4]=o("h4",{class:"mb-2 text-sm font-medium"},"配置继承权限:",-1)),0===V.value.length?(u(),n("div",me," 请先从左侧选择角色。 ")):(u(),n("div",re,[(u(!0),n(v,null,c(V.value,(e=>(u(),s(d(z),{shadow:"never",key:e.transferKey,class:"mb-2 role-config-item"},{default:i((()=>[o("div",pe,[o("span",ne,y(e.displayName),1),m(d(A),{content:"是否继承权限变更",placement:"top"},{default:i((()=>[m(d(R),{modelValue:e.isInherit,"onUpdate:modelValue":a=>e.isInherit=a,size:"small","inline-prompt":"","active-text":"继承","inactive-text":"不继承","active-value":1,"inactive-value":0},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024)])])),_:2},1024)))),128))]))])),_:1})])),_:1})]))]})),_:1},8,["model-value"]))}}),[["__scopeId","data-v-494076a7"]]),ye={class:"enterprise-template-list-container p-4"},fe={class:"font-medium"},be={class:"text-sm text-gray-500"},ge=Y(e({__name:"TemplateList",setup(e){const t=l({templateName:"",templateCode:"",templateType:void 0,industryType:void 0,isSystem:void 0}),p=a([]),N=a(!1),w=l({page:1,pageSize:10,total:0}),S=async()=>{N.value=!0;try{const e={pageNum:w.page,pageSize:w.pageSize,templateName:t.templateName,templateCode:t.templateCode,templateType:t.templateType,industryType:t.industryType,isSystem:t.isSystem},a=await(e=>H({url:"/tenant/api/tenant/templates/page",method:"post",data:e}))(e);a.records?(p.value=a.records,w.total=a.total):a.data&&a.data.records?(p.value=a.data.records,w.total=a.data.total||0):(p.value=[],w.total=0)}catch(e){W(e,"获取模板列表失败"),p.value=[],w.total=0}finally{N.value=!1}};f(S);const I=()=>{w.page=1,S()},x=()=>{t.templateName="",t.templateCode="",t.templateType=void 0,t.industryType=void 0,t.isSystem=void 0,I()},D=e=>{w.pageSize=e,S()},A=e=>{w.page=e,S()},R=a(!1),Y=a(!1),X=a(null),J=a(!1),Q=a(null),ee=()=>{Y.value=!1,X.value=null,R.value=!0},le=async e=>{try{Y.value&&e.id?(await(a=e,H({url:"/tenant/api/tenant/templates",method:"put",data:a})),j.success("模板更新成功")):(await(e=>H({url:"/tenant/api/tenant/templates",method:"post",data:e}))(e),j.success("模板创建成功")),R.value=!1,S()}catch(l){W(l,"保存模板失败")}var a},se=async e=>{try{await(e=>H({url:`/tenant/api/tenant/templates/${e}`,method:"delete"}))(e),j.success("模板删除成功"),S()}catch(a){W(a,"删除模板失败")}},de=()=>{j.success("角色绑定已更新"),J.value=!1,Q.value&&S()};return(e,a)=>{const l=$;return u(),n("div",ye,[m(G,{title:"企业模板列表管理",subtitle:"企业模板，不仅可以提供给不同行业使用，而且包括对应权限，企业基础数据等"}),m(d(z),{shadow:"never",class:"mb-4 filter-card"},{default:i((()=>[m(d(E),{inline:!0,model:t,onSubmit:b(I,["prevent"])},{default:i((()=>[m(d(P),{gutter:16},{default:i((()=>[m(d(k),{xs:24,sm:12,md:8,lg:6},{default:i((()=>[m(d(h),{label:"模板名称"},{default:i((()=>[m(d(T),{modelValue:t.templateName,"onUpdate:modelValue":a[0]||(a[0]=e=>t.templateName=e),placeholder:"搜索模板名称...",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),m(d(k),{xs:24,sm:12,md:8,lg:6},{default:i((()=>[m(d(h),{label:"模板编码"},{default:i((()=>[m(d(T),{modelValue:t.templateCode,"onUpdate:modelValue":a[1]||(a[1]=e=>t.templateCode=e),placeholder:"搜索模板编码...",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),m(d(k),{xs:24,sm:12,md:8,lg:5},{default:i((()=>[m(d(h),{label:"模板类型"},{default:i((()=>[m(d(V),{modelValue:t.templateType,"onUpdate:modelValue":a[2]||(a[2]=e=>t.templateType=e),placeholder:"选择模板类型",clearable:"",style:{width:"100%"}},{default:i((()=>[(u(!0),n(v,null,c(d(ae),((e,a)=>(u(),s(d(C),{key:a,label:e,value:Number(a)},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),m(d(k),{xs:24,sm:12,md:8,lg:5},{default:i((()=>[m(d(h),{label:"行业类型"},{default:i((()=>[m(d(V),{modelValue:t.industryType,"onUpdate:modelValue":a[3]||(a[3]=e=>t.industryType=e),placeholder:"选择行业类型",clearable:"",style:{width:"100%"}},{default:i((()=>[(u(!0),n(v,null,c(d(te),((e,a)=>(u(),s(d(C),{key:a,label:e,value:Number(a)},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1}),m(d(k),{xs:24,sm:12,md:8,lg:5},{default:i((()=>[m(d(h),{label:"系统模板"},{default:i((()=>[m(d(V),{modelValue:t.isSystem,"onUpdate:modelValue":a[4]||(a[4]=e=>t.isSystem=e),placeholder:"是否系统模板",clearable:"",style:{width:"100%"}},{default:i((()=>[m(d(C),{label:"是",value:1}),m(d(C),{label:"否",value:0})])),_:1},8,["modelValue"])])),_:1})])),_:1}),m(d(k),{xs:24,sm:24,md:24,lg:8,class:"text-right mt-0 md:mt-0 lg:mt-0"},{default:i((()=>[m(d(h),null,{default:i((()=>[m(d(_),{type:"primary",icon:d(O),onClick:I},{default:i((()=>a[9]||(a[9]=[r("筛选")]))),_:1},8,["icon"]),m(d(_),{icon:d(q),onClick:x},{default:i((()=>a[10]||(a[10]=[r("重置")]))),_:1},8,["icon"]),m(d(_),{type:"primary",icon:d(F),onClick:ee,class:"ml-auto"},{default:i((()=>a[11]||(a[11]=[r("新增模板")]))),_:1},8,["icon"])])),_:1})])),_:1})])),_:1})])),_:1},8,["model"])])),_:1}),m(d(z),{shadow:"never",class:"table-card"},{default:i((()=>[g((u(),s(d(B),{data:p.value,style:{width:"100%"}},{default:i((()=>[m(d(L),{label:"模板名称","min-width":"220"},{default:i((({row:e})=>[o("div",fe,y(e.templateName),1),o("div",be,y(e.templateDesc||"暂无描述"),1)])),_:1}),m(d(L),{prop:"templateCode",label:"模板编码","min-width":"150"}),m(d(L),{label:"模板类型","min-width":"120"},{default:i((({row:e})=>[m(d(U),null,{default:i((()=>[r(y(d(ae)[e.templateType]||"未知类型"),1)])),_:2},1024)])),_:1}),m(d(L),{label:"行业类型","min-width":"100"},{default:i((({row:e})=>[m(d(U),null,{default:i((()=>[r(y(d(te)[e.industryType]||"未知类型"),1)])),_:2},1024)])),_:1}),m(d(L),{label:"是否系统模板","min-width":"120"},{default:i((({row:e})=>[m(d(U),{type:e.isSystem?"success":"info"},{default:i((()=>[r(y(e.isSystem?"是":"否"),1)])),_:2},1032,["type"])])),_:1}),m(d(L),{label:"创建时间","min-width":"150"},{default:i((({row:e})=>[r(y(d(Z)(e.createTime)),1)])),_:1}),m(d(L),{label:"操作",width:"200",fixed:"right"},{default:i((({row:e})=>[m(d(_),{text:"",type:"primary",size:"small",onClick:a=>(e=>{Y.value=!0,X.value={...e},R.value=!0})(e)},{default:i((()=>a[12]||(a[12]=[r("编辑")]))),_:2},1032,["onClick"]),m(d(_),{text:"",type:"primary",size:"small",onClick:a=>(e=>{Q.value=e,J.value=!0})(e)},{default:i((()=>a[13]||(a[13]=[r("绑定角色")]))),_:2},1032,["onClick"]),m(d(K),{title:"确定删除该模板吗?",onConfirm:a=>se(e.id)},{reference:i((()=>[m(d(_),{text:"",type:"danger",size:"small"},{default:i((()=>a[14]||(a[14]=[r("删除")]))),_:1})])),_:2},1032,["onConfirm"])])),_:1})])),_:1},8,["data"])),[[l,N.value]]),m(d(M),{class:"mt-4 justify-end","current-page":w.page,"onUpdate:currentPage":a[5]||(a[5]=e=>w.page=e),"page-size":w.pageSize,"onUpdate:pageSize":a[6]||(a[6]=e=>w.pageSize=e),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:w.total,onSizeChange:D,onCurrentChange:A},null,8,["current-page","page-size","total"])])),_:1}),m(ie,{visible:R.value,"onUpdate:visible":a[7]||(a[7]=e=>R.value=e),"is-editing":Y.value,"initial-data":X.value,onSubmit:le},null,8,["visible","is-editing","initial-data"]),m(ve,{visible:J.value,"onUpdate:visible":a[8]||(a[8]=e=>J.value=e),"template-data":Q.value,onSubmit:de},null,8,["visible","template-data"])])}}}),[["__scopeId","data-v-4ca30afd"]]);export{ge as default};
