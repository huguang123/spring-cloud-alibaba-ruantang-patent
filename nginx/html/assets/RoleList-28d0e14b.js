import{x as e,r as a,X as l,c as o,h as t,G as s,H as i,y as d,P as r,L as u,M as n,I as c,z as m,a4 as p,u as v,O as f,n as g,A as y,k as b,V as h}from"./vue-4e979bb7.js";import{P as _,V as w,a3 as k,K as C,L as V,a6 as N,b as M,a9 as T,Y as D,ab as E,ad as S,H as P,an as x,aa as z,E as A,O as I,X as j,U,r as R,Q as O,G as F,$ as L,a0 as q,a1 as B,a2 as G}from"./elementPlus-e3fc6f82.js";import{P as H}from"./PageHeader-80806eff.js";import{a as Y,R as $,b as X,c as K,d as Q,u as J,e as W,f as Z}from"./role-c05f7109.js";import{_ as ee}from"./index-4bf8c7f1.js";import{h as ae}from"./errorHandler-e80e1e70.js";import{f as le}from"./format-42e477fa.js";import"./request-811deccb.js";const oe=ee(e({__name:"RoleFormDialog",props:{visible:{type:Boolean},isEditing:{type:Boolean},initialData:{}},emits:["update:visible","submit"],setup(e,{emit:y}){const b=e,h=y,D=a(),E=a(!1),S=a(!1),P={rolesCode:"",rolesName:"",rolesType:Y.PLATFORM,rolesDescription:""},x=l({...P}),z=o((()=>b.isEditing)),A=o((()=>z.value?"编辑角色":"新增角色"));t((()=>b.visible),(e=>{e?(I(),b.initialData&&z.value&&g((()=>{Object.assign(x,b.initialData)}))):I()}));const I=()=>{D.value&&D.value.resetFields(),Object.assign(x,P),x.rolesType=Y.PLATFORM},j=l({rolesCode:[{required:!0,message:"请输入角色编码",trigger:"blur"},{min:3,max:50,message:"长度在 3 到 50 个字符",trigger:"blur"}],rolesName:[{required:!0,message:"请输入角色名称",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],rolesType:[{required:!0,message:"请选择角色类型",trigger:"change"}],rolesDescription:[{max:200,message:"描述最多 200 个字符",trigger:"blur"}]}),U=()=>{h("update:visible",!1)},R=async()=>{var e;if(D.value)try{await D.value.validate(),S.value=!0,z.value&&(null==(e=b.initialData)?void 0:e.id)?h("submit",{id:b.initialData.id,rolesName:x.rolesName,rolesDescription:x.rolesDescription}):h("submit",x)}catch(a){console.log("表单校验失败或提交出错",a)}finally{S.value=!1}};return(e,a)=>{const l=w,o=k,t=C,g=V,y=N,b=M,h=_,P=T;return d(),s(h,{"model-value":e.visible,title:A.value,width:"600px",onClose:U,"close-on-click-modal":!1},{footer:i((()=>[r(b,{onClick:U},{default:i((()=>a[4]||(a[4]=[u("取消")]))),_:1}),r(b,{type:"primary",onClick:R,loading:S.value},{default:i((()=>[u(n(e.isEditing?"确认修改":"确认新增"),1)])),_:1},8,["loading"])])),default:i((()=>[c((d(),s(y,{ref_key:"roleFormRef",ref:D,model:x,rules:j,"label-width":"100px"},{default:i((()=>[r(o,{label:"角色编码",prop:"rolesCode"},{default:i((()=>[r(l,{modelValue:x.rolesCode,"onUpdate:modelValue":a[0]||(a[0]=e=>x.rolesCode=e),placeholder:"请输入角色编码",disabled:e.isEditing},null,8,["modelValue","disabled"])])),_:1}),r(o,{label:"角色名称",prop:"rolesName"},{default:i((()=>[r(l,{modelValue:x.rolesName,"onUpdate:modelValue":a[1]||(a[1]=e=>x.rolesName=e),placeholder:"请输入角色名称"},null,8,["modelValue"])])),_:1}),r(o,{label:"角色类型",prop:"rolesType"},{default:i((()=>[r(g,{modelValue:x.rolesType,"onUpdate:modelValue":a[2]||(a[2]=e=>x.rolesType=e),placeholder:"请选择角色类型",style:{width:"100%"},disabled:e.isEditing},{default:i((()=>[(d(!0),m(f,null,p(v($),((e,a)=>(d(),s(t,{key:a,label:e,value:Number(a)},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1}),r(o,{label:"角色描述",prop:"rolesDescription"},{default:i((()=>[r(l,{modelValue:x.rolesDescription,"onUpdate:modelValue":a[3]||(a[3]=e=>x.rolesDescription=e),type:"textarea",rows:3,placeholder:"请输入角色描述"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])),[[P,E.value]])])),_:1},8,["model-value","title"])}}}),[["__scopeId","data-v-8acc80c9"]]),te={key:0,class:"p-4 text-center"},se={key:1,class:"permission-config-container"},ie={class:"permission-tabs"},de={class:"module-container"},re={class:"module-header"},ue={class:"module-nodes"},ne={class:"module-container"},ce={class:"module-header"},me={class:"module-nodes"},pe={class:"dialog-footer"},ve=ee(e({__name:"AssignPermissionsDialog",props:{visible:{type:Boolean},roleData:{}},emits:["update:visible","permissions-saved"],setup(e,{emit:l}){const g=e,b=l,h=a({operationModules:[],dataModules:[]}),w=a([]),k=a([]),C=a("operation"),V=a(!1),N=a(!1),I=o((()=>g.roleData?`为角色 '${g.roleData.rolesName}' 分配权限`:"分配权限"));t((()=>[g.visible,g.roleData]),(([e,a])=>{e&&a&&"object"==typeof a&&"id"in a&&j(a.id)}),{immediate:!0});const j=async e=>{V.value=!0,w.value=[],k.value=[];try{const a=await X(e);let l;console.log("获取角色权限树API返回:",a),l=a&&200===a.code?a.data:a,h.value={operationModules:Array.isArray(l.operationModules)?l.operationModules:[],dataModules:Array.isArray(l.dataModules)?l.dataModules:[]},console.log("处理后的权限树数据:",h.value),U()}catch(a){ae(a,"加载权限数据失败")}finally{V.value=!1}},U=()=>{var e,a;null==(e=h.value.operationModules)||e.forEach((e=>{e.nodes.forEach((e=>{e.selected&&w.value.push(e.id.toString())}))})),null==(a=h.value.dataModules)||a.forEach((e=>{e.nodes.forEach((e=>{e.selected&&k.value.push(e.id.toString())}))}))},R=e=>{if(!e.nodes||0===e.nodes.length)return!1;const a=h.value.operationModules.includes(e)?w.value:k.value;return e.nodes.every((e=>a.includes(e.id.toString())))},O=e=>{if(!e.nodes||0===e.nodes.length)return!1;const a=h.value.operationModules.includes(e)?w.value:k.value,l=e.nodes.filter((e=>a.includes(e.id.toString()))).length;return l>0&&l<e.nodes.length},F=(e,a)=>{const l=Boolean(a),o=h.value.operationModules.includes(e),t=e.nodes.map((e=>e.id.toString()));o?w.value=l?[...new Set([...w.value,...t])]:w.value.filter((e=>!t.includes(e))):k.value=l?[...new Set([...k.value,...t])]:k.value.filter((e=>!t.includes(e)))},L=async()=>{if(g.roleData){N.value=!0;try{const e=q(),a=B(),l=await K({roleId:g.roleData.id,permIds:e,dataPolicyIds:a});console.log("保存权限API返回:",l);let o=!1;if((l&&200===l.code||!0===l||"object"==typeof l&&null!==l&&!0===l.data)&&(o=!0),!o)throw new Error("API返回格式异常");A.success("权限分配成功"),b("permissions-saved",g.roleData.id),G()}catch(e){ae(e,"保存权限失败")}finally{N.value=!1}}else ae(new Error("没有选择角色"),"没有选择角色")},q=()=>{var e;const a=[];return null==(e=h.value.operationModules)||e.forEach((e=>{e.nodes.forEach((e=>{w.value.includes(e.id.toString())&&e.permId&&a.push(e.permId)}))})),a},B=()=>{var e;const a=[];return null==(e=h.value.dataModules)||e.forEach((e=>{e.nodes.forEach((e=>{k.value.includes(e.id.toString())&&e.dataPolicyId&&a.push(e.dataPolicyId)}))})),a},G=()=>{b("update:visible",!1)};return(e,a)=>{const l=T;return d(),s(v(_),{"model-value":e.visible,title:I.value,width:"80%",top:"5vh",onClose:G,"close-on-click-modal":!1,"destroy-on-close":"","append-to-body":""},{footer:i((()=>[y("span",pe,[r(v(M),{onClick:G,disabled:N.value||V.value},{default:i((()=>a[3]||(a[3]=[u("取消")]))),_:1},8,["disabled"]),r(v(M),{type:"primary",onClick:L,loading:N.value,disabled:!e.roleData||V.value},{default:i((()=>a[4]||(a[4]=[u(" 保存权限 ")]))),_:1},8,["loading","disabled"])])])),default:i((()=>[e.roleData?c((d(),m("div",se,[y("div",ie,[r(v(z),{modelValue:C.value,"onUpdate:modelValue":a[2]||(a[2]=e=>C.value=e),type:"border-card"},{default:i((()=>[r(v(E),{label:"功能权限",name:"operation"},{default:i((()=>[y("div",de,[h.value.operationModules&&h.value.operationModules.length>0?(d(!0),m(f,{key:0},p(h.value.operationModules,(e=>(d(),m("div",{key:e.id,class:"module-block"},[y("div",re,[r(v(S),{"model-value":R(e),indeterminate:O(e),onChange:a=>F(e,a)},{default:i((()=>[u(n(e.moduleName),1)])),_:2},1032,["model-value","indeterminate","onChange"]),r(v(P),{size:"small"},{default:i((()=>[u(n(e.moduleTypeName),1)])),_:2},1024)]),y("div",ue,[r(v(x),{modelValue:w.value,"onUpdate:modelValue":a[0]||(a[0]=e=>w.value=e)},{default:i((()=>[(d(!0),m(f,null,p(e.nodes,(e=>(d(),s(v(S),{key:e.id,label:e.id.toString()},{default:i((()=>[u(n(e.nodeName),1)])),_:2},1032,["label"])))),128))])),_:2},1032,["modelValue"])])])))),128)):(d(),s(v(D),{key:1,description:"无可用的功能权限"}))])])),_:1}),r(v(E),{label:"数据权限",name:"data"},{default:i((()=>[y("div",ne,[h.value.dataModules&&h.value.dataModules.length>0?(d(!0),m(f,{key:0},p(h.value.dataModules,(e=>(d(),m("div",{key:e.id,class:"module-block"},[y("div",ce,[r(v(S),{"model-value":R(e),indeterminate:O(e),onChange:a=>F(e,a)},{default:i((()=>[u(n(e.moduleName),1)])),_:2},1032,["model-value","indeterminate","onChange"]),r(v(P),{size:"small",type:"success"},{default:i((()=>[u(n(e.moduleTypeName),1)])),_:2},1024)]),y("div",me,[r(v(x),{modelValue:k.value,"onUpdate:modelValue":a[1]||(a[1]=e=>k.value=e)},{default:i((()=>[(d(!0),m(f,null,p(e.nodes,(e=>(d(),s(v(S),{key:e.id,label:e.id.toString()},{default:i((()=>[u(n(e.nodeName),1)])),_:2},1032,["label"])))),128))])),_:2},1032,["modelValue"])])])))),128)):(d(),s(v(D),{key:1,description:"无可用的数据权限"}))])])),_:1})])),_:1},8,["modelValue"])])])),[[l,V.value]]):(d(),m("div",te,[r(v(D),{description:"未选择角色"})]))])),_:1},8,["model-value","title"])}}}),[["__scopeId","data-v-1bfe5788"]]),fe={class:"role-list-container p-4"},ge=ee(e({__name:"RoleList",setup(e){const o=l({keyword:"",roleType:void 0}),t=a([]),p=a(!1),f=l({pageNum:1,pageSize:10,total:0}),g=a(!1),y=a(!1),_=a(null),D=a(!1),E=a(null),S=async()=>{p.value=!0;try{const e={pageNum:f.pageNum,pageSize:f.pageSize,keyword:o.keyword,roleType:""===o.roleType?void 0:o.roleType},a=await Q(e);a?(a.records?t.value=a.records:Array.isArray(a)?t.value=a:a.data&&a.data.records&&(t.value=a.data.records),f.total=a.total||a.data&&a.data.total||0):(t.value=[],f.total=0)}catch(e){ae(e,"获取角色列表失败")}finally{p.value=!1}};b(S);const x=()=>{f.pageNum=1,S()},z=()=>{o.keyword="",o.roleType=void 0,x()},X=e=>{f.pageSize=e,S()},K=e=>{f.pageNum=e,S()},ee=e=>{switch(e){case Y.PLATFORM:return"primary";case Y.ENTERPRISE:return"success";case Y.AGENCY:return"warning";default:return"info"}},te=()=>{y.value=!1,_.value=null,g.value=!0},se=async e=>{try{y.value&&e.id?(await J(e),A.success("角色更新成功")):(await W(e),A.success("角色创建成功")),g.value=!1,S()}catch(a){ae(a,"保存角色失败")}},ie=e=>{console.log(`Permissions saved for role ${e} via dialog.`),S()};return(e,a)=>{const l=T;return d(),m("div",fe,[r(H,{title:"角色列表",subtitle:"管理系统中的所有角色信息"}),r(v(F),{shadow:"never",class:"mb-4 filter-card"},{default:i((()=>[r(v(N),{inline:!0,model:o,onSubmit:h(x,["prevent"])},{default:i((()=>[r(v(I),{gutter:16},{default:i((()=>[r(v(j),{xs:24,sm:12,md:8,lg:6},{default:i((()=>[r(v(k),{label:"关键字"},{default:i((()=>[r(v(w),{modelValue:o.keyword,"onUpdate:modelValue":a[0]||(a[0]=e=>o.keyword=e),placeholder:"搜索角色名称或编码...",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),r(v(j),{xs:24,sm:12,md:8,lg:5},{default:i((()=>[r(v(k),{label:"角色类型"},{default:i((()=>[r(v(V),{modelValue:o.roleType,"onUpdate:modelValue":a[1]||(a[1]=e=>o.roleType=e),placeholder:"所有类型",clearable:"",style:{width:"100%"}},{default:i((()=>[r(v(C),{label:"平台角色",value:v(Y).PLATFORM},null,8,["value"]),r(v(C),{label:"企业角色",value:v(Y).ENTERPRISE},null,8,["value"]),r(v(C),{label:"代理所角色",value:v(Y).AGENCY},null,8,["value"])])),_:1},8,["modelValue"])])),_:1})])),_:1}),r(v(j),{xs:24,sm:24,md:8,lg:8,class:"text-right mt-0 md:mt-0 lg:mt-0"},{default:i((()=>[r(v(k),null,{default:i((()=>[r(v(M),{type:"primary",icon:v(U),onClick:x},{default:i((()=>a[6]||(a[6]=[u("筛选")]))),_:1},8,["icon"]),r(v(M),{icon:v(R),onClick:z},{default:i((()=>a[7]||(a[7]=[u("重置")]))),_:1},8,["icon"]),r(v(M),{type:"primary",icon:v(O),onClick:te,class:"ml-auto"},{default:i((()=>a[8]||(a[8]=[u("新增角色")]))),_:1},8,["icon"])])),_:1})])),_:1})])),_:1})])),_:1},8,["model"])])),_:1}),r(v(F),{shadow:"never",class:"table-card"},{default:i((()=>[c((d(),s(v(B),{data:t.value,style:{width:"100%"}},{default:i((()=>[r(v(L),{prop:"rolesName",label:"角色名称","min-width":"180"}),r(v(L),{prop:"rolesCode",label:"角色编码","min-width":"150"}),r(v(L),{label:"角色类型","min-width":"120"},{default:i((({row:e})=>[r(v(P),{type:ee(e.rolesType)},{default:i((()=>[u(n(v($)[e.rolesType]||e.rolesTypeName),1)])),_:2},1032,["type"])])),_:1}),r(v(L),{prop:"rolesDescription",label:"角色描述","min-width":"250","show-overflow-tooltip":""}),r(v(L),{label:"创建时间","min-width":"150"},{default:i((({row:e})=>[u(n(v(le)(e.createTime)),1)])),_:1}),r(v(L),{label:"操作",width:"220",fixed:"right"},{default:i((({row:e})=>[r(v(M),{text:"",type:"primary",size:"small",onClick:a=>{return l=e,E.value=l,void(D.value=!0);var l}},{default:i((()=>a[9]||(a[9]=[u("分配权限")]))),_:2},1032,["onClick"]),r(v(M),{text:"",type:"primary",size:"small",onClick:a=>(e=>{y.value=!0,_.value={...e},g.value=!0})(e)},{default:i((()=>a[10]||(a[10]=[u("编辑")]))),_:2},1032,["onClick"]),r(v(q),{title:"确定删除该角色吗?",onConfirm:a=>(async e=>{try{await Z(e),A.success("角色删除成功"),S()}catch(a){ae(a,"删除角色失败")}})(e.id)},{reference:i((()=>[r(v(M),{text:"",type:"danger",size:"small"},{default:i((()=>a[11]||(a[11]=[u("删除")]))),_:1})])),_:2},1032,["onConfirm"])])),_:1})])),_:1},8,["data"])),[[l,p.value]]),r(v(G),{class:"mt-4 justify-end","current-page":f.pageNum,"onUpdate:currentPage":a[2]||(a[2]=e=>f.pageNum=e),"page-size":f.pageSize,"onUpdate:pageSize":a[3]||(a[3]=e=>f.pageSize=e),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:f.total,onSizeChange:X,onCurrentChange:K},null,8,["current-page","page-size","total"])])),_:1}),r(oe,{visible:g.value,"onUpdate:visible":a[4]||(a[4]=e=>g.value=e),"is-editing":y.value,"initial-data":_.value,onSubmit:se},null,8,["visible","is-editing","initial-data"]),r(ve,{visible:D.value,"onUpdate:visible":a[5]||(a[5]=e=>D.value=e),"role-data":E.value,onPermissionsSaved:ie},null,8,["visible","role-data"])])}}}),[["__scopeId","data-v-dc7cedc2"]]);export{ge as default};
