import{x as e,r as a,X as l,k as t,z as o,P as i,H as u,u as d,y as r,A as p,L as s,a5 as n,I as c,G as m,M as f,K as v}from"./vue-4e979bb7.js";import{P as y}from"./PageHeader-80806eff.js";import{X as g,G as _,b,Q as h,V,U as T,$ as C,H as N,a1 as w,a2 as x,O as P,Z as U,_ as z,P as S,a6 as k,a3 as E,L as A,K as D,ac as O,v as j,a9 as q}from"./elementPlus-e3fc6f82.js";import{a as L,b as I,c as M,d as H,u as G,e as Q,f as $,h as F,i as K,j as B}from"./permission-c6efb21f.js";import{h as Z,f as R,a as X}from"./errorHandler-e80e1e70.js";import{_ as J}from"./index-4bf8c7f1.js";import"./request-811deccb.js";const W={class:"basic-permission-container"},Y={class:"card-header"},ee={class:"config-content"},ae={class:"search-bar"},le={class:"text-muted"},te={class:"card-header"},oe={class:"config-content"},ie={class:"search-bar"},ue={class:"text-muted"},de={class:"dialog-footer"},re={class:"dialog-footer"},pe={class:"dialog-footer"},se={class:"dialog-footer"},ne=J(e({__name:"BasicPermission",setup(e){const J=a([]),ne=a([]),ce=a(0),me=a(0),fe=a(!1),ve=a(!1),ye=a(null),ge=a(null),_e=l({pageNum:1,pageSize:10,policyName:"",policyCode:"",conditionType:void 0}),be=a(""),he=a(!1),Ve=l({pageNum:1,pageSize:10,permsName:"",permsCode:"",apiMethod:"",permType:""}),Te=a(""),Ce=a(!1),Ne=a(!1),we=a(!1),xe=a(!1),Pe=a(!1),Ue=a(),ze=a(),Se={policyName:"",policyCode:"",conditionType:1,priority:50,effectTables:"",policyDescription:"",conditionExpression:""},ke=l({...Se,id:void 0}),Ee={permsName:"",permsCode:"",permType:"API",apiMethod:"GET",apiPath:"",permsDescription:""},Ae=l({...Ee}),De=l({policyName:[{required:!0,message:"请输入策略名称",trigger:"blur"}],policyCode:[{required:!0,message:"请输入策略编码",trigger:"blur"},{pattern:/^[A-Za-z0-9_:]+$/,message:"只能包含字母、数字、下划线和冒号",trigger:"blur"}],conditionType:[{required:!0,message:"请选择条件类型",trigger:"change"}],effectTables:[{required:!0,message:"请输入生效表",trigger:"blur"}],conditionExpression:[{required:!0,message:"请输入条件表达式",trigger:"blur"}]}),Oe=l({permsName:[{required:!0,message:"请输入权限名称",trigger:"blur"}],permsCode:[{required:!0,message:"请输入权限编码",trigger:"blur"},{pattern:/^[a-zA-Z0-9_:]+$/,message:"只能包含字母、数字、下划线和冒号",trigger:"blur"}],permType:[{required:!0,message:"请选择权限类型",trigger:"change"}],apiPath:[{required:!0,message:"请输入接口路径",trigger:"blur"}],apiMethod:[{required:!0,message:"请选择请求方法",trigger:"change"}]});t((()=>{je(),Me()}));const je=async()=>{he.value=!0;try{const e=await L(_e);let a;console.log("数据策略API返回:",e),a=e&&200===e.code?e.data:e,a&&a.records?(J.value=a.records,ce.value=a.total||0):Array.isArray(a)?(J.value=a,ce.value=a.length):(console.warn("无法识别的数据策略响应格式:",a),J.value=[],ce.value=0)}catch(e){Z(e,"获取数据策略列表失败"),J.value=[],ce.value=0}finally{he.value=!1}},qe=()=>{be.value?_e.policyName=be.value:_e.policyName="",_e.pageNum=1,je()},Le=e=>{_e.pageNum=e,je()},Ie=e=>{_e.pageSize=e,_e.pageNum=1,je()},Me=async()=>{Ce.value=!0;try{const e=await I(Ve);let a;console.log("操作权限API返回:",e),a=e&&200===e.code?e.data:e,a&&a.records?(ne.value=a.records,me.value=a.total||0):Array.isArray(a)?(ne.value=a,me.value=a.length):(console.warn("无法识别的操作权限响应格式:",a),ne.value=[],me.value=0)}catch(e){Z(e,"获取操作权限列表失败"),ne.value=[],me.value=0}finally{Ce.value=!1}},He=()=>{Te.value?(Ve.permsName=Te.value,Ve.permsCode=""):(Ve.permsName="",Ve.permsCode=""),Ve.pageNum=1,Me()},Ge=e=>{Ve.pageNum=e,Me()},Qe=e=>{Ve.pageSize=e,Ve.pageNum=1,Me()},$e=()=>{xe.value=!1,ke.id=void 0,Object.assign(ke,Se),Ne.value=!0},Fe=()=>{var e;null==(e=Ue.value)||e.resetFields(),Object.assign(ke,Se)},Ke=async()=>{Ue.value&&await Ue.value.validate((async e=>{if(e)try{let e,a;xe.value&&ke.id?(e=await G(ke),a="数据策略更新成功"):(e=await Q(ke),a="数据策略创建成功"),X(e,a,"保存数据策略失败")&&(Ne.value=!1,je())}catch(a){Z(a,"保存数据策略失败")}}))},Be=()=>{Pe.value=!1,Ae.id=void 0,Object.assign(Ae,Ee),we.value=!0},Ze=()=>{var e;null==(e=ze.value)||e.resetFields(),Object.assign(Ae,Ee)},Re=async()=>{ze.value&&await ze.value.validate((async e=>{if(e)try{let e,a;Pe.value&&Ae.id?(e=await K(Ae),a="操作权限更新成功"):(e=await B(Ae),a="操作权限创建成功"),X(e,a,"保存操作权限失败")&&(we.value=!1,Me())}catch(a){Z(a,"保存操作权限失败")}}))};return(e,a)=>{const l=q;return r(),o("div",W,[i(y,{title:"基础权限配置",subtitle:"配置系统基础的数据策略和操作权限"}),i(d(P),{gutter:20},{default:u((()=>[i(d(g),{span:12},{default:u((()=>[i(d(_),{class:"box-card data-strategy-card"},{header:u((()=>[p("div",Y,[a[32]||(a[32]=p("span",null,"数据策略配置",-1)),i(d(b),{type:"primary",icon:d(h),onClick:$e},{default:u((()=>a[31]||(a[31]=[s(" 新增策略 ")]))),_:1},8,["icon"])])])),default:u((()=>[p("div",ee,[p("div",ae,[i(d(V),{modelValue:be.value,"onUpdate:modelValue":a[0]||(a[0]=e=>be.value=e),placeholder:"搜索策略...",class:"filter-input",onKeyup:n(qe,["enter"]),clearable:"","suffix-icon":d(T)},{append:u((()=>[i(d(b),{icon:d(T),onClick:qe},null,8,["icon"])])),_:1},8,["modelValue","suffix-icon"])]),c((r(),m(d(w),{data:J.value,style:{width:"100%"},height:"400px","empty-text":"暂无数据"},{default:u((()=>[i(d(C),{label:"策略",prop:"policyName"},{default:u((({row:e})=>[p("div",null,[s(f(e.policyName)+" ",1),i(d(N),{size:"small"},{default:u((()=>[s(f(e.priority),1)])),_:2},1024)]),p("div",le,f(e.policyDescription||""),1)])),_:1}),i(d(C),{label:"类型",prop:"conditionType",width:"100"},{default:u((({row:e})=>[s(f(1===e.conditionType?"SQL片段":"SpEL"),1)])),_:1}),i(d(C),{label:"操作",width:"100",align:"right"},{default:u((({row:e})=>[i(d(b),{text:"",type:"primary",size:"small",onClick:a=>(async e=>{try{if(e.id){const a=await M(e.id);let l;console.log("获取数据策略详情API返回:",a),l=a&&200===a.code?a.data:a,ye.value=l,fe.value=!0}}catch(a){Z(a,"获取数据策略详情失败")}})(e)},{default:u((()=>a[33]||(a[33]=[s("查看")]))),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])),[[l,he.value]]),i(d(x),{"current-page":_e.pageNum,"onUpdate:currentPage":a[1]||(a[1]=e=>_e.pageNum=e),"page-size":_e.pageSize,"onUpdate:pageSize":a[2]||(a[2]=e=>_e.pageSize=e),"page-sizes":[10,20,50,100],total:ce.value,layout:"total, sizes, prev, pager, next",onSizeChange:Ie,onCurrentChange:Le,class:"pagination",small:""},null,8,["current-page","page-size","total"])])])),_:1})])),_:1}),i(d(g),{span:12},{default:u((()=>[i(d(_),{class:"box-card operation-permission-card"},{header:u((()=>[p("div",te,[a[35]||(a[35]=p("span",null,"操作权限配置",-1)),i(d(b),{type:"primary",icon:d(h),onClick:Be},{default:u((()=>a[34]||(a[34]=[s(" 新增权限 ")]))),_:1},8,["icon"])])])),default:u((()=>[p("div",oe,[p("div",ie,[i(d(V),{modelValue:Te.value,"onUpdate:modelValue":a[3]||(a[3]=e=>Te.value=e),placeholder:"搜索权限...",class:"filter-input",onKeyup:n(He,["enter"]),clearable:"","suffix-icon":d(T)},{append:u((()=>[i(d(b),{icon:d(T),onClick:He},null,8,["icon"])])),_:1},8,["modelValue","suffix-icon"])]),c((r(),m(d(w),{data:ne.value,style:{width:"100%"},height:"400px","empty-text":"暂无数据"},{default:u((()=>[i(d(C),{label:"权限",prop:"permsName"},{default:u((({row:e})=>[p("div",null,f(e.permsName),1),p("div",ue,f(e.apiMethod)+" "+f(e.apiPath),1)])),_:1}),i(d(C),{label:"类型",prop:"permType",width:"100"},{default:u((({row:e})=>[s(f(e.permType||"功能权限"),1)])),_:1}),i(d(C),{label:"操作",width:"100",align:"right"},{default:u((({row:e})=>[i(d(b),{text:"",type:"primary",size:"small",onClick:a=>(async e=>{try{if(e.id){const a=await $(e.id);let l;console.log("获取操作权限详情API返回:",a),l=a&&200===a.code?a.data:a,ge.value=l,ve.value=!0}}catch(a){Z(a,"获取操作权限详情失败")}})(e)},{default:u((()=>a[36]||(a[36]=[s("查看")]))),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])),[[l,Ce.value]]),i(d(x),{"current-page":Ve.pageNum,"onUpdate:currentPage":a[4]||(a[4]=e=>Ve.pageNum=e),"page-size":Ve.pageSize,"onUpdate:pageSize":a[5]||(a[5]=e=>Ve.pageSize=e),"page-sizes":[10,20,50,100],total:me.value,layout:"total, sizes, prev, pager, next",onSizeChange:Qe,onCurrentChange:Ge,class:"pagination",small:""},null,8,["current-page","page-size","total"])])])),_:1})])),_:1})])),_:1}),i(d(S),{modelValue:fe.value,"onUpdate:modelValue":a[9]||(a[9]=e=>fe.value=e),title:"策略详情",width:"600px"},{footer:u((()=>[p("span",de,[i(d(b),{onClick:a[6]||(a[6]=e=>fe.value=!1)},{default:u((()=>a[37]||(a[37]=[s("关闭")]))),_:1}),i(d(b),{type:"danger",onClick:a[7]||(a[7]=e=>(async e=>{if(e&&e.id)try{await j.confirm(`确定要删除数据策略 "${e.policyName}" 吗？`,"确认删除",{type:"warning"});const a=await H(e.id);X(a,"数据策略删除成功","数据策略删除失败")&&(fe.value=!1,je())}catch(a){"cancel"!==a&&Z(a,"删除数据策略失败")}})(ye.value))},{default:u((()=>a[38]||(a[38]=[s("删除")]))),_:1}),i(d(b),{type:"primary",onClick:a[8]||(a[8]=e=>{var a;(a=ye.value)&&(xe.value=!0,Object.assign(ke,{id:a.id,policyName:a.policyName,policyCode:a.policyCode,conditionType:a.conditionType,priority:a.priority,effectTables:a.effectTables,policyDescription:a.policyDescription,conditionExpression:a.conditionExpression}),Ne.value=!0,fe.value=!1)})},{default:u((()=>a[39]||(a[39]=[s("编辑")]))),_:1})])])),default:u((()=>[ye.value?(r(),m(d(z),{key:0,column:1,border:"","label-align":"right"},{default:u((()=>[i(d(U),{label:"策略名称"},{default:u((()=>[s(f(ye.value.policyName),1)])),_:1}),i(d(U),{label:"策略编码"},{default:u((()=>[s(f(ye.value.policyCode),1)])),_:1}),i(d(U),{label:"条件类型"},{default:u((()=>[s(f(1===ye.value.conditionType?"SQL片段":"SpEL"),1)])),_:1}),i(d(U),{label:"优先级"},{default:u((()=>[s(f(ye.value.priority),1)])),_:1}),i(d(U),{label:"生效表"},{default:u((()=>[s(f(ye.value.effectTables),1)])),_:1}),i(d(U),{label:"策略描述"},{default:u((()=>[s(f(ye.value.policyDescription||"-"),1)])),_:1}),i(d(U),{label:"条件表达式"},{default:u((()=>[p("pre",null,[p("code",null,f(ye.value.conditionExpression),1)])])),_:1})])),_:1})):v("",!0)])),_:1},8,["modelValue"]),i(d(S),{modelValue:ve.value,"onUpdate:modelValue":a[13]||(a[13]=e=>ve.value=e),title:"操作权限详情",width:"600px"},{footer:u((()=>[p("span",re,[i(d(b),{onClick:a[10]||(a[10]=e=>ve.value=!1)},{default:u((()=>a[40]||(a[40]=[s("关闭")]))),_:1}),i(d(b),{type:"danger",onClick:a[11]||(a[11]=e=>(async e=>{if(e&&e.id)try{await j.confirm(`确定要删除操作权限 "${e.permsName}" 吗？`,"确认删除",{type:"warning"});const a=await F(e.id);X(a,"操作权限删除成功","操作权限删除失败")&&(ve.value=!1,Me())}catch(a){"cancel"!==a&&Z(a,"删除操作权限失败")}})(ge.value))},{default:u((()=>a[41]||(a[41]=[s("删除")]))),_:1}),i(d(b),{type:"primary",onClick:a[12]||(a[12]=e=>{var a;(a=ge.value)&&(Pe.value=!0,Object.assign(Ae,{id:a.id,permsName:a.permsName,permsCode:a.permsCode,permType:a.permType,apiMethod:a.apiMethod,apiPath:a.apiPath,permsDescription:a.permsDescription}),we.value=!0,ve.value=!1)})},{default:u((()=>a[42]||(a[42]=[s("编辑")]))),_:1})])])),default:u((()=>[ge.value?(r(),m(d(z),{key:0,column:1,border:"","label-align":"right"},{default:u((()=>[i(d(U),{label:"权限名称"},{default:u((()=>[s(f(ge.value.permsName),1)])),_:1}),i(d(U),{label:"权限编码"},{default:u((()=>[s(f(ge.value.permsCode),1)])),_:1}),i(d(U),{label:"权限类型"},{default:u((()=>[s(f(ge.value.permType),1)])),_:1}),i(d(U),{label:"请求方法"},{default:u((()=>[s(f(ge.value.apiMethod||"-"),1)])),_:1}),i(d(U),{label:"接口路径"},{default:u((()=>[s(f(ge.value.apiPath||"-"),1)])),_:1}),i(d(U),{label:"权限描述"},{default:u((()=>[s(f(ge.value.permsDescription||"-"),1)])),_:1}),i(d(U),{label:"创建时间"},{default:u((()=>[s(f(ge.value.createTime?d(R)(ge.value.createTime):"-"),1)])),_:1}),i(d(U),{label:"更新时间"},{default:u((()=>[s(f(ge.value.updateTime?d(R)(ge.value.updateTime):"-"),1)])),_:1})])),_:1})):v("",!0)])),_:1},8,["modelValue"]),i(d(S),{modelValue:Ne.value,"onUpdate:modelValue":a[22]||(a[22]=e=>Ne.value=e),title:xe.value?"编辑数据策略":"新增数据策略",width:"700px",onClose:Fe},{footer:u((()=>[p("span",pe,[i(d(b),{onClick:a[21]||(a[21]=e=>Ne.value=!1)},{default:u((()=>a[43]||(a[43]=[s("取消")]))),_:1}),i(d(b),{type:"primary",onClick:Ke},{default:u((()=>a[44]||(a[44]=[s("保存")]))),_:1})])])),default:u((()=>[i(d(k),{ref_key:"strategyFormRef",ref:Ue,model:ke,rules:De,"label-width":"100px"},{default:u((()=>[i(d(P),{gutter:20},{default:u((()=>[i(d(g),{span:12},{default:u((()=>[i(d(E),{label:"策略名称",prop:"policyName"},{default:u((()=>[i(d(V),{modelValue:ke.policyName,"onUpdate:modelValue":a[14]||(a[14]=e=>ke.policyName=e),placeholder:"请输入策略名称"},null,8,["modelValue"])])),_:1})])),_:1}),i(d(g),{span:12},{default:u((()=>[i(d(E),{label:"策略编码",prop:"policyCode"},{default:u((()=>[i(d(V),{modelValue:ke.policyCode,"onUpdate:modelValue":a[15]||(a[15]=e=>ke.policyCode=e),placeholder:"请输入策略编码",disabled:xe.value},null,8,["modelValue","disabled"])])),_:1})])),_:1})])),_:1}),i(d(P),{gutter:20},{default:u((()=>[i(d(g),{span:12},{default:u((()=>[i(d(E),{label:"条件类型",prop:"conditionType"},{default:u((()=>[i(d(A),{modelValue:ke.conditionType,"onUpdate:modelValue":a[16]||(a[16]=e=>ke.conditionType=e),placeholder:"请选择条件类型",style:{width:"100%"}},{default:u((()=>[i(d(D),{label:"SQL片段",value:1}),i(d(D),{label:"SpEL表达式",value:2})])),_:1},8,["modelValue"])])),_:1})])),_:1}),i(d(g),{span:12},{default:u((()=>[i(d(E),{label:"优先级",prop:"priority"},{default:u((()=>[i(d(O),{modelValue:ke.priority,"onUpdate:modelValue":a[17]||(a[17]=e=>ke.priority=e),min:0,max:100,"show-input":""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),i(d(E),{label:"生效表",prop:"effectTables"},{default:u((()=>[i(d(V),{modelValue:ke.effectTables,"onUpdate:modelValue":a[18]||(a[18]=e=>ke.effectTables=e),placeholder:"请输入生效的表名，多个用逗号分隔"},null,8,["modelValue"])])),_:1}),i(d(E),{label:"策略描述",prop:"policyDescription"},{default:u((()=>[i(d(V),{type:"textarea",modelValue:ke.policyDescription,"onUpdate:modelValue":a[19]||(a[19]=e=>ke.policyDescription=e),placeholder:"请输入策略描述"},null,8,["modelValue"])])),_:1}),i(d(E),{label:"条件表达式",prop:"conditionExpression"},{default:u((()=>[i(d(V),{type:"textarea",modelValue:ke.conditionExpression,"onUpdate:modelValue":a[20]||(a[20]=e=>ke.conditionExpression=e),placeholder:"请输入条件表达式 (SQL或SpEL)",rows:4},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"]),i(d(S),{modelValue:we.value,"onUpdate:modelValue":a[30]||(a[30]=e=>we.value=e),title:Pe.value?"编辑操作权限":"新增操作权限",width:"700px",onClose:Ze},{footer:u((()=>[p("span",se,[i(d(b),{onClick:a[29]||(a[29]=e=>we.value=!1)},{default:u((()=>a[45]||(a[45]=[s("取消")]))),_:1}),i(d(b),{type:"primary",onClick:Re},{default:u((()=>a[46]||(a[46]=[s("保存")]))),_:1})])])),default:u((()=>[i(d(k),{ref_key:"opPermFormRef",ref:ze,model:Ae,rules:Oe,"label-width":"100px"},{default:u((()=>[i(d(P),{gutter:20},{default:u((()=>[i(d(g),{span:12},{default:u((()=>[i(d(E),{label:"权限名称",prop:"permsName"},{default:u((()=>[i(d(V),{modelValue:Ae.permsName,"onUpdate:modelValue":a[23]||(a[23]=e=>Ae.permsName=e),placeholder:"请输入权限名称"},null,8,["modelValue"])])),_:1})])),_:1}),i(d(g),{span:12},{default:u((()=>[i(d(E),{label:"权限编码",prop:"permsCode"},{default:u((()=>[i(d(V),{modelValue:Ae.permsCode,"onUpdate:modelValue":a[24]||(a[24]=e=>Ae.permsCode=e),placeholder:"请输入权限编码 (如: user:view)",disabled:Pe.value},null,8,["modelValue","disabled"])])),_:1})])),_:1})])),_:1}),i(d(P),{gutter:20},{default:u((()=>[i(d(g),{span:12},{default:u((()=>[i(d(E),{label:"权限类型",prop:"permType"},{default:u((()=>[i(d(A),{modelValue:Ae.permType,"onUpdate:modelValue":a[25]||(a[25]=e=>Ae.permType=e),placeholder:"请选择权限类型",style:{width:"100%"}},{default:u((()=>[i(d(D),{label:"API",value:"API"}),i(d(D),{label:"BUTTON",value:"BUTTON"})])),_:1},8,["modelValue"])])),_:1})])),_:1}),i(d(g),{span:12},{default:u((()=>[i(d(E),{label:"请求方法",prop:"apiMethod"},{default:u((()=>[i(d(A),{modelValue:Ae.apiMethod,"onUpdate:modelValue":a[26]||(a[26]=e=>Ae.apiMethod=e),placeholder:"请选择HTTP方法",style:{width:"100%"},clearable:""},{default:u((()=>[i(d(D),{label:"全部请求方法",value:"*"}),i(d(D),{label:"GET",value:"GET"}),i(d(D),{label:"POST",value:"POST"}),i(d(D),{label:"PUT",value:"PUT"}),i(d(D),{label:"DELETE",value:"DELETE"}),i(d(D),{label:"PATCH",value:"PATCH"}),i(d(D),{label:"OPTIONS",value:"OPTIONS"}),i(d(D),{label:"HEAD",value:"HEAD"})])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1}),i(d(E),{label:"接口路径",prop:"apiPath"},{default:u((()=>[i(d(V),{modelValue:Ae.apiPath,"onUpdate:modelValue":a[27]||(a[27]=e=>Ae.apiPath=e),placeholder:"请输入接口路径 (Ant风格, 如: /api/users/**)"},null,8,["modelValue"])])),_:1}),i(d(E),{label:"权限描述",prop:"permsDescription"},{default:u((()=>[i(d(V),{type:"textarea",modelValue:Ae.permsDescription,"onUpdate:modelValue":a[28]||(a[28]=e=>Ae.permsDescription=e),placeholder:"请输入权限描述"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-8aaf1851"]]);export{ne as default};
