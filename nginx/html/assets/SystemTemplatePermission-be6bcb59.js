import{P as e}from"./PageHeader-6f000ffa.js";import{ab as t,aa as o,b as a,Z as n,_ as l,d as r,ad as i,Q as s,T as d,a6 as c,a3 as u,K as p,L as m,G as v,V as f,P as g,E as h,v as y,ae as b,a9 as w,J as I,a5 as S,af as _,H as T,ag as D,X as E,w as A,ah as C,i as N,a0 as x,Y as V,ai as k,$ as P,aj as O,e as M,D as B,C as $,ak as j,a1 as R,O as X}from"./elementPlus-e3fc6f82.js";import{x as Y,r as L,k as U,z as F,P as z,H,u as q,y as W,O as G,a4 as K,G as Z,c as J,h as Q,L as ee,M as te,A as oe,I as ae,K as ne,X as le,V as re,C as ie,n as se}from"./vue-4e979bb7.js";import{_ as de}from"./index-08374d78.js";import{s as ce}from"./request-a996bc5b.js";import{b as ue,f as pe,a as me,c as ve}from"./permission-0fa55096.js";import{h as fe}from"./errorHandler-e80e1e70.js";const ge={class:"system-template-type-selector mb-4"},he=de(Y({__name:"SystemTemplateTypeSelector",props:{activeTemplateType:{type:String,required:!0}},emits:["update:activeTemplateType","type-selected"],setup(e,{emit:a}){const n=L([{type:"platform",name:"平台超级租户模板",apiType:1,templateCode:"SYS_PLATFORM_DEFAULT",description:"平台超级管理员使用的权限模板"},{type:"enterprise",name:"标准企业模板套件",apiType:2,templateCode:"SYS_ENT_DEFAULT",description:"新企业租户默认分配的权限模板"},{type:"agent",name:"标准代理所模板套件",apiType:3,templateCode:"SYS_AGENT_DEFAULT",description:"新代理所租户默认分配的权限模板"}]),l=e,r=a,i=e=>{const t=e;r("update:activeTemplateType",t);const o=n.value.find((e=>e.type===t));o&&r("type-selected",o)};return U((()=>{const e=n.value.find((e=>e.type===l.activeTemplateType));e&&r("type-selected",e)})),(a,l)=>(W(),F("div",ge,[z(q(o),{"model-value":e.activeTemplateType,type:"card",onTabChange:i},{default:H((()=>[(W(!0),F(G,null,K(n.value,(e=>(W(),Z(q(t),{key:e.type,label:e.name,name:e.type},null,8,["label","name"])))),128))])),_:1},8,["model-value"])]))}}),[["__scopeId","data-v-6777332d"]]);function ye(e){return ce({url:`/perm/api/perm/templates/type/${e}`,method:"get"})}function be(e){return ce({url:"/perm/api/perm/versions/page",method:"post",data:e})}function we(e){return ce({url:`/perm/api/perm/versions/default/${e}`,method:"get"})}function Ie(e){const t=String(e);return console.log(`调用getModulesByVersion - 原始ID: ${t}, 类型: ${typeof t}, 长度: ${t.length}`),ce({url:`/perm/api/perm/modules/version/${t}`,method:"get",headers:{"X-Preserve-IDs":"true"}})}function Se(e){return ce({url:"/perm/api/perm/nodes",method:"put",data:e})}const _e={class:"system-template-version-config mb-6"},Te={class:"flex justify-between items-center"},De={key:0,class:"text-center py-2 text-gray-400"},Ee={key:2,class:"text-center py-2 text-gray-400"},Ae=de(Y({__name:"SystemTemplateVersionConfig",props:{templateInfo:{type:Object,required:!0},currentVersion:{type:String,default:""}},emits:["update:currentVersion","version-changed","save-base-info"],setup(e,{emit:t}){const o=e,I=t,S=L([]),_=L(!1),T=L(""),D=L(!1),E=L(null),A=L(1),C=L(20),N=L(0),x=L(!1),V=L(null),k=J({get:()=>o.currentVersion||"",set:e=>{I("update:currentVersion",e),I("version-changed",e)}}),P=J((()=>{if(o.currentVersion&&S.value.length>0){const e=S.value.find((e=>e.version===o.currentVersion));if(e)return e}if(S.value.length>0){const e=S.value.find((e=>1===e.isDefault));if(e)return e}return null})),O=J({get:()=>{var e;return 1===(null==(e=P.value)?void 0:e.isDefault)},set:e=>{}}),M=async(e=!1)=>{if(E.value){e||(A.value=1,S.value=[]),_.value=!0;try{console.log("获取版本列表 - 请求参数:",{templateId:E.value,pageNum:A.value,pageSize:C.value});const t=await be({templateId:E.value,pageNum:A.value,pageSize:C.value});if(console.log("获取版本列表 - 响应:",t),t&&"object"==typeof t){const a=t;let n=[],l=0;if(a.records&&Array.isArray(a.records)?(n=a.records,l=a.total||0):a.data&&"object"==typeof a.data&&(a.data.records&&Array.isArray(a.data.records)?(n=a.data.records,l=a.data.total||0):Array.isArray(a.data)&&(n=a.data,l=a.data.length)),S.value=e?[...S.value,...n]:n,N.value=l,x.value=S.value.length<N.value,console.log("获取到的版本列表:",S.value),console.log("版本总数:",N.value),console.log("是否有更多:",x.value),!o.currentVersion||!S.value.some((e=>e.version===o.currentVersion))){const e=S.value.find((e=>1===e.isDefault)),t=e?e.version:S.value.length>0?S.value[0].version:"";console.log("自动选择版本:",t,e),t&&(I("update:currentVersion",t),I("version-changed",t))}}else console.warn("获取版本列表: 服务器返回数据格式不符合预期",t)}catch(t){console.error("获取版本列表失败:",t),h.error("获取版本列表失败")}finally{_.value=!1}}else console.log("fetchVersions: 模板ID不存在，无法加载版本")},B=()=>{!_.value&&x.value&&(A.value+=1,M(!0))},$=e=>{if(_.value||!x.value)return;const{scrollTop:t,clientHeight:o,scrollHeight:a}=e.target;t+o>=a-20&&B()};Q((()=>o.templateInfo),(e=>{e&&(async()=>{if(o.templateInfo)try{const t=await ye(o.templateInfo.apiType);if(console.log("获取到的模板详情:",t),t){if("object"==typeof t&&"id"in t?(E.value="number"==typeof t.id?t.id.toString():t.id,console.log("设置模板ID (直接):",E.value)):t.data&&"object"==typeof t.data&&"id"in t.data&&(E.value="number"==typeof t.data.id?t.data.id.toString():t.data.id,console.log("设置模板ID (data):",E.value)),E.value)try{const e=await we(E.value);if(console.log("获取默认版本响应:",e),e&&e.data){const t=e.data;console.log("找到默认版本:",t),o.currentVersion||(I("update:currentVersion",t.version),I("version-changed",t.version))}}catch(e){console.warn("获取默认版本失败，将尝试从版本列表中查找:",e)}await M()}}catch(e){console.error("获取模板详情失败:",e),h.error("获取模板详情失败")}})()}),{immediate:!0}),Q((()=>k.value),(e=>{console.log("版本选择值变化:",e),e!==o.currentVersion&&(I("update:currentVersion",e),I("version-changed",e))})),Q((()=>o.currentVersion),(e=>{e&&!k.value&&(console.log("外部更新了版本值:",e),0!==S.value.length&&S.value.some((t=>t.version===e))||(console.log("需要重新加载版本列表以显示当前版本"),E.value&&M()))}),{immediate:!0});const j=()=>{I("update:currentVersion",""),I("version-changed","")},R=()=>{var e,t;console.log("打开编辑对话框，当前模板信息:",o.templateInfo),T.value=(null==(e=o.templateInfo)?void 0:e.baseDescription)||(null==(t=o.templateInfo)?void 0:t.description)||"",console.log("设置初始描述值:",T.value),D.value=!0},X=async()=>{var e;console.log("开始保存描述 - 检查模板信息",{templateInfo:o.templateInfo,templateId:E.value});let t=E.value||(null==(e=o.templateInfo)?void 0:e.id)||(o.templateInfo&&"object"==typeof o.templateInfo&&"id"in o.templateInfo?o.templateInfo.id:null);if(null!==t&&(t=String(t)),!t)return console.error("无法保存描述: 模板ID不存在",{templateInfo:o.templateInfo,templateId:E.value,effectiveTemplateId:t}),void h.error("模板信息不完整，无法保存描述");try{const e={id:t,templateCode:o.templateInfo.templateCode,templateType:o.templateInfo.apiType,baseDescription:T.value};console.log("保存模板描述 - 请求参数:",e),console.log("请求URL:","/perm/api/perm/templates"),console.log("请求方法:","PUT");const n=await(a=e,ce({url:"/perm/api/perm/templates",method:"put",data:a}));console.log("模板描述更新响应:",n),I("save-base-info",{...o.templateInfo,description:T.value,baseDescription:T.value}),h.success("模板描述更新成功"),D.value=!1}catch(n){console.error("更新模板描述失败:",n),h.error(`更新模板描述失败: ${(null==n?void 0:n.message)||"未知错误"}`)}var a},Y=async()=>{var e;console.log("开始创建版本 - 检查模板信息",{templateInfo:o.templateInfo,templateId:E.value});let t=E.value||(null==(e=o.templateInfo)?void 0:e.id)||(o.templateInfo&&"object"==typeof o.templateInfo&&"id"in o.templateInfo?o.templateInfo.id:null);if(null!==t&&(t=String(t)),!t)return console.error("无法创建版本: 模板ID不存在",{templateInfo:o.templateInfo,templateId:E.value,effectiveTemplateId:t}),void h.error("模板信息不完整，无法创建版本");console.log("确认模板ID有效:",t);try{const e=(await y.prompt("请输入新版本号 (例如: 1.0.1)","新增版本",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/^\S+$/,inputErrorMessage:"版本号不能为空",distinguishCancelAndClose:!0})).value;if(console.log("用户输入的版本号:",e),!e||""===e.trim())return void console.log("用户输入为空，不创建版本");if(S.value.some((t=>t.version===e)))return console.warn("版本号已存在:",e),void h.warning("版本号已存在，请使用唯一的版本号");const l={templateId:t,version:e,isDefault:0,versionDescription:`基于 ${o.currentVersion||"最新配置"} 创建的新版本`};console.log("创建版本请求参数:",l),console.log("请求URL:","/perm/api/perm/versions"),console.log("请求方法:","POST");try{const t=await(a=l,ce({url:"/perm/api/perm/versions",method:"post",data:a}));console.log("创建版本响应:",t),await M(),I("update:currentVersion",e),I("version-changed",e),h.success(`版本 ${e} 创建成功`)}catch(n){console.error("API调用失败:",n),h.error(`创建版本失败: ${n.message||"请求异常"}`)}}catch(l){console.log("对话框操作:",l),"cancel"!==l&&"close"!==l&&(console.error("创建版本过程异常:",l),h.error("创建版本失败"))}var a},le=async()=>{var e;if(o.currentVersion&&P.value&&P.value.id)try{await y.confirm(`确定要删除版本 "${o.currentVersion}" 吗？此操作不可恢复。`,"确认删除版本",{type:"warning"});const t=String(P.value.id);await(e=t,ce({url:`/perm/api/perm/versions/${e}`,method:"delete"})),h.success(`版本 ${o.currentVersion} 已删除`),I("update:currentVersion",""),I("version-changed",""),await M()}catch(t){"cancel"!==t&&(console.error("删除版本失败:",t),h.error("删除版本失败"))}},re=async()=>{if(!P.value||!E.value)return;const e=P.value.id;if(!e)return;const t=String(e),o=1===P.value.isDefault?0:1;try{await(a={id:t,version:P.value.version,isDefault:o,versionDescription:P.value.versionDescription},ce({url:"/perm/api/perm/versions",method:"put",data:a})),await M(),h.success(`版本 ${P.value.version} 已${1===o?"设为":"取消"}默认`)}catch(n){console.error("设置默认版本失败:",n),h.error("设置默认版本失败")}var a};return U((()=>{o.templateInfo||0!==S.value.length||console.warn("SystemTemplateVersionConfig: templateInfo not available on mount, or versions already loaded.")})),(t,o)=>{const h=b,y=w;return W(),F("div",_e,[z(q(l),{title:`模板基础信息: ${e.templateInfo?e.templateInfo.name:""}`,column:1,border:""},{extra:H((()=>[z(q(a),{type:"primary",link:"",onClick:R},{default:H((()=>o[5]||(o[5]=[ee("编辑描述")]))),_:1})])),default:H((()=>[z(q(n),{label:"模板编码"},{default:H((()=>[ee(te(e.templateInfo?e.templateInfo.templateCode:""),1)])),_:1}),z(q(n),{label:"当前描述"},{default:H((()=>[ee(te(e.templateInfo?e.templateInfo.description:""),1)])),_:1})])),_:1},8,["title"]),z(q(v),{shadow:"never",class:"mt-4 version-management-card"},{header:H((()=>[oe("div",Te,[o[7]||(o[7]=oe("span",null,"版本管理",-1)),oe("div",null,[z(q(r),{content:"选择后，新租户创建时将默认使用此版本的权限配置",placement:"top"},{default:H((()=>[z(q(i),{modelValue:O.value,"onUpdate:modelValue":o[0]||(o[0]=e=>O.value=e),label:"作为默认版本",class:"mr-4",onChange:re,disabled:!P.value||0===S.value.length},null,8,["modelValue","disabled"])])),_:1}),z(q(a),{icon:q(s),onClick:Y},{default:H((()=>o[6]||(o[6]=[ee("新增版本")]))),_:1},8,["icon"]),z(q(a),{type:"danger",plain:"",icon:q(d),onClick:le,disabled:!P.value||S.value.length<=1},{default:H((()=>[ee(" 删除当前版本 ("+te(e.currentVersion||"")+") ",1)])),_:1},8,["icon","disabled"])])])])),default:H((()=>[z(q(c),{inline:""},{default:H((()=>[z(q(u),{label:"选择配置版本"},{default:H((()=>[ae((W(),Z(q(m),{modelValue:k.value,"onUpdate:modelValue":o[1]||(o[1]=e=>k.value=e),placeholder:"选择版本",style:{width:"220px"},clearable:"",onClear:j},{dropdown:H((()=>[z(h,{onScroll:$,height:"200px",ref_key:"versionScrollbar",ref:V},{default:H((()=>[(W(!0),F(G,null,K(S.value,(e=>(W(),Z(q(p),{key:e.version,label:`${e.version}${1===e.isDefault?" (默认)":""} - ${e.versionDescription||"无描述"}`,value:e.version},null,8,["label","value"])))),128)),_.value?(W(),F("div",De,"加载中...")):ne("",!0),!_.value&&x.value?(W(),F("div",{key:1,class:"text-center py-2 text-gray-400 cursor-pointer",onClick:B},"加载更多")):ne("",!0),!_.value&&!x.value&&S.value.length>0?(W(),F("div",Ee,"已加载全部")):ne("",!0)])),_:1},512)])),default:H((()=>[(W(!0),F(G,null,K(S.value,(e=>(W(),Z(q(p),{key:e.version,label:`${e.version}${1===e.isDefault?" (默认)":""} - ${e.versionDescription||"无描述"}`,value:e.version},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])),[[y,_.value]])])),_:1})])),_:1})])),_:1}),z(q(g),{modelValue:D.value,"onUpdate:modelValue":o[4]||(o[4]=e=>D.value=e),title:"编辑模板描述",width:"500px","close-on-click-modal":!1},{footer:H((()=>[z(q(a),{onClick:o[3]||(o[3]=e=>D.value=!1)},{default:H((()=>o[8]||(o[8]=[ee("取消")]))),_:1}),z(q(a),{type:"primary",onClick:X},{default:H((()=>o[9]||(o[9]=[ee("保存")]))),_:1})])),default:H((()=>[z(q(c),{"label-width":"80px"},{default:H((()=>[z(q(u),{label:"描述"},{default:H((()=>[z(q(f),{type:"textarea",rows:3,modelValue:T.value,"onUpdate:modelValue":o[2]||(o[2]=e=>T.value=e),placeholder:"请输入模板描述"},null,8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-1e861cbc"]]),Ce=de(Y({__name:"ModuleFormDialog",props:{visible:{type:Boolean,required:!0},isEditing:{type:Boolean,default:!1},initialData:{type:Object,default:null},existingModules:{type:Array,default:()=>[]}},emits:["update:visible","submit"],setup(e,{emit:t}){const o=e,n=t,l=J({get:()=>o.visible,set:e=>n("update:visible",e)}),r=L(),i=L(!1),s=le({id:void 0,moduleName:"",moduleType:1,templateVersionId:void 0,sort:0}),d={moduleName:[{required:!0,message:"请输入模块名称",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],moduleType:[{required:!0,message:"请选择模块类型",trigger:"change"}],sort:[{required:!0,message:"请输入排序号",trigger:"blur"}]};Q((()=>o.initialData),(e=>{e?(s.id=e.id,s.moduleName=e.moduleName||"",s.moduleType=e.moduleType||1,s.templateVersionId=e.templateVersionId,s.sort=e.sort||0):(s.id=void 0,s.moduleName="",s.moduleType=1,s.templateVersionId=void 0,s.sort=0)}),{immediate:!0});const p=async()=>{r.value&&await r.value.validate((async e=>{if(e){i.value=!0;try{if(o.existingModules.some((e=>e.moduleName===s.moduleName&&e.id!==s.id)))return void h.warning("模块名称已存在，请使用其他名称");n("submit",{id:s.id,moduleName:s.moduleName,moduleType:s.moduleType,templateVersionId:s.templateVersionId,sort:s.sort})}finally{i.value=!1}}}))};return(t,o)=>(W(),Z(q(g),{title:e.isEditing?"编辑模块":"新增模块",modelValue:l.value,"onUpdate:modelValue":o[5]||(o[5]=e=>l.value=e),width:"500px","close-on-click-modal":!1,"destroy-on-close":""},{footer:H((()=>[z(q(a),{onClick:o[4]||(o[4]=e=>l.value=!1)},{default:H((()=>o[8]||(o[8]=[ee("取消")]))),_:1}),z(q(a),{type:"primary",loading:i.value,onClick:p},{default:H((()=>o[9]||(o[9]=[ee("确定")]))),_:1},8,["loading"])])),default:H((()=>[z(q(c),{ref_key:"formRef",ref:r,model:s,rules:d,"label-width":"100px",onSubmit:o[3]||(o[3]=re((()=>{}),["prevent"]))},{default:H((()=>[z(q(u),{label:"模块名称",prop:"moduleName"},{default:H((()=>[z(q(f),{modelValue:s.moduleName,"onUpdate:modelValue":o[0]||(o[0]=e=>s.moduleName=e),placeholder:"请输入模块名称"},null,8,["modelValue"])])),_:1}),z(q(u),{label:"模块类型",prop:"moduleType"},{default:H((()=>[z(q(I),{modelValue:s.moduleType,"onUpdate:modelValue":o[1]||(o[1]=e=>s.moduleType=e)},{default:H((()=>[z(q(S),{label:1},{default:H((()=>o[6]||(o[6]=[ee("功能权限模块")]))),_:1}),z(q(S),{label:2},{default:H((()=>o[7]||(o[7]=[ee("数据权限模块")]))),_:1})])),_:1},8,["modelValue"])])),_:1}),z(q(u),{label:"排序号",prop:"sort"},{default:H((()=>[z(q(_),{modelValue:s.sort,"onUpdate:modelValue":o[2]||(o[2]=e=>s.sort=e),min:0,max:999,placeholder:"数字越小排序越靠前"},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["title","modelValue"]))}}),[["__scopeId","data-v-36b091cc"]]),Ne={class:"el-select-dropdown__empty"},xe={key:0},Ve={key:1},ke={class:"el-select-dropdown__empty"},Pe={key:0},Oe={key:1},Me=de(Y({__name:"NodeFormDialog",props:{visible:{type:Boolean,required:!0},isEditing:{type:Boolean,default:!1},initialData:{type:Object,default:null},selectedModuleName:{type:String,default:""},allOperationPermissions:{type:Array,default:()=>[]},allDataPolicies:{type:Array,default:()=>[]}},emits:["update:visible","submit"],setup(e,{emit:t}){const o=e,n=t,l=J({get:()=>o.visible,set:e=>n("update:visible",e)}),r=L(),i=L(!1),s=L(!1),d=L(!1),v=L([]),y=L([]),b=le({id:void 0,nodeName:"",moduleId:void 0,nodeType:1,permType:0,permId:void 0,dataPolicyId:void 0,dataScope:1,isBasic:!1,nodeSort:0}),w=()=>{0===b.permType?(b.dataPolicyId=void 0,x()):(b.permId=void 0,V())},E=e=>{e&&x()},A=e=>{e&&V()},C=e=>{""===e?x():x(e)},N=e=>{""===e?V():V(e)},x=async e=>{s.value=!0;try{console.log("加载操作权限列表，关键字:",e);const o={pageNum:1,pageSize:100};e&&""!==e.trim()&&(o.permsName=e.trim());const a=await ue(o);console.log("操作权限加载响应:",a);let n=[];const l=a;if(l&&l.data&&Array.isArray(l.data.records))n=l.data.records;else if(Array.isArray(l))n=l;else if(l&&Array.isArray(l.records))n=l.records;else if(l&&"object"==typeof l)for(const e in l)if(Array.isArray(l[e])){n=l[e];break}if(n=n.map((e=>{const t={...e};return t.id&&"string"!=typeof t.id&&(t.id=String(t.id)),t})),v.value=n,console.log("操作权限选项:",v.value),b.permId&&!v.value.some((e=>String(e.id)===String(b.permId))))try{const e="string"==typeof b.permId?b.permId:String(b.permId),t=await pe(Number(e));if(console.log("操作权限详情响应:",t),t){const e=t,o=e.data||e;if(o&&o.id){const e={...o,id:String(o.id)};v.value=[e,...v.value.filter((e=>String(e.id)!==String(b.permId)))]}}}catch(t){console.error("获取操作权限详情失败:",t)}0!==n.length||e||h.info("未加载到操作权限数据，请检查接口")}catch(t){console.error("加载操作权限失败:",t),h.error("加载操作权限失败: "+(t instanceof Error?t.message:String(t)))}finally{s.value=!1}},V=async e=>{d.value=!0;try{console.log("加载数据策略列表，关键字:",e);const o={pageNum:1,pageSize:100};e&&""!==e.trim()&&(o.policyName=e.trim());const a=await me(o);console.log("数据策略加载响应:",a);let n=[];const l=a;if(l&&l.data&&Array.isArray(l.data.records))n=l.data.records;else if(Array.isArray(l))n=l;else if(l&&Array.isArray(l.records))n=l.records;else if(l&&"object"==typeof l)for(const e in l)if(Array.isArray(l[e])){n=l[e];break}if(n=n.map((e=>{const t={...e};return t.id&&"string"!=typeof t.id&&(t.id=String(t.id)),t})),y.value=n,console.log("数据策略选项:",y.value),b.dataPolicyId&&!y.value.some((e=>String(e.id)===String(b.dataPolicyId))))try{const e="string"==typeof b.dataPolicyId?b.dataPolicyId:String(b.dataPolicyId),t=await ve(Number(e));if(console.log("数据策略详情响应:",t),t){const e=t,o=e.data||e;if(o&&o.id){const e={...o,id:String(o.id)};y.value=[e,...y.value.filter((e=>String(e.id)!==String(b.dataPolicyId)))]}}}catch(t){console.error("获取数据策略详情失败:",t)}0!==n.length||e||h.info("未加载到数据策略数据，请检查接口")}catch(t){console.error("加载数据策略失败:",t),h.error("加载数据策略失败: "+(t instanceof Error?t.message:String(t)))}finally{d.value=!1}},k=J((()=>{const e={nodeName:[{required:!0,message:"请输入节点名称",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],nodeType:[{required:!0,message:"请选择节点类型",trigger:"change"}],permType:[{required:!0,message:"请选择权限类型",trigger:"change"}]};return 0===b.permType?{...e,permId:[{required:!0,message:"请选择操作权限",trigger:"change"}]}:{...e,dataPolicyId:[{required:!0,message:"请选择数据策略",trigger:"change"}]}}));Q((()=>o.initialData),(e=>{var t;e?(b.id=e.id,b.nodeName=e.nodeName||"",b.moduleId=e.moduleId,b.nodeType=e.nodeType||1,b.permType=e.permType||0,b.permId=e.permId,b.dataPolicyId=e.dataPolicyId,b.dataScope=e.dataScope||1,b.isBasic=1===e.isBasic,b.nodeSort=(null==(t=o.initialData)?void 0:t.nodeSort)||0,0===b.permType?x():V()):(b.id=void 0,b.nodeName="",b.moduleId=void 0,b.nodeType=1,b.permType=0,b.permId=void 0,b.dataPolicyId=void 0,b.dataScope=1,b.isBasic=!1,b.nodeSort=0,x())}),{immediate:!0}),Q((()=>o.visible),(e=>{e&&(0===b.permType?x():V())})),U((()=>{0===b.permType?x():V()}));const P=async()=>{r.value&&await r.value.validate((async e=>{if(e){i.value=!0;try{const e={nodeName:b.nodeName,nodeType:b.nodeType,permType:b.permType,isBasic:b.isBasic?1:0};o.isEditing?b.id&&(e.id=b.id):e.moduleId=b.moduleId,0===b.permType&&b.permId?(e.permId=b.permId,e.dataPolicyId=void 0):1===b.permType&&b.dataPolicyId&&(e.dataPolicyId=b.dataPolicyId,e.permId=void 0),3===b.nodeType&&b.dataScope&&(e.dataScope=b.dataScope),console.log(`准备${o.isEditing?"更新":"创建"}节点:`,e),n("submit",e)}finally{i.value=!1}}}))};return(t,o)=>(W(),Z(q(g),{title:e.isEditing?"编辑节点":"新增节点",modelValue:l.value,"onUpdate:modelValue":o[10]||(o[10]=e=>l.value=e),width:"600px","close-on-click-modal":!1,"destroy-on-close":""},{footer:H((()=>[z(q(a),{onClick:o[9]||(o[9]=e=>l.value=!1)},{default:H((()=>o[13]||(o[13]=[ee("取消")]))),_:1}),z(q(a),{type:"primary",loading:i.value,onClick:P},{default:H((()=>o[14]||(o[14]=[ee("确定")]))),_:1},8,["loading"])])),default:H((()=>[z(q(c),{ref_key:"formRef",ref:r,model:b,rules:k.value,"label-width":"120px",onSubmit:o[8]||(o[8]=re((()=>{}),["prevent"]))},{default:H((()=>[z(q(u),{label:"所属模块"},{default:H((()=>[z(q(T),null,{default:H((()=>[ee(te(e.selectedModuleName),1)])),_:1})])),_:1}),z(q(u),{label:"节点名称",prop:"nodeName"},{default:H((()=>[z(q(f),{modelValue:b.nodeName,"onUpdate:modelValue":o[0]||(o[0]=e=>b.nodeName=e),placeholder:"请输入节点名称"},null,8,["modelValue"])])),_:1}),z(q(u),{label:"节点类型",prop:"nodeType"},{default:H((()=>[z(q(m),{modelValue:b.nodeType,"onUpdate:modelValue":o[1]||(o[1]=e=>b.nodeType=e),placeholder:"请选择节点类型",style:{width:"100%"}},{default:H((()=>[z(q(p),{label:"菜单项",value:1}),z(q(p),{label:"操作按钮",value:2}),z(q(p),{label:"数据字段",value:3})])),_:1},8,["modelValue"])])),_:1}),z(q(u),{label:"权限类型",prop:"permType"},{default:H((()=>[z(q(I),{modelValue:b.permType,"onUpdate:modelValue":o[2]||(o[2]=e=>b.permType=e),onChange:w},{default:H((()=>[z(q(S),{label:0},{default:H((()=>o[11]||(o[11]=[ee("操作权限")]))),_:1}),z(q(S),{label:1},{default:H((()=>o[12]||(o[12]=[ee("数据权限")]))),_:1})])),_:1},8,["modelValue"])])),_:1}),0===b.permType?(W(),Z(q(u),{key:0,label:"选择操作权限",prop:"permId"},{default:H((()=>[z(q(m),{modelValue:b.permId,"onUpdate:modelValue":o[3]||(o[3]=e=>b.permId=e),filterable:"",remote:"","reserve-keyword":"","remote-method":C,loading:s.value,placeholder:"请输入权限名称搜索",style:{width:"100%"},clearable:"",onVisibleChange:E},{empty:H((()=>[oe("div",Ne,[s.value?(W(),F("span",xe,"正在加载数据...")):(W(),F("span",Ve,"没有找到匹配的操作权限"))])])),default:H((()=>[(W(!0),F(G,null,K(v.value,(e=>(W(),Z(q(p),{key:String(e.id),label:e.permsName+" ("+e.permsCode+")",value:String(e.id)},null,8,["label","value"])))),128))])),_:1},8,["modelValue","loading"])])),_:1})):ne("",!0),1===b.permType?(W(),Z(q(u),{key:1,label:"选择数据策略",prop:"dataPolicyId"},{default:H((()=>[z(q(m),{modelValue:b.dataPolicyId,"onUpdate:modelValue":o[4]||(o[4]=e=>b.dataPolicyId=e),filterable:"",remote:"","reserve-keyword":"","remote-method":N,loading:d.value,placeholder:"请输入策略名称搜索",style:{width:"100%"},clearable:"",onVisibleChange:A},{empty:H((()=>[oe("div",ke,[d.value?(W(),F("span",Pe,"正在加载数据...")):(W(),F("span",Oe,"没有找到匹配的数据策略"))])])),default:H((()=>[(W(!0),F(G,null,K(y.value,(e=>(W(),Z(q(p),{key:String(e.id),label:e.policyName+" ("+e.policyCode+")",value:String(e.id)},null,8,["label","value"])))),128))])),_:1},8,["modelValue","loading"])])),_:1})):ne("",!0),3===b.nodeType?(W(),Z(q(u),{key:2,label:"数据范围",prop:"dataScope"},{default:H((()=>[z(q(m),{modelValue:b.dataScope,"onUpdate:modelValue":o[5]||(o[5]=e=>b.dataScope=e),placeholder:"请选择数据范围",style:{width:"100%"}},{default:H((()=>[z(q(p),{label:"查看权限",value:1}),z(q(p),{label:"编辑权限",value:2})])),_:1},8,["modelValue"])])),_:1})):ne("",!0),z(q(u),{label:"是否基础权限"},{default:H((()=>[z(q(D),{modelValue:b.isBasic,"onUpdate:modelValue":o[6]||(o[6]=e=>b.isBasic=e),"active-text":"是","inactive-text":"否"},null,8,["modelValue"])])),_:1}),z(q(u),{label:"排序号"},{default:H((()=>[z(q(_),{modelValue:b.nodeSort,"onUpdate:modelValue":o[7]||(o[7]=e=>b.nodeSort=e),min:0,max:999,placeholder:"数字越小排序越靠前"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])),_:1},8,["title","modelValue"]))}}),[["__scopeId","data-v-334a4d3c"]]);
/**!
 * Sortable 1.15.6
 * @author	RubaXa   <trash@rubaxa.org>
 * @author	owenm    <owen23355@gmail.com>
 * @license MIT
 */
function Be(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,a)}return o}function $e(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?Be(Object(o),!0).forEach((function(t){Re(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):Be(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function je(e){return(je="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Re(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function Xe(){return Xe=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(e[a]=o[a])}return e},Xe.apply(this,arguments)}function Ye(e,t){if(null==e)return{};var o,a,n=function(e,t){if(null==e)return{};var o,a,n={},l=Object.keys(e);for(a=0;a<l.length;a++)o=l[a],t.indexOf(o)>=0||(n[o]=e[o]);return n}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)o=l[a],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}function Le(e){if("undefined"!=typeof window&&window.navigator)return!!navigator.userAgent.match(e)}var Ue=Le(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i),Fe=Le(/Edge/i),ze=Le(/firefox/i),He=Le(/safari/i)&&!Le(/chrome/i)&&!Le(/android/i),qe=Le(/iP(ad|od|hone)/i),We=Le(/chrome/i)&&Le(/android/i),Ge={capture:!1,passive:!1};function Ke(e,t,o){e.addEventListener(t,o,!Ue&&Ge)}function Ze(e,t,o){e.removeEventListener(t,o,!Ue&&Ge)}function Je(e,t){if(t){if(">"===t[0]&&(t=t.substring(1)),e)try{if(e.matches)return e.matches(t);if(e.msMatchesSelector)return e.msMatchesSelector(t);if(e.webkitMatchesSelector)return e.webkitMatchesSelector(t)}catch(o){return!1}return!1}}function Qe(e){return e.host&&e!==document&&e.host.nodeType?e.host:e.parentNode}function et(e,t,o,a){if(e){o=o||document;do{if(null!=t&&(">"===t[0]?e.parentNode===o&&Je(e,t):Je(e,t))||a&&e===o)return e;if(e===o)break}while(e=Qe(e))}return null}var tt,ot=/\s+/g;function at(e,t,o){if(e&&t)if(e.classList)e.classList[o?"add":"remove"](t);else{var a=(" "+e.className+" ").replace(ot," ").replace(" "+t+" "," ");e.className=(a+(o?" "+t:"")).replace(ot," ")}}function nt(e,t,o){var a=e&&e.style;if(a){if(void 0===o)return document.defaultView&&document.defaultView.getComputedStyle?o=document.defaultView.getComputedStyle(e,""):e.currentStyle&&(o=e.currentStyle),void 0===t?o:o[t];t in a||-1!==t.indexOf("webkit")||(t="-webkit-"+t),a[t]=o+("string"==typeof o?"":"px")}}function lt(e,t){var o="";if("string"==typeof e)o=e;else do{var a=nt(e,"transform");a&&"none"!==a&&(o=a+" "+o)}while(!t&&(e=e.parentNode));var n=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return n&&new n(o)}function rt(e,t,o){if(e){var a=e.getElementsByTagName(t),n=0,l=a.length;if(o)for(;n<l;n++)o(a[n],n);return a}return[]}function it(){var e=document.scrollingElement;return e||document.documentElement}function st(e,t,o,a,n){if(e.getBoundingClientRect||e===window){var l,r,i,s,d,c,u;if(e!==window&&e.parentNode&&e!==it()?(r=(l=e.getBoundingClientRect()).top,i=l.left,s=l.bottom,d=l.right,c=l.height,u=l.width):(r=0,i=0,s=window.innerHeight,d=window.innerWidth,c=window.innerHeight,u=window.innerWidth),(t||o)&&e!==window&&(n=n||e.parentNode,!Ue))do{if(n&&n.getBoundingClientRect&&("none"!==nt(n,"transform")||o&&"static"!==nt(n,"position"))){var p=n.getBoundingClientRect();r-=p.top+parseInt(nt(n,"border-top-width")),i-=p.left+parseInt(nt(n,"border-left-width")),s=r+l.height,d=i+l.width;break}}while(n=n.parentNode);if(a&&e!==window){var m=lt(n||e),v=m&&m.a,f=m&&m.d;m&&(s=(r/=f)+(c/=f),d=(i/=v)+(u/=v))}return{top:r,left:i,bottom:s,right:d,width:u,height:c}}}function dt(e,t,o){for(var a=vt(e,!0),n=st(e)[t];a;){var l=st(a)[o];if(!("top"===o||"left"===o?n>=l:n<=l))return a;if(a===it())break;a=vt(a,!1)}return!1}function ct(e,t,o,a){for(var n=0,l=0,r=e.children;l<r.length;){if("none"!==r[l].style.display&&r[l]!==bo.ghost&&(a||r[l]!==bo.dragged)&&et(r[l],o.draggable,e,!1)){if(n===t)return r[l];n++}l++}return null}function ut(e,t){for(var o=e.lastElementChild;o&&(o===bo.ghost||"none"===nt(o,"display")||t&&!Je(o,t));)o=o.previousElementSibling;return o||null}function pt(e,t){var o=0;if(!e||!e.parentNode)return-1;for(;e=e.previousElementSibling;)"TEMPLATE"===e.nodeName.toUpperCase()||e===bo.clone||t&&!Je(e,t)||o++;return o}function mt(e){var t=0,o=0,a=it();if(e)do{var n=lt(e),l=n.a,r=n.d;t+=e.scrollLeft*l,o+=e.scrollTop*r}while(e!==a&&(e=e.parentNode));return[t,o]}function vt(e,t){if(!e||!e.getBoundingClientRect)return it();var o=e,a=!1;do{if(o.clientWidth<o.scrollWidth||o.clientHeight<o.scrollHeight){var n=nt(o);if(o.clientWidth<o.scrollWidth&&("auto"==n.overflowX||"scroll"==n.overflowX)||o.clientHeight<o.scrollHeight&&("auto"==n.overflowY||"scroll"==n.overflowY)){if(!o.getBoundingClientRect||o===document.body)return it();if(a||t)return o;a=!0}}}while(o=o.parentNode);return it()}function ft(e,t){return Math.round(e.top)===Math.round(t.top)&&Math.round(e.left)===Math.round(t.left)&&Math.round(e.height)===Math.round(t.height)&&Math.round(e.width)===Math.round(t.width)}function gt(e,t){return function(){if(!tt){var o=arguments;1===o.length?e.call(this,o[0]):e.apply(this,o),tt=setTimeout((function(){tt=void 0}),t)}}}function ht(e,t,o){e.scrollLeft+=t,e.scrollTop+=o}function yt(e){var t=window.Polymer,o=window.jQuery||window.Zepto;return t&&t.dom?t.dom(e).cloneNode(!0):o?o(e).clone(!0)[0]:e.cloneNode(!0)}function bt(e,t,o){var a={};return Array.from(e.children).forEach((function(n){var l,r,i,s;if(et(n,t.draggable,e,!1)&&!n.animated&&n!==o){var d=st(n);a.left=Math.min(null!==(l=a.left)&&void 0!==l?l:1/0,d.left),a.top=Math.min(null!==(r=a.top)&&void 0!==r?r:1/0,d.top),a.right=Math.max(null!==(i=a.right)&&void 0!==i?i:-1/0,d.right),a.bottom=Math.max(null!==(s=a.bottom)&&void 0!==s?s:-1/0,d.bottom)}})),a.width=a.right-a.left,a.height=a.bottom-a.top,a.x=a.left,a.y=a.top,a}var wt="Sortable"+(new Date).getTime();function It(){var e,t=[];return{captureAnimationState:function(){(t=[],this.options.animation)&&[].slice.call(this.el.children).forEach((function(e){if("none"!==nt(e,"display")&&e!==bo.ghost){t.push({target:e,rect:st(e)});var o=$e({},t[t.length-1].rect);if(e.thisAnimationDuration){var a=lt(e,!0);a&&(o.top-=a.f,o.left-=a.e)}e.fromRect=o}}))},addAnimationState:function(e){t.push(e)},removeAnimationState:function(e){t.splice(function(e,t){for(var o in e)if(e.hasOwnProperty(o))for(var a in t)if(t.hasOwnProperty(a)&&t[a]===e[o][a])return Number(o);return-1}(t,{target:e}),1)},animateAll:function(o){var a=this;if(!this.options.animation)return clearTimeout(e),void("function"==typeof o&&o());var n=!1,l=0;t.forEach((function(e){var t=0,o=e.target,r=o.fromRect,i=st(o),s=o.prevFromRect,d=o.prevToRect,c=e.rect,u=lt(o,!0);u&&(i.top-=u.f,i.left-=u.e),o.toRect=i,o.thisAnimationDuration&&ft(s,i)&&!ft(r,i)&&(c.top-i.top)/(c.left-i.left)===(r.top-i.top)/(r.left-i.left)&&(t=function(e,t,o,a){return Math.sqrt(Math.pow(t.top-e.top,2)+Math.pow(t.left-e.left,2))/Math.sqrt(Math.pow(t.top-o.top,2)+Math.pow(t.left-o.left,2))*a.animation}(c,s,d,a.options)),ft(i,r)||(o.prevFromRect=r,o.prevToRect=i,t||(t=a.options.animation),a.animate(o,c,i,t)),t&&(n=!0,l=Math.max(l,t),clearTimeout(o.animationResetTimer),o.animationResetTimer=setTimeout((function(){o.animationTime=0,o.prevFromRect=null,o.fromRect=null,o.prevToRect=null,o.thisAnimationDuration=null}),t),o.thisAnimationDuration=t)})),clearTimeout(e),n?e=setTimeout((function(){"function"==typeof o&&o()}),l):"function"==typeof o&&o(),t=[]},animate:function(e,t,o,a){if(a){nt(e,"transition",""),nt(e,"transform","");var n=lt(this.el),l=n&&n.a,r=n&&n.d,i=(t.left-o.left)/(l||1),s=(t.top-o.top)/(r||1);e.animatingX=!!i,e.animatingY=!!s,nt(e,"transform","translate3d("+i+"px,"+s+"px,0)"),this.forRepaintDummy=function(e){return e.offsetWidth}(e),nt(e,"transition","transform "+a+"ms"+(this.options.easing?" "+this.options.easing:"")),nt(e,"transform","translate3d(0,0,0)"),"number"==typeof e.animated&&clearTimeout(e.animated),e.animated=setTimeout((function(){nt(e,"transition",""),nt(e,"transform",""),e.animated=!1,e.animatingX=!1,e.animatingY=!1}),a)}}}}var St=[],_t={initializeByDefault:!0},Tt={mount:function(e){for(var t in _t)_t.hasOwnProperty(t)&&!(t in e)&&(e[t]=_t[t]);St.forEach((function(t){if(t.pluginName===e.pluginName)throw"Sortable: Cannot mount plugin ".concat(e.pluginName," more than once")})),St.push(e)},pluginEvent:function(e,t,o){var a=this;this.eventCanceled=!1,o.cancel=function(){a.eventCanceled=!0};var n=e+"Global";St.forEach((function(a){t[a.pluginName]&&(t[a.pluginName][n]&&t[a.pluginName][n]($e({sortable:t},o)),t.options[a.pluginName]&&t[a.pluginName][e]&&t[a.pluginName][e]($e({sortable:t},o)))}))},initializePlugins:function(e,t,o,a){for(var n in St.forEach((function(a){var n=a.pluginName;if(e.options[n]||a.initializeByDefault){var l=new a(e,t,e.options);l.sortable=e,l.options=e.options,e[n]=l,Xe(o,l.defaults)}})),e.options)if(e.options.hasOwnProperty(n)){var l=this.modifyOption(e,n,e.options[n]);void 0!==l&&(e.options[n]=l)}},getEventProperties:function(e,t){var o={};return St.forEach((function(a){"function"==typeof a.eventProperties&&Xe(o,a.eventProperties.call(t[a.pluginName],e))})),o},modifyOption:function(e,t,o){var a;return St.forEach((function(n){e[n.pluginName]&&n.optionListeners&&"function"==typeof n.optionListeners[t]&&(a=n.optionListeners[t].call(e[n.pluginName],o))})),a}};var Dt=["evt"],Et=function(e,t){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=o.evt,n=Ye(o,Dt);Tt.pluginEvent.bind(bo)(e,t,$e({dragEl:Ct,parentEl:Nt,ghostEl:xt,rootEl:Vt,nextEl:kt,lastDownEl:Pt,cloneEl:Ot,cloneHidden:Mt,dragStarted:Wt,putSortable:Yt,activeSortable:bo.active,originalEvent:a,oldIndex:Bt,oldDraggableIndex:jt,newIndex:$t,newDraggableIndex:Rt,hideGhostForTarget:fo,unhideGhostForTarget:go,cloneNowHidden:function(){Mt=!0},cloneNowShown:function(){Mt=!1},dispatchSortableEvent:function(e){At({sortable:t,name:e,originalEvent:a})}},n))};function At(e){!function(e){var t=e.sortable,o=e.rootEl,a=e.name,n=e.targetEl,l=e.cloneEl,r=e.toEl,i=e.fromEl,s=e.oldIndex,d=e.newIndex,c=e.oldDraggableIndex,u=e.newDraggableIndex,p=e.originalEvent,m=e.putSortable,v=e.extraEventProperties;if(t=t||o&&o[wt]){var f,g=t.options,h="on"+a.charAt(0).toUpperCase()+a.substr(1);!window.CustomEvent||Ue||Fe?(f=document.createEvent("Event")).initEvent(a,!0,!0):f=new CustomEvent(a,{bubbles:!0,cancelable:!0}),f.to=r||o,f.from=i||o,f.item=n||o,f.clone=l,f.oldIndex=s,f.newIndex=d,f.oldDraggableIndex=c,f.newDraggableIndex=u,f.originalEvent=p,f.pullMode=m?m.lastPutMode:void 0;var y=$e($e({},v),Tt.getEventProperties(a,t));for(var b in y)f[b]=y[b];o&&o.dispatchEvent(f),g[h]&&g[h].call(t,f)}}($e({putSortable:Yt,cloneEl:Ot,targetEl:Ct,rootEl:Vt,oldIndex:Bt,oldDraggableIndex:jt,newIndex:$t,newDraggableIndex:Rt},e))}var Ct,Nt,xt,Vt,kt,Pt,Ot,Mt,Bt,$t,jt,Rt,Xt,Yt,Lt,Ut,Ft,zt,Ht,qt,Wt,Gt,Kt,Zt,Jt,Qt=!1,eo=!1,to=[],oo=!1,ao=!1,no=[],lo=!1,ro=[],io="undefined"!=typeof document,so=qe,co=Fe||Ue?"cssFloat":"float",uo=io&&!We&&!qe&&"draggable"in document.createElement("div"),po=function(){if(io){if(Ue)return!1;var e=document.createElement("x");return e.style.cssText="pointer-events:auto","auto"===e.style.pointerEvents}}(),mo=function(e,t){var o=nt(e),a=parseInt(o.width)-parseInt(o.paddingLeft)-parseInt(o.paddingRight)-parseInt(o.borderLeftWidth)-parseInt(o.borderRightWidth),n=ct(e,0,t),l=ct(e,1,t),r=n&&nt(n),i=l&&nt(l),s=r&&parseInt(r.marginLeft)+parseInt(r.marginRight)+st(n).width,d=i&&parseInt(i.marginLeft)+parseInt(i.marginRight)+st(l).width;if("flex"===o.display)return"column"===o.flexDirection||"column-reverse"===o.flexDirection?"vertical":"horizontal";if("grid"===o.display)return o.gridTemplateColumns.split(" ").length<=1?"vertical":"horizontal";if(n&&r.float&&"none"!==r.float){var c="left"===r.float?"left":"right";return!l||"both"!==i.clear&&i.clear!==c?"horizontal":"vertical"}return n&&("block"===r.display||"flex"===r.display||"table"===r.display||"grid"===r.display||s>=a&&"none"===o[co]||l&&"none"===o[co]&&s+d>a)?"vertical":"horizontal"},vo=function(e){function t(e,o){return function(a,n,l,r){var i=a.options.group.name&&n.options.group.name&&a.options.group.name===n.options.group.name;if(null==e&&(o||i))return!0;if(null==e||!1===e)return!1;if(o&&"clone"===e)return e;if("function"==typeof e)return t(e(a,n,l,r),o)(a,n,l,r);var s=(o?a:n).options.group.name;return!0===e||"string"==typeof e&&e===s||e.join&&e.indexOf(s)>-1}}var o={},a=e.group;a&&"object"==je(a)||(a={name:a}),o.name=a.name,o.checkPull=t(a.pull,!0),o.checkPut=t(a.put),o.revertClone=a.revertClone,e.group=o},fo=function(){!po&&xt&&nt(xt,"display","none")},go=function(){!po&&xt&&nt(xt,"display","")};io&&!We&&document.addEventListener("click",(function(e){if(eo)return e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),eo=!1,!1}),!0);var ho=function(e){if(Ct){e=e.touches?e.touches[0]:e;var t=(n=e.clientX,l=e.clientY,to.some((function(e){var t=e[wt].options.emptyInsertThreshold;if(t&&!ut(e)){var o=st(e),a=n>=o.left-t&&n<=o.right+t,i=l>=o.top-t&&l<=o.bottom+t;return a&&i?r=e:void 0}})),r);if(t){var o={};for(var a in e)e.hasOwnProperty(a)&&(o[a]=e[a]);o.target=o.rootEl=t,o.preventDefault=void 0,o.stopPropagation=void 0,t[wt]._onDragOver(o)}}var n,l,r},yo=function(e){Ct&&Ct.parentNode[wt]._isOutsideThisEl(e.target)};function bo(e,t){if(!e||!e.nodeType||1!==e.nodeType)throw"Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(e));this.el=e,this.options=t=Xe({},t),e[wt]=this;var o={group:null,sort:!0,disabled:!1,store:null,handle:null,draggable:/^[uo]l$/i.test(e.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return mo(e,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(e,t){e.setData("Text",t.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,delayOnTouchOnly:!1,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:!1!==bo.supportPointer&&"PointerEvent"in window&&(!He||qe),emptyInsertThreshold:5};for(var a in Tt.initializePlugins(this,e,o),o)!(a in t)&&(t[a]=o[a]);for(var n in vo(t),this)"_"===n.charAt(0)&&"function"==typeof this[n]&&(this[n]=this[n].bind(this));this.nativeDraggable=!t.forceFallback&&uo,this.nativeDraggable&&(this.options.touchStartThreshold=1),t.supportPointer?Ke(e,"pointerdown",this._onTapStart):(Ke(e,"mousedown",this._onTapStart),Ke(e,"touchstart",this._onTapStart)),this.nativeDraggable&&(Ke(e,"dragover",this),Ke(e,"dragenter",this)),to.push(this.el),t.store&&t.store.get&&this.sort(t.store.get(this)||[]),Xe(this,It())}function wo(e,t,o,a,n,l,r,i){var s,d,c=e[wt],u=c.options.onMove;return!window.CustomEvent||Ue||Fe?(s=document.createEvent("Event")).initEvent("move",!0,!0):s=new CustomEvent("move",{bubbles:!0,cancelable:!0}),s.to=t,s.from=e,s.dragged=o,s.draggedRect=a,s.related=n||t,s.relatedRect=l||st(t),s.willInsertAfter=i,s.originalEvent=r,e.dispatchEvent(s),u&&(d=u.call(c,s,r)),d}function Io(e){e.draggable=!1}function So(){lo=!1}function _o(e){for(var t=e.tagName+e.className+e.src+e.href+e.textContent,o=t.length,a=0;o--;)a+=t.charCodeAt(o);return a.toString(36)}function To(e){return setTimeout(e,0)}function Do(e){return clearTimeout(e)}bo.prototype={constructor:bo,_isOutsideThisEl:function(e){this.el.contains(e)||e===this.el||(Gt=null)},_getDirection:function(e,t){return"function"==typeof this.options.direction?this.options.direction.call(this,e,t,Ct):this.options.direction},_onTapStart:function(e){if(e.cancelable){var t=this,o=this.el,a=this.options,n=a.preventOnFilter,l=e.type,r=e.touches&&e.touches[0]||e.pointerType&&"touch"===e.pointerType&&e,i=(r||e).target,s=e.target.shadowRoot&&(e.path&&e.path[0]||e.composedPath&&e.composedPath()[0])||i,d=a.filter;if(function(e){ro.length=0;var t=e.getElementsByTagName("input"),o=t.length;for(;o--;){var a=t[o];a.checked&&ro.push(a)}}(o),!Ct&&!(/mousedown|pointerdown/.test(l)&&0!==e.button||a.disabled)&&!s.isContentEditable&&(this.nativeDraggable||!He||!i||"SELECT"!==i.tagName.toUpperCase())&&!((i=et(i,a.draggable,o,!1))&&i.animated||Pt===i)){if(Bt=pt(i),jt=pt(i,a.draggable),"function"==typeof d){if(d.call(this,e,i,this))return At({sortable:t,rootEl:s,name:"filter",targetEl:i,toEl:o,fromEl:o}),Et("filter",t,{evt:e}),void(n&&e.preventDefault())}else if(d&&(d=d.split(",").some((function(a){if(a=et(s,a.trim(),o,!1))return At({sortable:t,rootEl:a,name:"filter",targetEl:i,fromEl:o,toEl:o}),Et("filter",t,{evt:e}),!0}))))return void(n&&e.preventDefault());a.handle&&!et(s,a.handle,o,!1)||this._prepareDragStart(e,r,i)}}},_prepareDragStart:function(e,t,o){var a,n=this,l=n.el,r=n.options,i=l.ownerDocument;if(o&&!Ct&&o.parentNode===l){var s=st(o);if(Vt=l,Nt=(Ct=o).parentNode,kt=Ct.nextSibling,Pt=o,Xt=r.group,bo.dragged=Ct,Lt={target:Ct,clientX:(t||e).clientX,clientY:(t||e).clientY},Ht=Lt.clientX-s.left,qt=Lt.clientY-s.top,this._lastX=(t||e).clientX,this._lastY=(t||e).clientY,Ct.style["will-change"]="all",a=function(){Et("delayEnded",n,{evt:e}),bo.eventCanceled?n._onDrop():(n._disableDelayedDragEvents(),!ze&&n.nativeDraggable&&(Ct.draggable=!0),n._triggerDragStart(e,t),At({sortable:n,name:"choose",originalEvent:e}),at(Ct,r.chosenClass,!0))},r.ignore.split(",").forEach((function(e){rt(Ct,e.trim(),Io)})),Ke(i,"dragover",ho),Ke(i,"mousemove",ho),Ke(i,"touchmove",ho),r.supportPointer?(Ke(i,"pointerup",n._onDrop),!this.nativeDraggable&&Ke(i,"pointercancel",n._onDrop)):(Ke(i,"mouseup",n._onDrop),Ke(i,"touchend",n._onDrop),Ke(i,"touchcancel",n._onDrop)),ze&&this.nativeDraggable&&(this.options.touchStartThreshold=4,Ct.draggable=!0),Et("delayStart",this,{evt:e}),!r.delay||r.delayOnTouchOnly&&!t||this.nativeDraggable&&(Fe||Ue))a();else{if(bo.eventCanceled)return void this._onDrop();r.supportPointer?(Ke(i,"pointerup",n._disableDelayedDrag),Ke(i,"pointercancel",n._disableDelayedDrag)):(Ke(i,"mouseup",n._disableDelayedDrag),Ke(i,"touchend",n._disableDelayedDrag),Ke(i,"touchcancel",n._disableDelayedDrag)),Ke(i,"mousemove",n._delayedDragTouchMoveHandler),Ke(i,"touchmove",n._delayedDragTouchMoveHandler),r.supportPointer&&Ke(i,"pointermove",n._delayedDragTouchMoveHandler),n._dragStartTimer=setTimeout(a,r.delay)}}},_delayedDragTouchMoveHandler:function(e){var t=e.touches?e.touches[0]:e;Math.max(Math.abs(t.clientX-this._lastX),Math.abs(t.clientY-this._lastY))>=Math.floor(this.options.touchStartThreshold/(this.nativeDraggable&&window.devicePixelRatio||1))&&this._disableDelayedDrag()},_disableDelayedDrag:function(){Ct&&Io(Ct),clearTimeout(this._dragStartTimer),this._disableDelayedDragEvents()},_disableDelayedDragEvents:function(){var e=this.el.ownerDocument;Ze(e,"mouseup",this._disableDelayedDrag),Ze(e,"touchend",this._disableDelayedDrag),Ze(e,"touchcancel",this._disableDelayedDrag),Ze(e,"pointerup",this._disableDelayedDrag),Ze(e,"pointercancel",this._disableDelayedDrag),Ze(e,"mousemove",this._delayedDragTouchMoveHandler),Ze(e,"touchmove",this._delayedDragTouchMoveHandler),Ze(e,"pointermove",this._delayedDragTouchMoveHandler)},_triggerDragStart:function(e,t){t=t||"touch"==e.pointerType&&e,!this.nativeDraggable||t?this.options.supportPointer?Ke(document,"pointermove",this._onTouchMove):Ke(document,t?"touchmove":"mousemove",this._onTouchMove):(Ke(Ct,"dragend",this),Ke(Vt,"dragstart",this._onDragStart));try{document.selection?To((function(){document.selection.empty()})):window.getSelection().removeAllRanges()}catch(o){}},_dragStarted:function(e,t){if(Qt=!1,Vt&&Ct){Et("dragStarted",this,{evt:t}),this.nativeDraggable&&Ke(document,"dragover",yo);var o=this.options;!e&&at(Ct,o.dragClass,!1),at(Ct,o.ghostClass,!0),bo.active=this,e&&this._appendGhost(),At({sortable:this,name:"start",originalEvent:t})}else this._nulling()},_emulateDragOver:function(){if(Ut){this._lastX=Ut.clientX,this._lastY=Ut.clientY,fo();for(var e=document.elementFromPoint(Ut.clientX,Ut.clientY),t=e;e&&e.shadowRoot&&(e=e.shadowRoot.elementFromPoint(Ut.clientX,Ut.clientY))!==t;)t=e;if(Ct.parentNode[wt]._isOutsideThisEl(e),t)do{if(t[wt]){if(t[wt]._onDragOver({clientX:Ut.clientX,clientY:Ut.clientY,target:e,rootEl:t})&&!this.options.dragoverBubble)break}e=t}while(t=Qe(t));go()}},_onTouchMove:function(e){if(Lt){var t=this.options,o=t.fallbackTolerance,a=t.fallbackOffset,n=e.touches?e.touches[0]:e,l=xt&&lt(xt,!0),r=xt&&l&&l.a,i=xt&&l&&l.d,s=so&&Jt&&mt(Jt),d=(n.clientX-Lt.clientX+a.x)/(r||1)+(s?s[0]-no[0]:0)/(r||1),c=(n.clientY-Lt.clientY+a.y)/(i||1)+(s?s[1]-no[1]:0)/(i||1);if(!bo.active&&!Qt){if(o&&Math.max(Math.abs(n.clientX-this._lastX),Math.abs(n.clientY-this._lastY))<o)return;this._onDragStart(e,!0)}if(xt){l?(l.e+=d-(Ft||0),l.f+=c-(zt||0)):l={a:1,b:0,c:0,d:1,e:d,f:c};var u="matrix(".concat(l.a,",").concat(l.b,",").concat(l.c,",").concat(l.d,",").concat(l.e,",").concat(l.f,")");nt(xt,"webkitTransform",u),nt(xt,"mozTransform",u),nt(xt,"msTransform",u),nt(xt,"transform",u),Ft=d,zt=c,Ut=n}e.cancelable&&e.preventDefault()}},_appendGhost:function(){if(!xt){var e=this.options.fallbackOnBody?document.body:Vt,t=st(Ct,!0,so,!0,e),o=this.options;if(so){for(Jt=e;"static"===nt(Jt,"position")&&"none"===nt(Jt,"transform")&&Jt!==document;)Jt=Jt.parentNode;Jt!==document.body&&Jt!==document.documentElement?(Jt===document&&(Jt=it()),t.top+=Jt.scrollTop,t.left+=Jt.scrollLeft):Jt=it(),no=mt(Jt)}at(xt=Ct.cloneNode(!0),o.ghostClass,!1),at(xt,o.fallbackClass,!0),at(xt,o.dragClass,!0),nt(xt,"transition",""),nt(xt,"transform",""),nt(xt,"box-sizing","border-box"),nt(xt,"margin",0),nt(xt,"top",t.top),nt(xt,"left",t.left),nt(xt,"width",t.width),nt(xt,"height",t.height),nt(xt,"opacity","0.8"),nt(xt,"position",so?"absolute":"fixed"),nt(xt,"zIndex","100000"),nt(xt,"pointerEvents","none"),bo.ghost=xt,e.appendChild(xt),nt(xt,"transform-origin",Ht/parseInt(xt.style.width)*100+"% "+qt/parseInt(xt.style.height)*100+"%")}},_onDragStart:function(e,t){var o=this,a=e.dataTransfer,n=o.options;Et("dragStart",this,{evt:e}),bo.eventCanceled?this._onDrop():(Et("setupClone",this),bo.eventCanceled||((Ot=yt(Ct)).removeAttribute("id"),Ot.draggable=!1,Ot.style["will-change"]="",this._hideClone(),at(Ot,this.options.chosenClass,!1),bo.clone=Ot),o.cloneId=To((function(){Et("clone",o),bo.eventCanceled||(o.options.removeCloneOnHide||Vt.insertBefore(Ot,Ct),o._hideClone(),At({sortable:o,name:"clone"}))})),!t&&at(Ct,n.dragClass,!0),t?(eo=!0,o._loopId=setInterval(o._emulateDragOver,50)):(Ze(document,"mouseup",o._onDrop),Ze(document,"touchend",o._onDrop),Ze(document,"touchcancel",o._onDrop),a&&(a.effectAllowed="move",n.setData&&n.setData.call(o,a,Ct)),Ke(document,"drop",o),nt(Ct,"transform","translateZ(0)")),Qt=!0,o._dragStartId=To(o._dragStarted.bind(o,t,e)),Ke(document,"selectstart",o),Wt=!0,window.getSelection().removeAllRanges(),He&&nt(document.body,"user-select","none"))},_onDragOver:function(e){var t,o,a,n,l=this.el,r=e.target,i=this.options,s=i.group,d=bo.active,c=Xt===s,u=i.sort,p=Yt||d,m=this,v=!1;if(!lo){if(void 0!==e.preventDefault&&e.cancelable&&e.preventDefault(),r=et(r,i.draggable,l,!0),N("dragOver"),bo.eventCanceled)return v;if(Ct.contains(e.target)||r.animated&&r.animatingX&&r.animatingY||m._ignoreWhileAnimating===r)return V(!1);if(eo=!1,d&&!i.disabled&&(c?u||(a=Nt!==Vt):Yt===this||(this.lastPutMode=Xt.checkPull(this,d,Ct,e))&&s.checkPut(this,d,Ct,e))){if(n="vertical"===this._getDirection(e,r),t=st(Ct),N("dragOverValid"),bo.eventCanceled)return v;if(a)return Nt=Vt,x(),this._hideClone(),N("revert"),bo.eventCanceled||(kt?Vt.insertBefore(Ct,kt):Vt.appendChild(Ct)),V(!0);var f=ut(l,i.draggable);if(!f||function(e,t,o){var a=st(ut(o.el,o.options.draggable)),n=bt(o.el,o.options,xt),l=10;return t?e.clientX>n.right+l||e.clientY>a.bottom&&e.clientX>a.left:e.clientY>n.bottom+l||e.clientX>a.right&&e.clientY>a.top}(e,n,this)&&!f.animated){if(f===Ct)return V(!1);if(f&&l===e.target&&(r=f),r&&(o=st(r)),!1!==wo(Vt,l,Ct,t,r,o,e,!!r))return x(),f&&f.nextSibling?l.insertBefore(Ct,f.nextSibling):l.appendChild(Ct),Nt=l,k(),V(!0)}else if(f&&function(e,t,o){var a=st(ct(o.el,0,o.options,!0)),n=bt(o.el,o.options,xt),l=10;return t?e.clientX<n.left-l||e.clientY<a.top&&e.clientX<a.right:e.clientY<n.top-l||e.clientY<a.bottom&&e.clientX<a.left}(e,n,this)){var g=ct(l,0,i,!0);if(g===Ct)return V(!1);if(o=st(r=g),!1!==wo(Vt,l,Ct,t,r,o,e,!1))return x(),l.insertBefore(Ct,g),Nt=l,k(),V(!0)}else if(r.parentNode===l){o=st(r);var h,y,b,w=Ct.parentNode!==l,I=!function(e,t,o){var a=o?e.left:e.top,n=o?e.right:e.bottom,l=o?e.width:e.height,r=o?t.left:t.top,i=o?t.right:t.bottom,s=o?t.width:t.height;return a===r||n===i||a+l/2===r+s/2}(Ct.animated&&Ct.toRect||t,r.animated&&r.toRect||o,n),S=n?"top":"left",_=dt(r,"top","top")||dt(Ct,"top","top"),T=_?_.scrollTop:void 0;if(Gt!==r&&(y=o[S],oo=!1,ao=!I&&i.invertSwap||w),h=function(e,t,o,a,n,l,r,i){var s=a?e.clientY:e.clientX,d=a?o.height:o.width,c=a?o.top:o.left,u=a?o.bottom:o.right,p=!1;if(!r)if(i&&Zt<d*n){if(!oo&&(1===Kt?s>c+d*l/2:s<u-d*l/2)&&(oo=!0),oo)p=!0;else if(1===Kt?s<c+Zt:s>u-Zt)return-Kt}else if(s>c+d*(1-n)/2&&s<u-d*(1-n)/2)return function(e){return pt(Ct)<pt(e)?1:-1}(t);if((p=p||r)&&(s<c+d*l/2||s>u-d*l/2))return s>c+d/2?1:-1;return 0}(e,r,o,n,I?1:i.swapThreshold,null==i.invertedSwapThreshold?i.swapThreshold:i.invertedSwapThreshold,ao,Gt===r),0!==h){var D=pt(Ct);do{D-=h,b=Nt.children[D]}while(b&&("none"===nt(b,"display")||b===xt))}if(0===h||b===r)return V(!1);Gt=r,Kt=h;var E=r.nextElementSibling,A=!1,C=wo(Vt,l,Ct,t,r,o,e,A=1===h);if(!1!==C)return 1!==C&&-1!==C||(A=1===C),lo=!0,setTimeout(So,30),x(),A&&!E?l.appendChild(Ct):r.parentNode.insertBefore(Ct,A?E:r),_&&ht(_,0,T-_.scrollTop),Nt=Ct.parentNode,void 0===y||ao||(Zt=Math.abs(y-st(r)[S])),k(),V(!0)}if(l.contains(Ct))return V(!1)}return!1}function N(i,s){Et(i,m,$e({evt:e,isOwner:c,axis:n?"vertical":"horizontal",revert:a,dragRect:t,targetRect:o,canSort:u,fromSortable:p,target:r,completed:V,onMove:function(o,a){return wo(Vt,l,Ct,t,o,st(o),e,a)},changed:k},s))}function x(){N("dragOverAnimationCapture"),m.captureAnimationState(),m!==p&&p.captureAnimationState()}function V(t){return N("dragOverCompleted",{insertion:t}),t&&(c?d._hideClone():d._showClone(m),m!==p&&(at(Ct,Yt?Yt.options.ghostClass:d.options.ghostClass,!1),at(Ct,i.ghostClass,!0)),Yt!==m&&m!==bo.active?Yt=m:m===bo.active&&Yt&&(Yt=null),p===m&&(m._ignoreWhileAnimating=r),m.animateAll((function(){N("dragOverAnimationComplete"),m._ignoreWhileAnimating=null})),m!==p&&(p.animateAll(),p._ignoreWhileAnimating=null)),(r===Ct&&!Ct.animated||r===l&&!r.animated)&&(Gt=null),i.dragoverBubble||e.rootEl||r===document||(Ct.parentNode[wt]._isOutsideThisEl(e.target),!t&&ho(e)),!i.dragoverBubble&&e.stopPropagation&&e.stopPropagation(),v=!0}function k(){$t=pt(Ct),Rt=pt(Ct,i.draggable),At({sortable:m,name:"change",toEl:l,newIndex:$t,newDraggableIndex:Rt,originalEvent:e})}},_ignoreWhileAnimating:null,_offMoveEvents:function(){Ze(document,"mousemove",this._onTouchMove),Ze(document,"touchmove",this._onTouchMove),Ze(document,"pointermove",this._onTouchMove),Ze(document,"dragover",ho),Ze(document,"mousemove",ho),Ze(document,"touchmove",ho)},_offUpEvents:function(){var e=this.el.ownerDocument;Ze(e,"mouseup",this._onDrop),Ze(e,"touchend",this._onDrop),Ze(e,"pointerup",this._onDrop),Ze(e,"pointercancel",this._onDrop),Ze(e,"touchcancel",this._onDrop),Ze(document,"selectstart",this)},_onDrop:function(e){var t=this.el,o=this.options;$t=pt(Ct),Rt=pt(Ct,o.draggable),Et("drop",this,{evt:e}),Nt=Ct&&Ct.parentNode,$t=pt(Ct),Rt=pt(Ct,o.draggable),bo.eventCanceled||(Qt=!1,ao=!1,oo=!1,clearInterval(this._loopId),clearTimeout(this._dragStartTimer),Do(this.cloneId),Do(this._dragStartId),this.nativeDraggable&&(Ze(document,"drop",this),Ze(t,"dragstart",this._onDragStart)),this._offMoveEvents(),this._offUpEvents(),He&&nt(document.body,"user-select",""),nt(Ct,"transform",""),e&&(Wt&&(e.cancelable&&e.preventDefault(),!o.dropBubble&&e.stopPropagation()),xt&&xt.parentNode&&xt.parentNode.removeChild(xt),(Vt===Nt||Yt&&"clone"!==Yt.lastPutMode)&&Ot&&Ot.parentNode&&Ot.parentNode.removeChild(Ot),Ct&&(this.nativeDraggable&&Ze(Ct,"dragend",this),Io(Ct),Ct.style["will-change"]="",Wt&&!Qt&&at(Ct,Yt?Yt.options.ghostClass:this.options.ghostClass,!1),at(Ct,this.options.chosenClass,!1),At({sortable:this,name:"unchoose",toEl:Nt,newIndex:null,newDraggableIndex:null,originalEvent:e}),Vt!==Nt?($t>=0&&(At({rootEl:Nt,name:"add",toEl:Nt,fromEl:Vt,originalEvent:e}),At({sortable:this,name:"remove",toEl:Nt,originalEvent:e}),At({rootEl:Nt,name:"sort",toEl:Nt,fromEl:Vt,originalEvent:e}),At({sortable:this,name:"sort",toEl:Nt,originalEvent:e})),Yt&&Yt.save()):$t!==Bt&&$t>=0&&(At({sortable:this,name:"update",toEl:Nt,originalEvent:e}),At({sortable:this,name:"sort",toEl:Nt,originalEvent:e})),bo.active&&(null!=$t&&-1!==$t||($t=Bt,Rt=jt),At({sortable:this,name:"end",toEl:Nt,originalEvent:e}),this.save())))),this._nulling()},_nulling:function(){Et("nulling",this),Vt=Ct=Nt=xt=kt=Ot=Pt=Mt=Lt=Ut=Wt=$t=Rt=Bt=jt=Gt=Kt=Yt=Xt=bo.dragged=bo.ghost=bo.clone=bo.active=null,ro.forEach((function(e){e.checked=!0})),ro.length=Ft=zt=0},handleEvent:function(e){switch(e.type){case"drop":case"dragend":this._onDrop(e);break;case"dragenter":case"dragover":Ct&&(this._onDragOver(e),function(e){e.dataTransfer&&(e.dataTransfer.dropEffect="move");e.cancelable&&e.preventDefault()}(e));break;case"selectstart":e.preventDefault()}},toArray:function(){for(var e,t=[],o=this.el.children,a=0,n=o.length,l=this.options;a<n;a++)et(e=o[a],l.draggable,this.el,!1)&&t.push(e.getAttribute(l.dataIdAttr)||_o(e));return t},sort:function(e,t){var o={},a=this.el;this.toArray().forEach((function(e,t){var n=a.children[t];et(n,this.options.draggable,a,!1)&&(o[e]=n)}),this),t&&this.captureAnimationState(),e.forEach((function(e){o[e]&&(a.removeChild(o[e]),a.appendChild(o[e]))})),t&&this.animateAll()},save:function(){var e=this.options.store;e&&e.set&&e.set(this)},closest:function(e,t){return et(e,t||this.options.draggable,this.el,!1)},option:function(e,t){var o=this.options;if(void 0===t)return o[e];var a=Tt.modifyOption(this,e,t);o[e]=void 0!==a?a:t,"group"===e&&vo(o)},destroy:function(){Et("destroy",this);var e=this.el;e[wt]=null,Ze(e,"mousedown",this._onTapStart),Ze(e,"touchstart",this._onTapStart),Ze(e,"pointerdown",this._onTapStart),this.nativeDraggable&&(Ze(e,"dragover",this),Ze(e,"dragenter",this)),Array.prototype.forEach.call(e.querySelectorAll("[draggable]"),(function(e){e.removeAttribute("draggable")})),this._onDrop(),this._disableDelayedDragEvents(),to.splice(to.indexOf(this.el),1),this.el=e=null},_hideClone:function(){if(!Mt){if(Et("hideClone",this),bo.eventCanceled)return;nt(Ot,"display","none"),this.options.removeCloneOnHide&&Ot.parentNode&&Ot.parentNode.removeChild(Ot),Mt=!0}},_showClone:function(e){if("clone"===e.lastPutMode){if(Mt){if(Et("showClone",this),bo.eventCanceled)return;Ct.parentNode!=Vt||this.options.group.revertClone?kt?Vt.insertBefore(Ot,kt):Vt.appendChild(Ot):Vt.insertBefore(Ot,Ct),this.options.group.revertClone&&this.animate(Ct,Ot),nt(Ot,"display",""),Mt=!1}}else this._hideClone()}},io&&Ke(document,"touchmove",(function(e){(bo.active||Qt)&&e.cancelable&&e.preventDefault()})),bo.utils={on:Ke,off:Ze,css:nt,find:rt,is:function(e,t){return!!et(e,t,e,!1)},extend:function(e,t){if(e&&t)for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);return e},throttle:gt,closest:et,toggleClass:at,clone:yt,index:pt,nextTick:To,cancelNextTick:Do,detectDirection:mo,getChild:ct,expando:wt},bo.get=function(e){return e[wt]},bo.mount=function(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];t[0].constructor===Array&&(t=t[0]),t.forEach((function(e){if(!e.prototype||!e.prototype.constructor)throw"Sortable: Mounted plugin must be a constructor function, not ".concat({}.toString.call(e));e.utils&&(bo.utils=$e($e({},bo.utils),e.utils)),Tt.mount(e)}))},bo.create=function(e,t){return new bo(e,t)},bo.version="1.15.6";var Eo,Ao,Co,No,xo,Vo,ko=[],Po=!1;function Oo(){ko.forEach((function(e){clearInterval(e.pid)})),ko=[]}function Mo(){clearInterval(Vo)}var Bo=gt((function(e,t,o,a){if(t.scroll){var n,l=(e.touches?e.touches[0]:e).clientX,r=(e.touches?e.touches[0]:e).clientY,i=t.scrollSensitivity,s=t.scrollSpeed,d=it(),c=!1;Ao!==o&&(Ao=o,Oo(),Eo=t.scroll,n=t.scrollFn,!0===Eo&&(Eo=vt(o,!0)));var u=0,p=Eo;do{var m=p,v=st(m),f=v.top,g=v.bottom,h=v.left,y=v.right,b=v.width,w=v.height,I=void 0,S=void 0,_=m.scrollWidth,T=m.scrollHeight,D=nt(m),E=m.scrollLeft,A=m.scrollTop;m===d?(I=b<_&&("auto"===D.overflowX||"scroll"===D.overflowX||"visible"===D.overflowX),S=w<T&&("auto"===D.overflowY||"scroll"===D.overflowY||"visible"===D.overflowY)):(I=b<_&&("auto"===D.overflowX||"scroll"===D.overflowX),S=w<T&&("auto"===D.overflowY||"scroll"===D.overflowY));var C=I&&(Math.abs(y-l)<=i&&E+b<_)-(Math.abs(h-l)<=i&&!!E),N=S&&(Math.abs(g-r)<=i&&A+w<T)-(Math.abs(f-r)<=i&&!!A);if(!ko[u])for(var x=0;x<=u;x++)ko[x]||(ko[x]={});ko[u].vx==C&&ko[u].vy==N&&ko[u].el===m||(ko[u].el=m,ko[u].vx=C,ko[u].vy=N,clearInterval(ko[u].pid),0==C&&0==N||(c=!0,ko[u].pid=setInterval(function(){a&&0===this.layer&&bo.active._onTouchMove(xo);var t=ko[this.layer].vy?ko[this.layer].vy*s:0,o=ko[this.layer].vx?ko[this.layer].vx*s:0;"function"==typeof n&&"continue"!==n.call(bo.dragged.parentNode[wt],o,t,e,xo,ko[this.layer].el)||ht(ko[this.layer].el,o,t)}.bind({layer:u}),24))),u++}while(t.bubbleScroll&&p!==d&&(p=vt(p,!1)));Po=c}}),30),$o=function(e){var t=e.originalEvent,o=e.putSortable,a=e.dragEl,n=e.activeSortable,l=e.dispatchSortableEvent,r=e.hideGhostForTarget,i=e.unhideGhostForTarget;if(t){var s=o||n;r();var d=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:t,c=document.elementFromPoint(d.clientX,d.clientY);i(),s&&!s.el.contains(c)&&(l("spill"),this.onSpill({dragEl:a,putSortable:o}))}};function jo(){}function Ro(){}jo.prototype={startIndex:null,dragStart:function(e){var t=e.oldDraggableIndex;this.startIndex=t},onSpill:function(e){var t=e.dragEl,o=e.putSortable;this.sortable.captureAnimationState(),o&&o.captureAnimationState();var a=ct(this.sortable.el,this.startIndex,this.options);a?this.sortable.el.insertBefore(t,a):this.sortable.el.appendChild(t),this.sortable.animateAll(),o&&o.animateAll()},drop:$o},Xe(jo,{pluginName:"revertOnSpill"}),Ro.prototype={onSpill:function(e){var t=e.dragEl,o=e.putSortable||this.sortable;o.captureAnimationState(),t.parentNode&&t.parentNode.removeChild(t),o.animateAll()},drop:$o},Xe(Ro,{pluginName:"removeOnSpill"}),bo.mount(new function(){function e(){for(var e in this.defaults={scroll:!0,forceAutoScrollFallback:!1,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:!0},this)"_"===e.charAt(0)&&"function"==typeof this[e]&&(this[e]=this[e].bind(this))}return e.prototype={dragStarted:function(e){var t=e.originalEvent;this.sortable.nativeDraggable?Ke(document,"dragover",this._handleAutoScroll):this.options.supportPointer?Ke(document,"pointermove",this._handleFallbackAutoScroll):t.touches?Ke(document,"touchmove",this._handleFallbackAutoScroll):Ke(document,"mousemove",this._handleFallbackAutoScroll)},dragOverCompleted:function(e){var t=e.originalEvent;this.options.dragOverBubble||t.rootEl||this._handleAutoScroll(t)},drop:function(){this.sortable.nativeDraggable?Ze(document,"dragover",this._handleAutoScroll):(Ze(document,"pointermove",this._handleFallbackAutoScroll),Ze(document,"touchmove",this._handleFallbackAutoScroll),Ze(document,"mousemove",this._handleFallbackAutoScroll)),Mo(),Oo(),clearTimeout(tt),tt=void 0},nulling:function(){xo=Ao=Eo=Po=Vo=Co=No=null,ko.length=0},_handleFallbackAutoScroll:function(e){this._handleAutoScroll(e,!0)},_handleAutoScroll:function(e,t){var o=this,a=(e.touches?e.touches[0]:e).clientX,n=(e.touches?e.touches[0]:e).clientY,l=document.elementFromPoint(a,n);if(xo=e,t||this.options.forceAutoScrollFallback||Fe||Ue||He){Bo(e,this.options,l,t);var r=vt(l,!0);!Po||Vo&&a===Co&&n===No||(Vo&&Mo(),Vo=setInterval((function(){var l=vt(document.elementFromPoint(a,n),!0);l!==r&&(r=l,Oo()),Bo(e,o.options,l,t)}),10),Co=a,No=n)}else{if(!this.options.bubbleScroll||vt(l,!0)===it())return void Oo();Bo(e,this.options,vt(l,!1),!1)}}},Xe(e,{pluginName:"scroll",initializeByDefault:!0})}),bo.mount(Ro,jo);const Xo={class:"permission-module-editor"},Yo={class:"p-4 bg-gray-100 rounded-md"},Lo={class:"mt-4"},Uo={class:"module-panel"},Fo={class:"panel-header"},zo={class:"module-list custom-scrollbar"},Ho=["data-id","onClick"],qo={class:"module-type-badge"},Wo={class:"module-actions"},Go={class:"node-panel"},Ko={class:"panel-header"},Zo={key:0,class:"text-muted"},Jo={key:0,class:"node-content"},Qo={key:0},ea={key:1},ta=de(Y({__name:"PermissionModuleEditor",props:{templateId:{type:[Number,String],default:null},templateVersionId:{type:[Number,String],default:null}},setup(e){const t=e,o=L(!1),n=L([]),l=L(null),r=L([]),i=L("");L("");const c=L(""),u=L(""),p=L(!1),m=L(null);L(!1);const v=L(!1),g=L(!1),b=L(null),I=L(!1),S=L(!1),_=L(null),D=L([]),Y=L([]),le=L(!1),de=async()=>{const e=t.templateVersionId?String(t.templateVersionId):null;if(!e)return void console.log("fetchModules: 版本ID不存在或无效，无法加载模块列表");const a=e;console.log("获取模块列表 - 版本ID:",a,"类型:",typeof a,"长度:",a.length),o.value=!0;try{const e=await Ie(a);if(console.log("获取模块列表响应:",e),i.value=a,e){const t=e;let o=[];Array.isArray(t)?o=t:t.data&&Array.isArray(t.data)?o=t.data:t.data&&"object"==typeof t.data&&(t.data.records&&Array.isArray(t.data.records)?o=t.data.records:Array.isArray(t.data)&&(o=t.data)),n.value=o.map((e=>(e.id&&"string"!=typeof e.id&&(e.id=e.id.toString()),e.templateVersionId&&"string"!=typeof e.templateVersionId&&(e.templateVersionId=e.templateVersionId.toString()),e))),console.log("解析后的模块列表数据:",n.value),console.log("模块列表长度:",n.value.length),n.value.length>0&&!l.value&&(console.log("默认选中第一个模块:",n.value[0]),l.value=n.value[0],n.value[0].id&&me(n.value[0]))}else n.value=[],console.log("没有获取到模块数据")}catch(r){console.error("加载模块列表失败:",r),h.error("加载模块列表失败")}finally{o.value=!1}};Q([()=>t.templateId,()=>t.templateVersionId],(()=>{t.templateVersionId?de():(n.value=[],l.value=null,r.value=[])}),{immediate:!0});const ue=J((()=>{const e=[...n.value].sort(((e,t)=>(e.sort||0)-(t.sort||0)));return c.value?e.filter((e=>e.moduleName.toLowerCase().includes(c.value.toLowerCase()))):e})),pe=J((()=>{if(!r.value.length)return[];const e=[...r.value].sort(((e,t)=>(e.nodeSort||0)-(t.nodeSort||0)));return u.value?e.filter((e=>e.nodeName&&e.nodeName.toLowerCase().includes(u.value.toLowerCase()))):e})),me=async e=>{if(console.log("选择模块:",e),l.value=e,r.value=[],u.value="",p.value=!1,e.id)try{le.value=!0;const t=String(e.id);console.log("加载模块节点 - 模块ID:",t);const o=await function(e){const t=String(e);return console.log(`调用getNodesByModule - 原始ID: ${t}, 类型: ${typeof t}, 长度: ${t.length}`),ce({url:`/perm/api/perm/nodes/module/${t}`,method:"get",headers:{"X-Preserve-IDs":"true"}}).then((e=>(console.log(`getNodesByModule响应数据详情: ${JSON.stringify(e)}`),e))).catch((e=>{throw console.error(`getNodesByModule请求出错: ${e}`),e}))}(t);console.log("节点API响应原始数据:",o);let a=[];const n=o;null==n?(console.log("API返回了null或undefined"),a=[]):Array.isArray(n)?(console.log("返回值是数组"),a=n):"object"==typeof n&&(200===n.code&&Array.isArray(n.data)?(console.log("标准响应格式: code=200 + data数组"),a=n.data):200===n.code&&n.data&&"object"==typeof n.data?Array.isArray(n.data.list)?(console.log("标准响应格式: code=200 + data.list数组"),a=n.data.list):Array.isArray(n.data.records)?(console.log("标准响应格式: code=200 + data.records数组"),a=n.data.records):n.data.nodeList&&Array.isArray(n.data.nodeList)&&(console.log("标准响应格式: code=200 + data.nodeList数组"),a=n.data.nodeList):Array.isArray(n.list)?(console.log("响应直接包含list数组"),a=n.list):Array.isArray(n.records)?(console.log("响应直接包含records数组"),a=n.records):n.data&&!Array.isArray(n.data)&&"object"==typeof n.data?(console.log("单个对象，包装为数组"),a=[n.data]):n.nodes&&Array.isArray(n.nodes)?(console.log("响应包含nodes数组字段"),a=n.nodes):n.nodeList&&Array.isArray(n.nodeList)?(console.log("响应包含nodeList数组字段"),a=n.nodeList):(console.log("使用响应本身作为数据"),a=[n])),console.log(`原始解析出的节点列表(${a.length}个):`,a);const l=a.filter((e=>!(!e||"object"!=typeof e)||(console.warn("过滤掉非对象节点"),!1))).map(((e,o)=>{var a,n,l,r;const i={id:(null==(a=e.id)?void 0:a.toString())||`temp-${o}`,nodeName:e.nodeName||"未命名节点",moduleId:(null==(n=e.moduleId)?void 0:n.toString())||t,nodeType:void 0!==e.nodeType?e.nodeType:1,nodeTypeName:e.nodeTypeName||ye(e.nodeType||1),permType:void 0!==e.permType?e.permType:0,permTypeName:e.permTypeName||(1===e.permType?"数据权限":"操作权限"),permId:(null==(l=e.permId)?void 0:l.toString())||void 0,dataPolicyId:(null==(r=e.dataPolicyId)?void 0:r.toString())||void 0,isBasic:void 0!==e.isBasic?e.isBasic:0,dataScope:e.dataScope,permDetail:e.permDetail,nodeSort:e.nodeSort||e.sort||10*(o+1)};return console.log(`节点 ${o+1} 规范化:`,i),i}));console.log(`有效节点数量: ${l.length}`),r.value=l,l.length>0?h.success(`已加载 ${l.length} 个节点`):h.info("该模块暂无节点数据"),se((()=>ve()))}catch(t){console.error("加载节点列表失败:",t),h.error("加载节点列表失败: "+(t instanceof Error?t.message:String(t))),r.value=[]}finally{le.value=!1}},ve=()=>{m.value&&m.value.$el&&setTimeout((()=>{const e=m.value.$el.querySelector(".el-table__body-wrapper tbody");e?(console.log("初始化节点拖拽排序..."),bo.create(e,{handle:".drag-handle",animation:150,onEnd:e=>{const{newIndex:t,oldIndex:o}=e;if(void 0===t||void 0===o)return;const a=r.value.splice(o,1)[0];r.value.splice(t,0,a),r.value.forEach(((e,t)=>{e.nodeSort=10*(t+1)})),p.value=!0}})):console.warn("未找到表格tbody元素，无法初始化排序功能")}),100)},fe=()=>{t.templateVersionId?(g.value=!1,b.value={templateVersionId:t.templateVersionId.toString(),moduleType:1,moduleName:"",sort:10*n.value.length+10},v.value=!0):h.warning("请先选择一个模板版本")},ge=async e=>{var t;if(e)try{await y.confirm("确定要删除此模块？此操作将同时删除模块下的所有节点，且不可恢复。","确认删除",{type:"warning"});const o=e.toString();await(t=o,ce({url:`/perm/api/perm/modules/${t}`,method:"delete"})),h.success("删除模块成功"),n.value=n.value.filter((t=>t.id!==e)),l.value&&l.value.id===e&&(l.value=null,r.value=[],n.value.length>0&&me(n.value[0]))}catch(o){"cancel"!==o&&(console.error("删除模块失败:",o),h.error("删除模块失败"))}},he=async e=>{try{let o;if(g.value&&e.id){const{templateVersionId:a,...n}=e;await(t=n,ce({url:"/perm/api/perm/modules",method:"put",data:t})),h.success("更新模块成功"),o=e.id}else{const t=await function(e){return ce({url:"/perm/api/perm/modules",method:"post",data:e})}(e);if(console.log("创建模块响应:",t),t){const e=t;e.data&&e.data.id?o=e.data.id:e.id&&(o=e.id),h.success("创建模块成功")}}console.log("正在重新加载模块列表..."),v.value=!1,i.value="",await de(),console.log("模块列表重新加载完成，模块数量:",n.value.length),o&&(console.log("查找新创建的模块，ID:",o),se((()=>{const e=n.value.find((e=>String(e.id)===String(o)));if(e){console.log("找到新创建的模块，准备选中:",e),me(e);try{const e=document.querySelector(`.module-item[data-id="${o}"]`);e&&e.scrollIntoView({behavior:"smooth",block:"center"})}catch(t){console.warn("无法滚动到新创建的模块:",t)}}else console.warn("未找到新创建的模块，ID:",o),console.log("当前所有模块:",n.value.map((e=>({id:e.id,name:e.moduleName}))))})))}catch(o){console.error("保存模块失败:",o),h.error("保存模块失败: "+(o instanceof Error?o.message:String(o)))}var t},ye=e=>{switch(e){case 1:return"菜单项";case 2:return"操作按钮";case 3:return"数据字段";default:return"-"}},be=async()=>{l.value&&l.value.id?(S.value=!1,_.value={moduleId:String(l.value.id),nodeName:"",nodeType:1,permType:0,nodeSort:10*r.value.length+10},I.value=!0):h.warning("请先选择一个模块")},we=async e=>{var t;if(e)try{await y.confirm("确定要删除此节点吗？","确认删除",{type:"warning"});const o=e.toString();await(t=o,ce({url:`/perm/api/perm/nodes/${t}`,method:"delete"})),h.success("删除节点成功"),l.value&&l.value.id&&await me(l.value)}catch(o){"cancel"!==o&&(console.error("删除节点失败:",o),h.error("删除节点失败"))}},_e=async e=>{try{if(console.log("节点表单提交数据:",e),S.value&&e.id){const{nodeSort:t,...o}=e;console.log("发送更新节点请求，数据:",o),await Se(o),h.success("更新节点成功")}else console.log("发送创建节点请求，数据:",e),await(t=e,ce({url:"/perm/api/perm/nodes",method:"post",data:t})),h.success("创建节点成功");l.value&&l.value.id&&await me(l.value),I.value=!1}catch(o){console.error("保存节点失败:",o),h.error("保存节点失败: "+(o instanceof Error?o.message:String(o)))}var t},Te=e=>{if(!e)return"-";const t=String(e),o=D.value.find((e=>String(e.id)===t));return o?o.permsName:t},De=e=>{if(!e)return"-";const t=String(e),o=Y.value.find((e=>String(e.id)===t));return o?o.policyName:t},Ee=async()=>{if(l.value)try{for(const t of r.value)if(t.id)try{const e={id:t.id,nodeName:t.nodeName,nodeType:t.nodeType,permType:t.permType,isBasic:"number"==typeof t.isBasic?t.isBasic:t.isBasic?1:0};0===t.permType&&t.permId?e.permId=t.permId:1===t.permType&&t.dataPolicyId&&(e.dataPolicyId=t.dataPolicyId),3===t.nodeType&&t.dataScope&&(e.dataScope=t.dataScope),console.log(`更新节点 ${t.nodeName} 排序，请求数据:`,e),await Se(e)}catch(e){console.error(`更新节点 ${t.nodeName} 失败:`,e)}h.success("节点排序已保存"),p.value=!1}catch(t){console.error("保存节点排序失败:",t),h.error("保存节点排序失败")}},Ae=async(e,t)=>{switch(e){case"edit":await(async e=>{S.value=!0;const t={...e};t.id&&"string"!=typeof t.id&&(t.id=String(t.id)),t.moduleId&&"string"!=typeof t.moduleId&&(t.moduleId=String(t.moduleId)),t.permId&&"string"!=typeof t.permId&&(t.permId=String(t.permId)),t.dataPolicyId&&"string"!=typeof t.dataPolicyId&&(t.dataPolicyId=String(t.dataPolicyId)),_.value=t,I.value=!0})(t);break;case"delete":await we(t.id?t.id.toString():void 0)}};return U((()=>{t.templateVersionId&&de()})),(t,r)=>{var i;const h=w;return W(),F("div",Xo,[oe("p",Yo," 模块与节点编辑器 (模板ID: "+te(e.templateId)+", 版本ID: "+te(e.templateVersionId)+") ",1),oe("div",Lo,[z(q(X),{gutter:20},{default:H((()=>[z(q(E),{xs:24,sm:24,md:8,class:"config-col"},{default:H((()=>[oe("div",Uo,[oe("div",Fo,[r[6]||(r[6]=oe("h4",null,"模块列表",-1)),z(q(a),{type:"primary",link:"",icon:q(s),onClick:fe},{default:H((()=>r[5]||(r[5]=[ee("新增模块")]))),_:1},8,["icon"])]),z(q(f),{placeholder:"搜索模块...",modelValue:c.value,"onUpdate:modelValue":r[0]||(r[0]=e=>c.value=e),clearable:"",class:"search-input"},null,8,["modelValue"]),ae((W(),F("div",zo,[(W(!0),F(G,null,K(ue.value,(e=>{var t;return W(),F("div",{key:e.id,class:ie(["module-item",{"is-active":(null==(t=l.value)?void 0:t.id)===e.id}]),"data-id":e.id,onClick:t=>me(e)},[z(q(A),null,{default:H((()=>[z(q(C))])),_:1}),oe("span",null,te(e.moduleName),1),oe("span",qo,te(1===e.moduleType?"功能":"数据"),1),oe("span",Wo,[z(q(a),{link:"",icon:q(N),size:"small",onClick:re((t=>{return o=e,g.value=!0,b.value={...o},void(v.value=!0);var o}),["stop"])},null,8,["icon","onClick"]),z(q(x),{title:"确定删除此模块？",onConfirm:t=>ge(e.id)},{reference:H((()=>[z(q(a),{link:"",icon:q(d),size:"small",onClick:r[1]||(r[1]=re((()=>{}),["stop"]))},null,8,["icon"])])),_:2},1032,["onConfirm"])])],10,Ho)})),128)),o.value||0!==ue.value.length?ne("",!0):(W(),Z(q(V),{key:0,description:"暂无模块","image-size":60}))])),[[h,o.value]])])])),_:1}),z(q(E),{xs:24,sm:24,md:16,class:"config-col"},{default:H((()=>[oe("div",Go,[oe("div",Ko,[oe("h4",null,[r[7]||(r[7]=ee(" 节点列表 ")),l.value?(W(),F("span",Zo,"("+te(l.value.moduleName)+")",1)):ne("",!0),l.value?(W(),Z(q(T),{key:1,type:"info",size:"small",class:"ml-2"},{default:H((()=>[ee("排序: "+te(l.value.sort??0),1)])),_:1})):ne("",!0)]),oe("div",null,[z(q(a),{type:"primary",plain:"",size:"small",class:"mr-2",onClick:Ee,disabled:!l.value||!p.value},{default:H((()=>r[8]||(r[8]=[ee(" 保存节点排序 ")]))),_:1},8,["disabled"]),z(q(a),{type:"primary",link:"",icon:q(s),onClick:be,disabled:!l.value},{default:H((()=>r[9]||(r[9]=[ee(" 新增节点 ")]))),_:1},8,["icon","disabled"])])]),l.value?(W(),F("div",Jo,[z(q(f),{placeholder:"搜索节点...",modelValue:u.value,"onUpdate:modelValue":r[2]||(r[2]=e=>u.value=e),clearable:"",class:"search-input"},null,8,["modelValue"]),z(q(k),{title:'节点可拖拽排序。修改排序后请点击上方的"保存节点排序"按钮。',type:"info","show-icon":"",closable:!1,class:"mx-[15px] mb-[10px]"}),ae((W(),Z(q(R),{data:pe.value,style:{width:"100%"},size:"small",border:"",class:"node-list-table node-list-table-fixed-layout","row-key":"id",ref_key:"nodeTableRef",ref:m,height:400,"empty-text":"暂无节点数据"},{default:H((()=>[z(q(P),{label:"排序",width:"60",align:"center"},{default:H((()=>[z(q(A),{class:"drag-handle cursor-grab"},{default:H((()=>[z(q(O))])),_:1})])),_:1}),z(q(P),{prop:"nodeName",label:"节点名称","min-width":"150"}),z(q(P),{label:"节点类型",width:"90"},{default:H((({row:e})=>[ee(te(ye(e.nodeType)||e.nodeTypeName||"-"),1)])),_:1}),z(q(P),{label:"权限类型",width:"100"},{default:H((({row:e})=>[ee(te(e.permTypeName||(0===e.permType?"操作权限":"数据权限")||"-"),1)])),_:1}),z(q(P),{label:"绑定权限/策略","min-width":"180"},{default:H((({row:e})=>[0===e.permType?(W(),F("span",Qo,te(Te(e.permId)||e.permDetail&&e.permDetail.permsName||"-"),1)):(W(),F("span",ea,te(De(e.dataPolicyId)||e.dataPolicyDetail&&e.dataPolicyDetail.policyName||"-"),1))])),_:1}),z(q(P),{label:"操作",width:"80",align:"center",fixed:"right"},{default:H((({row:e})=>[z(q(M),{trigger:"click",onCommand:t=>Ae(t,e)},{dropdown:H((()=>[z(q(B),null,{default:H((()=>[z(q($),{command:"edit"},{default:H((()=>r[10]||(r[10]=[ee("编辑")]))),_:1}),z(q($),{command:"delete",divided:""},{default:H((()=>r[11]||(r[11]=[ee("删除")]))),_:1})])),_:1})])),default:H((()=>[z(q(a),{text:"",type:"primary",icon:q(j)},null,8,["icon"])])),_:2},1032,["onCommand"])])),_:1})])),_:1},8,["data"])),[[h,le.value]])])):(W(),Z(q(V),{key:1,description:"请先选择一个模块","image-size":100,class:"node-list-empty"}))])])),_:1})])),_:1})]),z(Ce,{visible:v.value,"onUpdate:visible":r[3]||(r[3]=e=>v.value=e),"is-editing":g.value,"initial-data":b.value,"existing-modules":n.value,onSubmit:he},null,8,["visible","is-editing","initial-data","existing-modules"]),z(Me,{visible:I.value,"onUpdate:visible":r[4]||(r[4]=e=>I.value=e),"is-editing":S.value,"initial-data":_.value,"selected-module-name":(null==(i=l.value)?void 0:i.moduleName)||"","all-operation-permissions":D.value,"all-data-policies":Y.value,onSubmit:_e},null,8,["visible","is-editing","initial-data","selected-module-name","all-operation-permissions","all-data-policies"])])}}}),[["__scopeId","data-v-14cc8859"]]),oa={class:"system-template-permission-container p-4"},aa={key:0,class:"mt-6"},na={class:"text-lg font-semibold mb-3"},la=de(Y({__name:"SystemTemplatePermission",setup(t){const o=L("enterprise"),a=L(null),n=L(""),l=L(null),r=L(null),i=L({}),s=async e=>{if(console.log("模板类型选择:",e),a.value=e,n.value="",l.value=null,r.value=null,e&&e.apiType)try{console.log("获取模板详情, 类型:",e.apiType);const t=await ye(e.apiType);console.log("获取模板详情响应:",t),t&&t.data?(r.value=t.data.id,console.log("设置模板ID:",r.value),await d()):t&&"object"==typeof t&&"id"in t?(r.value=t.id,console.log("设置模板ID (直接从响应):",r.value),await d()):console.warn("未获取到模板详情")}catch(t){console.error("获取模板详情失败:",t),fe(t,"获取模板详情失败")}},d=async()=>{if(r.value)try{console.log("获取默认版本，模板ID:",r.value);const e=await we(r.value);console.log("默认版本响应:",e);let t=null,o=null;if(e&&e.data){const a=e.data;t=a.id?a.id.toString():null,o=a.version,console.log("获取到默认版本:",a)}console.log("获取版本列表，模板ID:",r.value);const a=await be({templateId:r.value,pageNum:1,pageSize:20});if(console.log("版本列表响应:",a),!t&&a){const e=a;let n=[];if(e&&e.data&&e.data.records?n=e.data.records:e&&e.records?n=e.records:e&&Array.isArray(e)?n=e:e&&Array.isArray(e.data)&&(n=e.data),n.length>0){const e=n.find((e=>1===e.isDefault));e?(console.log("从列表中找到默认版本:",e),t=e.id?e.id.toString():null,o=e.version):(console.log("未找到默认版本，使用第一个版本:",n[0]),t=n[0].id?n[0].id.toString():null,o=n[0].version)}}t&&o?(l.value=t,n.value=o,console.log("自动选择版本:",o,t),await c(t)):console.warn("未获取到任何版本数据")}catch(e){console.error("获取版本数据失败:",e),fe(e,"获取版本数据失败")}else console.warn("未获取到模板ID，无法加载版本列表")},c=async e=>{if(!e)return void console.warn("无效的版本ID，无法加载模块列表");const t=String(e);if(console.log("loadModulesByVersion - 版本ID信息:",{originalId:e,idType:typeof e,stringId:t,length:t.length,hasCached:Boolean(i.value[t])}),i.value[t])console.log(`使用缓存中的模块数据 - 版本ID: ${t}, 模块数量: ${i.value[t].length}`);else try{i.value[t]=[];const e=await Ie(t);if(console.log("模块列表加载响应:",e),e){let o=[];Array.isArray(e)?o=e:e.data&&Array.isArray(e.data)?o=e.data:e.data&&e.data.records&&Array.isArray(e.data.records)&&(o=e.data.records),o=o.map((e=>(e.id&&"string"!=typeof e.id&&(e.id=String(e.id)),e.templateVersionId&&"string"!=typeof e.templateVersionId&&(e.templateVersionId=String(e.templateVersionId)),e))),o.length>0?(i.value[t]=o,console.log(`成功加载模块 - 版本ID: ${t}, 模块数量: ${o.length}`)):console.log(`该版本无模块 - 版本ID: ${t}`)}}catch(o){console.error("加载模块列表失败:",o),fe(o,"加载模块列表失败"),delete i.value[t]}},u=async e=>{if(console.log("版本变更:",e),n.value=e||"",e&&a.value&&a.value.apiType)try{console.log("查询版本ID - 参数:",{templateId:r.value,pageNum:1,pageSize:100});const t=await be({templateId:r.value||0,pageNum:1,pageSize:100});console.log("查询版本响应:",t);let o=null;if(t){const a=t;let n=[];Array.isArray(a)?n=a:a.data&&Array.isArray(a.data)?n=a.data:a.data&&a.data.records&&Array.isArray(a.data.records)?n=a.data.records:a.records&&Array.isArray(a.records)&&(n=a.records),o=n.find((t=>t.version===e))}if(o){const e=o.id.toString();console.log("获取到版本信息:",{id:o.id,idType:typeof o.id,stringId:e,idLength:e.length}),l.value=e,console.log("设置版本ID为:",e),await c(e)}else console.warn("未找到匹配的版本信息:",e),l.value=null}catch(t){console.error("获取版本详情失败:",t),fe(t,"获取版本详情失败")}else l.value=null,console.log("清空版本ID")},p=e=>{a.value&&(a.value={...a.value,...e})};return Q((()=>a.value),(e=>{console.log("模板信息变化:",null==e?void 0:e.type)}),{immediate:!0}),U((()=>{})),(t,i)=>(W(),F("div",oa,[z(e,{title:"系统模板权限配置",subtitle:"配置平台、企业、代理所的默认权限模板"}),z(he,{"active-template-type":o.value,"onUpdate:activeTemplateType":i[0]||(i[0]=e=>o.value=e),onTypeSelected:s},null,8,["active-template-type"]),a.value?(W(),Z(q(v),{key:0,class:"mt-4"},{default:H((()=>[z(Ae,{"template-info":a.value,"current-version":n.value,"onUpdate:currentVersion":i[1]||(i[1]=e=>n.value=e),onVersionChanged:u,onSaveBaseInfo:p},null,8,["template-info","current-version"]),a.value&&n.value?(W(),F("div",aa,[oe("h3",na," 配置模板: "+te(a.value.name)+" (版本: "+te(n.value)+") ",1),(W(),Z(ta,{"template-id":r.value,"template-version-id":l.value,key:`${r.value||0}-${l.value||0}`},null,8,["template-id","template-version-id"]))])):a.value&&!n.value?(W(),Z(q(V),{key:1,description:"请选择或创建一个版本进行配置"})):ne("",!0)])),_:1})):(W(),Z(q(V),{key:1,description:"请先选择一个系统模板类型开始配置"}))]))}}),[["__scopeId","data-v-dd5a15c4"]]);export{la as default};
